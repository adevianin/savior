/*! For license information please see game.js.LICENSE.txt */
(()=>{"use strict";var __webpack_modules__={402:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}function trimLeft(e){return e.replace(/^\s+/,"")}function trimRight(e){return e.replace(/\s+$/,"")}function isNumeric(e){return"string"==typeof e&&(e=e.trim()),!isNaN(e)&&/[+-]?([0-9]*[.])?[0-9]+/.test(e)}function isBoolean(e){var t=e.trim();return"true"===t||"false"===t}function toHex$1(e){for(var t="",i=0;i<e.length;)t+=e.charCodeAt(i++).toString(16);return t}__webpack_require__.d(__webpack_exports__,{Il:()=>Color,W2:()=>Container,JH:()=>Entity,mg:()=>Polygon,MJ:()=>Renderable,jy:()=>Sprite,Hf:()=>Stage,EY:()=>Vector2d,n0:()=>audio,v7:()=>collision,Uh:()=>device$1,B:()=>event,H6:()=>game,qH:()=>input,fu:()=>level,_m:()=>loader,d_:()=>pool,SB:()=>state,HT:()=>timer$1,Rk:()=>video}),"undefined"!=typeof window&&void 0===window.console&&(window.console={},window.console.log=function(){},window.console.assert=function(){},window.console.warn=function(){},window.console.error=function(){alert(Array.prototype.slice.call(arguments).join(", "))});var stringUtils=Object.freeze({__proto__:null,capitalize,trimLeft,trimRight,isNumeric,isBoolean,toHex:toHex$1}),vendors$1=["ms","MS","moz","webkit","o"];function prefixed(e,t){if(e in(t=t||window))return t[e];var i,s=capitalize(e);return vendors$1.some((function(e){var r=e+s;return i=r in t?t[r]:void 0})),i}function setPrefixed(e,t,i){if(e in(i=i||window))i[e]=t;else{var s=capitalize(e);vendors$1.some((function(e){var r=e+s;return r in i&&(i[r]=t,!0)}))}}var agentUtils=Object.freeze({__proto__:null,prefixed,setPrefixed});const DEG_TO_RAD=Math.PI/180,RAD_TO_DEG=180/Math.PI,TAU=2*Math.PI,ETA=.5*Math.PI,EPSILON=1e-6;function isPowerOfTwo(e){return 0==(e&e-1)}function nextPowerOfTwo(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function degToRad(e){return e*DEG_TO_RAD}function radToDeg(e){return e*RAD_TO_DEG}function clamp(e,t,i){return e<t?t:e>i?i:+e}function random$1(e,t){return~~(Math.random()*(t-e))+e}function randomFloat(e,t){return Math.random()*(t-e)+e}function weightedRandom$1(e,t){return~~(Math.pow(Math.random(),2)*(t-e))+e}function round(e,t=0){var i=Math.pow(10,t);return~~(.5+e*i)/i}function toBeCloseTo(e,t,i=2){return Math.abs(e-t)<Math.pow(10,-i)/2}var math=Object.freeze({__proto__:null,DEG_TO_RAD,RAD_TO_DEG,TAU,ETA,EPSILON,isPowerOfTwo,nextPowerOfTwo,degToRad,radToDeg,clamp,random:random$1,randomFloat,weightedRandom:weightedRandom$1,round,toBeCloseTo});function remove(e,t){var i=Array.prototype.indexOf.call(e,t);return-1!==i&&Array.prototype.splice.call(e,i,1),e}function random(e){return e[random$1(0,e.length)]}function weightedRandom(e){return e[weightedRandom$1(0,e.length)]}var arrayUtils=Object.freeze({__proto__:null,remove,random,weightedRandom});const REMOVE_PATH=/^.*(\\|\/|\:)/,REMOVE_EXT=/\.[^\.]*$/;function getBasename(e){return e.replace(REMOVE_PATH,"").replace(REMOVE_EXT,"")}function getExtension(e){return e.substring(e.lastIndexOf(".")+1,e.length)}var fileUtils=Object.freeze({__proto__:null,getBasename,getExtension});function defer(e,t,...i){return setTimeout(e.bind(t),.01,...i)}function throttle(e,t,i){var s,r=window.performance.now();return"boolean"!=typeof i&&(i=!1),function(){var n=window.performance.now(),o=n-r,a=arguments;if(!(o<t))return r=n,e.apply(null,a);!1===i&&(clearTimeout(s),s=setTimeout((function(){return r=n,e.apply(null,a)}),o))}}var fnUtils=Object.freeze({__proto__:null,defer,throttle}),objectClass={},instance_counter=0,pool={register(e,t,i=!1){if(void 0===t)throw new Error("Cannot register object '"+e+"', invalid class");objectClass[e]={class:t,pool:i?[]:void 0}},pull(e){for(var t=new Array(arguments.length),i=0;i<arguments.length;i++)t[i]=arguments[i];var s=objectClass[e];if(s){var r,n=s.class,o=s.pool;return o&&(r=o.pop())?(t.shift(),"function"==typeof r.onResetEvent&&r.onResetEvent.apply(r,t),instance_counter--):(t[0]=n,r=new(n.bind.apply(n,t)),o&&(r.className=e)),r}throw new Error("Cannot instantiate object of type '"+e+"'")},purge(){for(var e in objectClass)objectClass[e]&&(objectClass[e].pool=[]);instance_counter=0},push(e,t=!0){if(!this.poolable(e)){if(!0===t)throw new Error("me.pool: object "+e+" cannot be recycled");return!1}return objectClass[e.className].pool.push(e),instance_counter++,!0},exists:e=>e in objectClass,poolable(e){var t=e.className;return void 0!==t&&"function"==typeof e.onResetEvent&&t in objectClass&&"undefined"!==objectClass[t].pool},getInstanceCount:()=>instance_counter};class Vector2d{constructor(...e){this.onResetEvent(...e)}onResetEvent(e=0,t=0){return this.x=e,this.y=t,this}_set(e,t){return this.x=e,this.y=t,this}set(e,t){if(e!==+e||t!==+t)throw new Error("invalid x,y parameters (not a number)");return this._set(e,t)}setZero(){return this.set(0,0)}setV(e){return this._set(e.x,e.y)}add(e){return this._set(this.x+e.x,this.y+e.y)}sub(e){return this._set(this.x-e.x,this.y-e.y)}scale(e,t){return this._set(this.x*e,this.y*(void 0!==t?t:e))}toIso(){return this._set(this.x-this.y,.5*(this.x+this.y))}to2d(){return this._set(this.y+this.x/2,this.y-this.x/2)}scaleV(e){return this._set(this.x*e.x,this.y*e.y)}div(e){return this._set(this.x/e,this.y/e)}abs(){return this._set(this.x<0?-this.x:this.x,this.y<0?-this.y:this.y)}clamp(e,t){return new Vector2d(clamp(this.x,e,t),clamp(this.y,e,t))}clampSelf(e,t){return this._set(clamp(this.x,e,t),clamp(this.y,e,t))}minV(e){return this._set(this.x<e.x?this.x:e.x,this.y<e.y?this.y:e.y)}maxV(e){return this._set(this.x>e.x?this.x:e.x,this.y>e.y?this.y:e.y)}floor(){return new Vector2d(Math.floor(this.x),Math.floor(this.y))}floorSelf(){return this._set(Math.floor(this.x),Math.floor(this.y))}ceil(){return new Vector2d(Math.ceil(this.x),Math.ceil(this.y))}ceilSelf(){return this._set(Math.ceil(this.x),Math.ceil(this.y))}negate(){return new Vector2d(-this.x,-this.y)}negateSelf(){return this._set(-this.x,-this.y)}copy(e){return this._set(e.x,e.y)}equals(){var e,t;return 2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),this.x===e&&this.y===t}normalize(){return this.div(this.length()||1)}perp(){return this._set(this.y,-this.x)}rotate(e,t){var i=0,s=0;"object"==typeof t&&(i=t.x,s=t.y);var r=this.x-i,n=this.y-s,o=Math.cos(e),a=Math.sin(e);return this._set(r*o-n*a+i,r*a+n*o+s)}dotProduct(e){return this.x*e.x+this.y*e.y}length2(){return this.dotProduct(this)}length(){return Math.sqrt(this.length2())}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}distance(e){var t=this.x-e.x,i=this.y-e.y;return Math.sqrt(t*t+i*i)}angle(e){return Math.acos(clamp(this.dotProduct(e)/(this.length()*e.length()),-1,1))}project(e){return this.scale(this.dotProduct(e)/e.length2())}projectN(e){return this.scale(this.dotProduct(e))}clone(){return pool.pull("Vector2d",this.x,this.y)}toString(){return"x:"+this.x+",y:"+this.y}}var toHex=function(e){return"0123456789ABCDEF".charAt(e-e%16>>4)+"0123456789ABCDEF".charAt(e%16)},rgbaRx=/^rgba?\((\d+), ?(\d+), ?(\d+)(, ?([\d\.]+))?\)$/,hex3Rx=/^#([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,hex4Rx=/^#([\da-fA-F])([\da-fA-F])([\da-fA-F])([\da-fA-F])$/,hex6Rx=/^#([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})$/,hex8Rx=/^#([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})([\da-fA-F]{2})$/,cssToRGB=new Map;[["black",[0,0,0]],["silver",[192,192,129]],["gray",[128,128,128]],["white",[255,255,255]],["maroon",[128,0,0]],["red",[255,0,0]],["purple",[128,0,128]],["fuchsia",[255,0,255]],["green",[0,128,0]],["lime",[0,255,0]],["olive",[128,128,0]],["yellow",[255,255,0]],["navy",[0,0,128]],["blue",[0,0,255]],["teal",[0,128,128]],["aqua",[0,255,255]],["orange",[255,165,0]],["aliceblue",[240,248,245]],["antiquewhite",[250,235,215]],["aquamarine",[127,255,212]],["azure",[240,255,255]],["beige",[245,245,220]],["bisque",[255,228,196]],["blanchedalmond",[255,235,205]],["blueviolet",[138,43,226]],["brown",[165,42,42]],["burlywood",[222,184,35]],["cadetblue",[95,158,160]],["chartreuse",[127,255,0]],["chocolate",[210,105,30]],["coral",[255,127,80]],["cornflowerblue",[100,149,237]],["cornsilk",[255,248,220]],["crimson",[220,20,60]],["darkblue",[0,0,139]],["darkcyan",[0,139,139]],["darkgoldenrod",[184,134,11]],["darkgray[*]",[169,169,169]],["darkgreen",[0,100,0]],["darkgrey[*]",[169,169,169]],["darkkhaki",[189,183,107]],["darkmagenta",[139,0,139]],["darkolivegreen",[85,107,47]],["darkorange",[255,140,0]],["darkorchid",[153,50,204]],["darkred",[139,0,0]],["darksalmon",[233,150,122]],["darkseagreen",[143,188,143]],["darkslateblue",[72,61,139]],["darkslategray",[47,79,79]],["darkslategrey",[47,79,79]],["darkturquoise",[0,206,209]],["darkviolet",[148,0,211]],["deeppink",[255,20,147]],["deepskyblue",[0,191,255]],["dimgray",[105,105,105]],["dimgrey",[105,105,105]],["dodgerblue",[30,144,255]],["firebrick",[178,34,34]],["floralwhite",[255,250,240]],["forestgreen",[34,139,34]],["gainsboro",[220,220,220]],["ghostwhite",[248,248,255]],["gold",[255,215,0]],["goldenrod",[218,165,32]],["greenyellow",[173,255,47]],["grey",[128,128,128]],["honeydew",[240,255,240]],["hotpink",[255,105,180]],["indianred",[205,92,92]],["indigo",[75,0,130]],["ivory",[255,255,240]],["khaki",[240,230,140]],["lavender",[230,230,250]],["lavenderblush",[255,240,245]],["lawngreen",[124,252,0]],["lemonchiffon",[255,250,205]],["lightblue",[173,216,230]],["lightcoral",[240,128,128]],["lightcyan",[224,255,255]],["lightgoldenrodyellow",[250,250,210]],["lightgray",[211,211,211]],["lightgreen",[144,238,144]],["lightgrey",[211,211,211]],["lightpink",[255,182,193]],["lightsalmon",[255,160,122]],["lightseagreen",[32,178,170]],["lightskyblue",[135,206,250]],["lightslategray",[119,136,153]],["lightslategrey",[119,136,153]],["lightsteelblue",[176,196,222]],["lightyellow",[255,255,224]],["limegreen",[50,205,50]],["linen",[250,240,230]],["mediumaquamarine",[102,205,170]],["mediumblue",[0,0,205]],["mediumorchid",[186,85,211]],["mediumpurple",[147,112,219]],["mediumseagreen",[60,179,113]],["mediumslateblue",[123,104,238]],["mediumspringgreen",[0,250,154]],["mediumturquoise",[72,209,204]],["mediumvioletred",[199,21,133]],["midnightblue",[25,25,112]],["mintcream",[245,255,250]],["mistyrose",[255,228,225]],["moccasin",[255,228,181]],["navajowhite",[255,222,173]],["oldlace",[253,245,230]],["olivedrab",[107,142,35]],["orangered",[255,69,0]],["orchid",[218,112,214]],["palegoldenrod",[238,232,170]],["palegreen",[152,251,152]],["paleturquoise",[175,238,238]],["palevioletred",[219,112,147]],["papayawhip",[255,239,213]],["peachpuff",[255,218,185]],["peru",[205,133,63]],["pink",[255,192,203]],["plum",[221,160,221]],["powderblue",[176,224,230]],["rosybrown",[188,143,143]],["royalblue",[65,105,225]],["saddlebrown",[139,69,19]],["salmon",[250,128,114]],["sandybrown",[244,164,96]],["seagreen",[46,139,87]],["seashell",[255,245,238]],["sienna",[160,82,45]],["skyblue",[135,206,235]],["slateblue",[106,90,205]],["slategray",[112,128,144]],["slategrey",[112,128,144]],["snow",[255,250,250]],["springgreen",[0,255,127]],["steelblue",[70,130,180]],["tan",[210,180,140]],["thistle",[216,191,216]],["tomato",[255,99,71]],["turquoise",[64,224,208]],["violet",[238,130,238]],["wheat",[245,222,179]],["whitesmoke",[245,245,245]],["yellowgreen",[154,205,50]]].forEach((function(e){cssToRGB.set(e[0],e[1])}));class Color{constructor(...e){this.onResetEvent(...e)}onResetEvent(e=0,t=0,i=0,s=1){return void 0===this.glArray&&(this.glArray=new Float32Array([0,0,0,1])),this.setColor(e,t,i,s)}get r(){return~~(255*this.glArray[0])}set r(e){this.glArray[0]=clamp(~~e||0,0,255)/255}get g(){return~~(255*this.glArray[1])}set g(e){this.glArray[1]=clamp(~~e||0,0,255)/255}get b(){return~~(255*this.glArray[2])}set b(e){this.glArray[2]=clamp(~~e||0,0,255)/255}get alpha(){return this.glArray[3]}set alpha(e){this.glArray[3]=void 0===e?1:clamp(+e,0,1)}setColor(e,t,i,s=1){return e instanceof Color?(this.glArray.set(e.glArray),e):(this.r=e,this.g=t,this.b=i,this.alpha=s,this)}clone(){return pool.pull("Color",this)}copy(e){return e instanceof Color?(this.glArray.set(e.glArray),this):this.parseCSS(e)}add(e){return this.glArray[0]=clamp(this.glArray[0]+e.glArray[0],0,1),this.glArray[1]=clamp(this.glArray[1]+e.glArray[1],0,1),this.glArray[2]=clamp(this.glArray[2]+e.glArray[2],0,1),this.glArray[3]=(this.glArray[3]+e.glArray[3])/2,this}darken(e){return e=clamp(e,0,1),this.glArray[0]*=e,this.glArray[1]*=e,this.glArray[2]*=e,this}lerp(e,t){return t=clamp(t,0,1),this.glArray[0]+=(e.glArray[0]-this.glArray[0])*t,this.glArray[1]+=(e.glArray[1]-this.glArray[1])*t,this.glArray[2]+=(e.glArray[2]-this.glArray[2])*t,this}lighten(e){return e=clamp(e,0,1),this.glArray[0]=clamp(this.glArray[0]+(1-this.glArray[0])*e,0,1),this.glArray[1]=clamp(this.glArray[1]+(1-this.glArray[1])*e,0,1),this.glArray[2]=clamp(this.glArray[2]+(1-this.glArray[2])*e,0,1),this}random(e=0,t=255){return e<0&&(e=0),t>255&&(t=255),this.setColor(random$1(e,t),random$1(e,t),random$1(e,t),this.alpha)}equals(e){return this.glArray[0]===e.glArray[0]&&this.glArray[1]===e.glArray[1]&&this.glArray[2]===e.glArray[2]&&this.glArray[3]===e.glArray[3]}parseCSS(e){return cssToRGB.has(e)?this.setColor.apply(this,cssToRGB.get(e)):this.parseRGB(e)}parseRGB(e){var t=rgbaRx.exec(e);return t?this.setColor(+t[1],+t[2],+t[3],+t[5]):this.parseHex(e)}parseHex(e,t=!1){var i;if(i=hex8Rx.exec(e))return this.setColor(parseInt(i[!1===t?1:2],16),parseInt(i[!1===t?2:3],16),parseInt(i[!1===t?3:4],16),(clamp(parseInt(i[!1===t?4:1],16),0,255)/255).toFixed(1));if(i=hex6Rx.exec(e))return this.setColor(parseInt(i[1],16),parseInt(i[2],16),parseInt(i[3],16));if(i=hex4Rx.exec(e)){var s=i[!1===t?1:2],r=i[!1===t?2:3],n=i[!1===t?3:4],o=i[!1===t?4:1];return this.setColor(parseInt(s+s,16),parseInt(r+r,16),parseInt(n+n,16),(clamp(parseInt(o+o,16),0,255)/255).toFixed(1))}if(i=hex3Rx.exec(e))return this.setColor(parseInt(i[1]+i[1],16),parseInt(i[2]+i[2],16),parseInt(i[3]+i[3],16));throw new Error("invalid parameter: "+e)}toUint32(e=this.alpha){return((255*e&255)<<24)+((255&this.r)<<16)+((255&this.g)<<8)+(255&this.b)}toArray(){return this.glArray}toHex(){return"#"+toHex(this.r)+toHex(this.g)+toHex(this.b)}toHex8(){return"#"+toHex(this.r)+toHex(this.g)+toHex(this.b)+toHex(255*this.alpha)}toRGB(){return"rgb("+this.r+","+this.g+","+this.b+")"}toRGBA(){return"rgba("+this.r+","+this.g+","+this.b+","+this.alpha+")"}}class Matrix3d{constructor(...e){this.onResetEvent(...e)}onResetEvent(){void 0===this.val&&(this.val=new Float32Array(16)),arguments.length&&arguments[0]instanceof Matrix3d?this.copy(arguments[0]):16===arguments.length?this.setTransform.apply(this,arguments):this.identity()}get tx(){return this.val[12]}get ty(){return this.val[13]}get tz(){return this.val[14]}identity(){return this.setTransform(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}setTransform(e,t,i,s,r,n,o,a,h,l,d,u,c,p,g,f){var m=this.val;return m[0]=e,m[1]=t,m[2]=i,m[3]=s,m[4]=r,m[5]=n,m[6]=o,m[7]=a,m[8]=h,m[9]=l,m[10]=d,m[11]=u,m[12]=c,m[13]=p,m[14]=g,m[15]=f,this}copy(e){return this.val.set(e.val),this}fromMat2d(e){var t=e.val;return this.setTransform(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1)}multiply(e){var t=this.val,i=e.val,s=t[0],r=t[1],n=t[2],o=t[3],a=t[4],h=t[5],l=t[6],d=t[7],u=t[8],c=t[9],p=t[10],g=t[11],f=t[12],m=t[13],v=t[14],_=t[15],y=i[0],x=i[1],w=i[2],T=i[3];return t[0]=y*s+x*a+w*u+T*f,t[1]=y*r+x*h+w*c+T*m,t[2]=y*n+x*l+w*p+T*v,t[3]=y*o+x*d+w*g+T*_,y=i[4],x=i[5],w=i[6],T=i[7],t[4]=y*s+x*a+w*u+T*f,t[5]=y*r+x*h+w*c+T*m,t[6]=y*n+x*l+w*p+T*v,t[7]=y*o+x*d+w*g+T*_,y=i[8],x=i[9],w=i[10],T=i[11],t[8]=y*s+x*a+w*u+T*f,t[9]=y*r+x*h+w*c+T*m,t[10]=y*n+x*l+w*p+T*v,t[11]=y*o+x*d+w*g+T*_,y=i[12],x=i[13],w=i[14],T=i[15],t[12]=y*s+x*a+w*u+T*f,t[13]=y*r+x*h+w*c+T*m,t[14]=y*n+x*l+w*p+T*v,t[15]=y*o+x*d+w*g+T*_,this}transpose(){var e=this.val,t=e[1],i=e[2],s=e[3],r=e[6],n=e[7],o=e[11];return e[1]=e[4],e[2]=e[8],e[3]=e[12],e[4]=t,e[6]=e[9],e[7]=e[13],e[8]=i,e[9]=r,e[11]=e[14],e[12]=s,e[13]=n,e[14]=o,this}invert(){var e=this.val,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],o=e[5],a=e[6],h=e[7],l=e[8],d=e[9],u=e[10],c=e[11],p=e[12],g=e[13],f=e[14],m=e[15],v=t*o-i*n,_=t*a-s*n,y=t*h-r*n,x=i*a-s*o,w=i*h-r*o,T=s*h-r*a,b=l*g-d*p,E=l*f-u*p,A=l*m-c*p,S=d*f-u*g,C=d*m-c*g,R=u*m-c*f,P=v*R-_*C+y*S+x*A-w*E+T*b;return P?(P=1/P,e[0]=(o*R-a*C+h*S)*P,e[1]=(s*C-i*R-r*S)*P,e[2]=(g*T-f*w+m*x)*P,e[3]=(u*w-d*T-c*x)*P,e[4]=(a*A-n*R-h*E)*P,e[5]=(t*R-s*A+r*E)*P,e[6]=(f*y-p*T-m*_)*P,e[7]=(l*T-u*y+c*_)*P,e[8]=(n*C-o*A+h*b)*P,e[9]=(i*A-t*C-r*b)*P,e[10]=(p*w-g*y+m*v)*P,e[11]=(d*y-l*w-c*v)*P,e[12]=(o*E-n*S-a*b)*P,e[13]=(t*S-i*E+s*b)*P,e[14]=(g*_-p*x-f*v)*P,e[15]=(l*x-d*_+u*v)*P,this):null}apply(e){var t=this.val,i=e.x,s=e.y,r=void 0!==e.z?e.z:1,n=t[3]*i+t[7]*s+t[11]*r+t[15]||1;return e.x=(t[0]*i+t[4]*s+t[8]*r+t[12])/n,e.y=(t[1]*i+t[5]*s+t[9]*r+t[13])/n,void 0!==e.z&&(e.z=(t[2]*i+t[6]*s+t[10]*r+t[14])/n),e}applyInverse(e){var t=pool.pull("Matrix3d",this).invert();return t.apply(e),pool.push(t),e}ortho(e,t,i,s,r,n){var o=this.val,a=1/(e-t),h=1/(i-s),l=1/(r-n);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*h,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*l,o[11]=0,o[12]=(e+t)*a,o[13]=(s+i)*h,o[14]=(n+r)*l,o[15]=1,this}scale(e,t,i){var s=this.val,r=e,n=void 0===t?r:t,o=void 0===i?0:i;return s[0]=s[0]*r,s[1]=s[1]*r,s[2]=s[2]*r,s[3]=s[3]*r,s[4]=s[4]*n,s[5]=s[5]*n,s[6]=s[6]*n,s[7]=s[7]*n,s[8]=s[8]*o,s[9]=s[9]*o,s[10]=s[10]*o,s[11]=s[11]*o,this}scaleV(e){return this.scale(e.x,e.y,e.z)}scaleX(e){return this.scale(e,1)}scaleY(e){return this.scale(1,e)}rotate(e,t){var i,s,r,n,o,a,h,l,d,u,c,p,g,f,m,v,_,y,x,w,T,b,E,A,S=this.val,C=t.x,R=t.y,P=t.z,O=Math.sqrt(C*C+R*R+P*P);return O<EPSILON?null:(C*=O=1/O,R*=O,P*=O,i=Math.sin(e),r=1-(s=Math.cos(e)),n=S[0],o=S[1],a=S[2],h=S[3],l=S[4],d=S[5],u=S[6],c=S[7],p=S[8],g=S[9],f=S[10],m=S[11],v=C*C*r+s,_=R*C*r+P*i,y=P*C*r-R*i,x=C*R*r-P*i,w=R*R*r+s,T=P*R*r+C*i,b=C*P*r+R*i,E=R*P*r-C*i,A=P*P*r+s,S[0]=n*v+l*_+p*y,S[1]=o*v+d*_+g*y,S[2]=a*v+u*_+f*y,S[3]=h*v+c*_+m*y,S[4]=n*x+l*w+p*T,S[5]=o*x+d*w+g*T,S[6]=a*x+u*w+f*T,S[7]=h*x+c*w+m*T,S[8]=n*b+l*E+p*A,S[9]=o*b+d*E+g*A,S[10]=a*b+u*E+f*A,S[11]=h*b+c*E+m*A,this)}translate(){var e,t,i,s=this.val;return arguments.length>1?(e=arguments[0],t=arguments[1],i=void 0===arguments[2]?0:arguments[2]):(e=arguments[0].x,t=arguments[0].y,i=void 0===arguments[0].z?0:arguments[0].z),s[12]=s[0]*e+s[4]*t+s[8]*i+s[12],s[13]=s[1]*e+s[5]*t+s[9]*i+s[13],s[14]=s[2]*e+s[6]*t+s[10]*i+s[14],s[15]=s[3]*e+s[7]*t+s[11]*i+s[15],this}isIdentity(){var e=this.val;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15]}equals(e){var t=e.val,i=this.val;return i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2]&&i[3]===t[3]&&i[4]===t[4]&&i[5]===t[5]&&i[6]===t[6]&&i[7]===t[7]&&i[8]===t[8]&&i[9]===t[9]&&i[10]===t[10]&&i[11]===t[11]&&i[12]===t[12]&&i[13]===t[13]&&i[14]===t[14]&&i[15]===t[15]}clone(){return pool.pull("Matrix3d",this)}toArray(){return this.val}toString(){var e=this.val;return"me.Matrix3d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}}class Matrix2d{constructor(...e){this.onResetEvent(...e)}onResetEvent(){return void 0===this.val&&(this.val=new Float32Array(9)),arguments.length&&arguments[0]instanceof Matrix2d?this.copy(arguments[0]):arguments.length&&arguments[0]instanceof Matrix3d?this.fromMat3d(arguments[0]):arguments.length>=6?this.setTransform.apply(this,arguments):this.identity(),this}get tx(){return this.val[6]}get ty(){return this.val[7]}identity(){return this.setTransform(1,0,0,0,1,0,0,0,1),this}setTransform(){var e=this.val;return 9===arguments.length?(e[0]=arguments[0],e[1]=arguments[1],e[2]=arguments[2],e[3]=arguments[3],e[4]=arguments[4],e[5]=arguments[5],e[6]=arguments[6],e[7]=arguments[7],e[8]=arguments[8]):6===arguments.length&&(e[0]=arguments[0],e[1]=arguments[2],e[2]=arguments[4],e[3]=arguments[1],e[4]=arguments[3],e[5]=arguments[5],e[6]=0,e[7]=0,e[8]=1),this}copy(e){return this.val.set(e.val),this}fromMat3d(e){var t=e.val,i=this.val;return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[4],i[4]=t[5],i[5]=t[6],i[6]=t[8],i[7]=t[9],i[8]=t[10],this}multiply(e){var t=e.val,i=this.val,s=i[0],r=i[1],n=i[3],o=i[4],a=t[0],h=t[1],l=t[3],d=t[4],u=t[6],c=t[7];return i[0]=s*a+n*h,i[1]=r*a+o*h,i[3]=s*l+n*d,i[4]=r*l+o*d,i[6]+=s*u+n*c,i[7]+=r*u+o*c,this}transpose(){var e=this.val,t=e[1],i=e[2],s=e[5];return e[1]=e[3],e[2]=e[6],e[3]=t,e[5]=e[7],e[6]=i,e[7]=s,this}invert(){var e=this.val,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],o=e[5],a=e[6],h=e[7],l=e[8],d=l*n-o*h,u=o*a-l*r,c=h*r-n*a,p=t*d+i*u+s*c;return e[0]=d/p,e[1]=(s*h-l*i)/p,e[2]=(o*i-s*n)/p,e[3]=u/p,e[4]=(l*t-s*a)/p,e[5]=(s*r-o*t)/p,e[6]=c/p,e[7]=(i*a-h*t)/p,e[8]=(n*t-i*r)/p,this}apply(e){var t=this.val,i=e.x,s=e.y;return e.x=i*t[0]+s*t[3]+t[6],e.y=i*t[1]+s*t[4]+t[7],e}applyInverse(e){var t=this.val,i=e.x,s=e.y,r=1/(t[0]*t[4]+t[3]*-t[1]);return e.x=t[4]*r*i+-t[3]*r*s+(t[7]*t[3]-t[6]*t[4])*r,e.y=t[0]*r*s+-t[1]*r*i+(-t[7]*t[0]+t[6]*t[1])*r,e}scale(e,t){var i=this.val,s=e,r=void 0===t?s:t;return i[0]*=s,i[1]*=s,i[3]*=r,i[4]*=r,this}scaleV(e){return this.scale(e.x,e.y)}scaleX(e){return this.scale(e,1)}scaleY(e){return this.scale(1,e)}rotate(e){if(0!==e){var t=this.val,i=t[0],s=t[1],r=t[2],n=t[3],o=t[4],a=t[5],h=Math.sin(e),l=Math.cos(e);t[0]=l*i+h*n,t[1]=l*s+h*o,t[2]=l*r+h*a,t[3]=l*n-h*i,t[4]=l*o-h*s,t[5]=l*a-h*r}return this}translate(){var e,t,i=this.val;return 2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),i[6]+=i[0]*e+i[3]*t,i[7]+=i[1]*e+i[4]*t,this}isIdentity(){var e=this.val;return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&1===e[4]&&0===e[5]&&0===e[6]&&0===e[7]&&1===e[8]}equals(e){var t=e.val,i=this.val;return i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2]&&i[3]===t[3]&&i[4]===t[4]&&i[5]===t[5]&&i[6]===t[6]&&i[7]===t[7]&&i[8]===t[8]}clone(){return pool.pull("Matrix2d",this)}toArray(){return this.val}toString(){var e=this.val;return"me.Matrix2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}}var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==__webpack_require__.g?__webpack_require__.g:"undefined"!=typeof self?self:{},eventemitter3={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function s(){}function r(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function n(e,t,s,n,o){if("function"!=typeof s)throw new TypeError("The listener must be a function");var a=new r(s,n||e,o),h=i?i+t:t;return e._events[h]?e._events[h].fn?e._events[h]=[e._events[h],a]:e._events[h].push(a):(e._events[h]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new s:delete e._events[t]}function a(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(i=!1)),a.prototype.eventNames=function(){var e,s,r=[];if(0===this._eventsCount)return r;for(s in e=this._events)t.call(e,s)&&r.push(i?s.slice(1):s);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},a.prototype.listeners=function(e){var t=i?i+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var r=0,n=s.length,o=new Array(n);r<n;r++)o[r]=s[r].fn;return o},a.prototype.listenerCount=function(e){var t=i?i+e:e,s=this._events[t];return s?s.fn?1:s.length:0},a.prototype.emit=function(e,t,s,r,n,o){var a=i?i+e:e;if(!this._events[a])return!1;var h,l,d=this._events[a],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,s),!0;case 4:return d.fn.call(d.context,t,s,r),!0;case 5:return d.fn.call(d.context,t,s,r,n),!0;case 6:return d.fn.call(d.context,t,s,r,n,o),!0}for(l=1,h=new Array(u-1);l<u;l++)h[l-1]=arguments[l];d.fn.apply(d.context,h)}else{var c,p=d.length;for(l=0;l<p;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),u){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,t);break;case 3:d[l].fn.call(d[l].context,t,s);break;case 4:d[l].fn.call(d[l].context,t,s,r);break;default:if(!h)for(c=1,h=new Array(u-1);c<u;c++)h[c-1]=arguments[c];d[l].fn.apply(d[l].context,h)}}return!0},a.prototype.on=function(e,t,i){return n(this,e,t,i,!1)},a.prototype.once=function(e,t,i){return n(this,e,t,i,!0)},a.prototype.removeListener=function(e,t,s,r){var n=i?i+e:e;if(!this._events[n])return this;if(!t)return o(this,n),this;var a=this._events[n];if(a.fn)a.fn!==t||r&&!a.once||s&&a.context!==s||o(this,n);else{for(var h=0,l=[],d=a.length;h<d;h++)(a[h].fn!==t||r&&!a[h].once||s&&a[h].context!==s)&&l.push(a[h]);l.length?this._events[n]=1===l.length?l[0]:l:o(this,n)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&o(this,t)):(this._events=new s,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,e.exports=a}(eventemitter3);var EventEmitter=eventemitter3.exports,eventEmitter=new EventEmitter;const BOOT="me.boot",STATE_PAUSE="me.state.onPause",STATE_RESUME="me.state.onResume",STATE_STOP="me.state.onStop",STATE_RESTART="me.state.onRestart",VIDEO_INIT="me.video.onInit",GAME_INIT="me.game.onInit",GAME_RESET="me.game.onReset",GAME_BEFORE_UPDATE="me.game.beforeUpdate",GAME_AFTER_UPDATE="me.game.afterUpdate",GAME_UPDATE="me.game.onUpdate",GAME_BEFORE_DRAW="me.game.beforeDraw",GAME_AFTER_DRAW="me.game.afterDraw",LEVEL_LOADED="me.game.onLevelLoaded",LOADER_COMPLETE="me.loader.onload",LOADER_PROGRESS="me.loader.onProgress",KEYDOWN="me.input.keydown",KEYUP="me.input.keyup",GAMEPAD_CONNECTED="gamepad.connected",GAMEPAD_DISCONNECTED="gamepad.disconnected",GAMEPAD_UPDATE="gamepad.update",POINTERMOVE="me.event.pointermove",DRAGSTART="me.game.dragstart",DRAGEND="me.game.dragend",WINDOW_ONRESIZE="window.onresize",CANVAS_ONRESIZE="canvas.onresize",VIEWPORT_ONRESIZE="viewport.onresize",WINDOW_ONORIENTATION_CHANGE="window.orientationchange",WINDOW_ONSCROLL="window.onscroll",VIEWPORT_ONCHANGE="viewport.onchange",WEBGL_ONCONTEXT_LOST="renderer.webglcontextlost",WEBGL_ONCONTEXT_RESTORED="renderer.webglcontextrestored";function emit(e,...t){return eventEmitter.emit(e,...t)}function on(e,t,i){return eventEmitter.on(e,t,i)}function once(e,t,i){return eventEmitter.once(e,t,i)}function off(e,t){return eventEmitter.off(e,t)}var event=Object.freeze({__proto__:null,BOOT,STATE_PAUSE,STATE_RESUME,STATE_STOP,STATE_RESTART,VIDEO_INIT,GAME_INIT,GAME_RESET,GAME_BEFORE_UPDATE,GAME_AFTER_UPDATE,GAME_UPDATE,GAME_BEFORE_DRAW,GAME_AFTER_DRAW,LEVEL_LOADED,LOADER_COMPLETE,LOADER_PROGRESS,KEYDOWN,KEYUP,GAMEPAD_CONNECTED,GAMEPAD_DISCONNECTED,GAMEPAD_UPDATE,POINTERMOVE,DRAGSTART,DRAGEND,WINDOW_ONRESIZE,CANVAS_ONRESIZE,VIEWPORT_ONRESIZE,WINDOW_ONORIENTATION_CHANGE,WINDOW_ONSCROLL,VIEWPORT_ONCHANGE,WEBGL_ONCONTEXT_LOST,WEBGL_ONCONTEXT_RESTORED,emit,on,once,off}),howler={},exports;exports=howler,function(){var e=function(){this.init()};e.prototype={init:function(){var e=this||t;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var i=this||t;if(e=parseFloat(e),i.ctx||l(),void 0!==e&&e>=0&&e<=1){if(i._volume=e,i._muted)return i;i.usingWebAudio&&i.masterGain.gain.setValueAtTime(e,t.ctx.currentTime);for(var s=0;s<i._howls.length;s++)if(!i._howls[s]._webAudio)for(var r=i._howls[s]._getSoundIds(),n=0;n<r.length;n++){var o=i._howls[s]._soundById(r[n]);o&&o._node&&(o._node.volume=o._volume*e)}return i}return i._volume},mute:function(e){var i=this||t;i.ctx||l(),i._muted=e,i.usingWebAudio&&i.masterGain.gain.setValueAtTime(e?0:i._volume,t.ctx.currentTime);for(var s=0;s<i._howls.length;s++)if(!i._howls[s]._webAudio)for(var r=i._howls[s]._getSoundIds(),n=0;n<r.length;n++){var o=i._howls[s]._soundById(r[n]);o&&o._node&&(o._node.muted=!!e||o._muted)}return i},stop:function(){for(var e=this||t,i=0;i<e._howls.length;i++)e._howls[i].stop();return e},unload:function(){for(var e=this||t,i=e._howls.length-1;i>=0;i--)e._howls[i].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,l()),e},codecs:function(e){return(this||t)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||t;if(e.state=e.ctx&&e.ctx.state||"suspended",e._autoSuspend(),!e.usingWebAudio)if("undefined"!=typeof Audio)try{void 0===(new Audio).oncanplaythrough&&(e._canPlayEvent="canplay")}catch(t){e.noAudio=!0}else e.noAudio=!0;try{(new Audio).muted&&(e.noAudio=!0)}catch(e){}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||t,i=null;try{i="undefined"!=typeof Audio?new Audio:null}catch(t){return e}if(!i||"function"!=typeof i.canPlayType)return e;var s=i.canPlayType("audio/mpeg;").replace(/^no$/,""),r=e._navigator?e._navigator.userAgent:"",n=r.match(/OPR\/([0-6].)/g),o=n&&parseInt(n[0].split("/")[1],10)<33,a=-1!==r.indexOf("Safari")&&-1===r.indexOf("Chrome"),h=r.match(/Version\/(.*?) /),l=a&&h&&parseInt(h[1],10)<15;return e._codecs={mp3:!(o||!s&&!i.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!s,opus:!!i.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!i.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!i.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(i.canPlayType('audio/wav; codecs="1"')||i.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!i.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!i.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(i.canPlayType("audio/x-m4a;")||i.canPlayType("audio/m4a;")||i.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(i.canPlayType("audio/x-m4b;")||i.canPlayType("audio/m4b;")||i.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(i.canPlayType("audio/x-mp4;")||i.canPlayType("audio/mp4;")||i.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!(l||!i.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!(l||!i.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!i.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(i.canPlayType("audio/x-flac;")||i.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_unlockAudio:function(){var e=this||t;if(!e._audioUnlocked&&e.ctx){e._audioUnlocked=!1,e.autoUnlock=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var i=function(t){for(;e._html5AudioPool.length<e.html5PoolSize;)try{var s=new Audio;s._unlocked=!0,e._releaseHtml5Audio(s)}catch(t){e.noAudio=!0;break}for(var r=0;r<e._howls.length;r++)if(!e._howls[r]._webAudio)for(var n=e._howls[r]._getSoundIds(),o=0;o<n.length;o++){var a=e._howls[r]._soundById(n[o]);a&&a._node&&!a._node._unlocked&&(a._node._unlocked=!0,a._node.load())}e._autoResume();var h=e.ctx.createBufferSource();h.buffer=e._scratchBuffer,h.connect(e.ctx.destination),void 0===h.start?h.noteOn(0):h.start(0),"function"==typeof e.ctx.resume&&e.ctx.resume(),h.onended=function(){h.disconnect(0),e._audioUnlocked=!0,document.removeEventListener("touchstart",i,!0),document.removeEventListener("touchend",i,!0),document.removeEventListener("click",i,!0),document.removeEventListener("keydown",i,!0);for(var t=0;t<e._howls.length;t++)e._howls[t]._emit("unlock")}};return document.addEventListener("touchstart",i,!0),document.addEventListener("touchend",i,!0),document.addEventListener("click",i,!0),document.addEventListener("keydown",i,!0),e}},_obtainHtml5Audio:function(){var e=this||t;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var i=(new Audio).play();return i&&"undefined"!=typeof Promise&&(i instanceof Promise||"function"==typeof i.then)&&i.catch((function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")})),new Audio},_releaseHtml5Audio:function(e){var i=this||t;return e._unlocked&&i._html5AudioPool.push(e),i},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&t.usingWebAudio){for(var i=0;i<e._howls.length;i++)if(e._howls[i]._webAudio)for(var s=0;s<e._howls[i]._sounds.length;s++)if(!e._howls[i]._sounds[s]._paused)return e;return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout((function(){if(e.autoSuspend){e._suspendTimer=null,e.state="suspending";var t=function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())};e.ctx.suspend().then(t,t)}}),3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&void 0!==e.ctx.resume&&t.usingWebAudio)return"running"===e.state&&"interrupted"!==e.ctx.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state||"running"===e.state&&"interrupted"===e.ctx.state?(e.ctx.resume().then((function(){e.state="running";for(var t=0;t<e._howls.length;t++)e._howls[t]._emit("resume")})),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}};var t=new e,i=function(e){e.src&&0!==e.src.length?this.init(e):console.error("An array of source files must be passed with any new Howl.")};i.prototype={init:function(e){var i=this;return t.ctx||l(),i._autoplay=e.autoplay||!1,i._format="string"!=typeof e.format?e.format:[e.format],i._html5=e.html5||!1,i._muted=e.mute||!1,i._loop=e.loop||!1,i._pool=e.pool||5,i._preload="boolean"!=typeof e.preload&&"metadata"!==e.preload||e.preload,i._rate=e.rate||1,i._sprite=e.sprite||{},i._src="string"!=typeof e.src?e.src:[e.src],i._volume=void 0!==e.volume?e.volume:1,i._xhr={method:e.xhr&&e.xhr.method?e.xhr.method:"GET",headers:e.xhr&&e.xhr.headers?e.xhr.headers:null,withCredentials:!(!e.xhr||!e.xhr.withCredentials)&&e.xhr.withCredentials},i._duration=0,i._state="unloaded",i._sounds=[],i._endTimers={},i._queue=[],i._playLock=!1,i._onend=e.onend?[{fn:e.onend}]:[],i._onfade=e.onfade?[{fn:e.onfade}]:[],i._onload=e.onload?[{fn:e.onload}]:[],i._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],i._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],i._onpause=e.onpause?[{fn:e.onpause}]:[],i._onplay=e.onplay?[{fn:e.onplay}]:[],i._onstop=e.onstop?[{fn:e.onstop}]:[],i._onmute=e.onmute?[{fn:e.onmute}]:[],i._onvolume=e.onvolume?[{fn:e.onvolume}]:[],i._onrate=e.onrate?[{fn:e.onrate}]:[],i._onseek=e.onseek?[{fn:e.onseek}]:[],i._onunlock=e.onunlock?[{fn:e.onunlock}]:[],i._onresume=[],i._webAudio=t.usingWebAudio&&!i._html5,void 0!==t.ctx&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(i),i._autoplay&&i._queue.push({event:"play",action:function(){i.play()}}),i._preload&&"none"!==i._preload&&i.load(),i},load:function(){var e=this,i=null;if(t.noAudio)e._emit("loaderror",null,"No audio support.");else{"string"==typeof e._src&&(e._src=[e._src]);for(var r=0;r<e._src.length;r++){var o,a;if(e._format&&e._format[r])o=e._format[r];else{if("string"!=typeof(a=e._src[r])){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(o=/^data:audio\/([^;,]+);/i.exec(a))||(o=/\.([^.]+)$/.exec(a.split("?",1)[0])),o&&(o=o[1].toLowerCase())}if(o||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),o&&t.codecs(o)){i=e._src[r];break}}if(i)return e._src=i,e._state="loading","https:"===window.location.protocol&&"http:"===i.slice(0,5)&&(e._html5=!0,e._webAudio=!1),new s(e),e._webAudio&&n(e),e;e._emit("loaderror",null,"No codec support for selected audio sources.")}},play:function(e,i){var s=this,r=null;if("number"==typeof e)r=e,e=null;else{if("string"==typeof e&&"loaded"===s._state&&!s._sprite[e])return null;if(void 0===e&&(e="__default",!s._playLock)){for(var n=0,o=0;o<s._sounds.length;o++)s._sounds[o]._paused&&!s._sounds[o]._ended&&(n++,r=s._sounds[o]._id);1===n?e=null:r=null}}var a=r?s._soundById(r):s._inactiveSound();if(!a)return null;if(r&&!e&&(e=a._sprite||"__default"),"loaded"!==s._state){a._sprite=e,a._ended=!1;var h=a._id;return s._queue.push({event:"play",action:function(){s.play(h)}}),h}if(r&&!a._paused)return i||s._loadQueue("play"),a._id;s._webAudio&&t._autoResume();var l=Math.max(0,a._seek>0?a._seek:s._sprite[e][0]/1e3),d=Math.max(0,(s._sprite[e][0]+s._sprite[e][1])/1e3-l),u=1e3*d/Math.abs(a._rate),c=s._sprite[e][0]/1e3,p=(s._sprite[e][0]+s._sprite[e][1])/1e3;a._sprite=e,a._ended=!1;var g=function(){a._paused=!1,a._seek=l,a._start=c,a._stop=p,a._loop=!(!a._loop&&!s._sprite[e][2])};if(!(l>=p)){var f=a._node;if(s._webAudio){var m=function(){s._playLock=!1,g(),s._refreshBuffer(a);var e=a._muted||s._muted?0:a._volume;f.gain.setValueAtTime(e,t.ctx.currentTime),a._playStart=t.ctx.currentTime,void 0===f.bufferSource.start?a._loop?f.bufferSource.noteGrainOn(0,l,86400):f.bufferSource.noteGrainOn(0,l,d):a._loop?f.bufferSource.start(0,l,86400):f.bufferSource.start(0,l,d),u!==1/0&&(s._endTimers[a._id]=setTimeout(s._ended.bind(s,a),u)),i||setTimeout((function(){s._emit("play",a._id),s._loadQueue()}),0)};"running"===t.state&&"interrupted"!==t.ctx.state?m():(s._playLock=!0,s.once("resume",m),s._clearTimer(a._id))}else{var v=function(){f.currentTime=l,f.muted=a._muted||s._muted||t._muted||f.muted,f.volume=a._volume*t.volume(),f.playbackRate=a._rate;try{var r=f.play();if(r&&"undefined"!=typeof Promise&&(r instanceof Promise||"function"==typeof r.then)?(s._playLock=!0,g(),r.then((function(){s._playLock=!1,f._unlocked=!0,i?s._loadQueue():s._emit("play",a._id)})).catch((function(){s._playLock=!1,s._emit("playerror",a._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),a._ended=!0,a._paused=!0}))):i||(s._playLock=!1,g(),s._emit("play",a._id)),f.playbackRate=a._rate,f.paused)return void s._emit("playerror",a._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==e||a._loop?s._endTimers[a._id]=setTimeout(s._ended.bind(s,a),u):(s._endTimers[a._id]=function(){s._ended(a),f.removeEventListener("ended",s._endTimers[a._id],!1)},f.addEventListener("ended",s._endTimers[a._id],!1))}catch(e){s._emit("playerror",a._id,e)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===f.src&&(f.src=s._src,f.load());var _=window&&window.ejecta||!f.readyState&&t._navigator.isCocoonJS;if(f.readyState>=3||_)v();else{s._playLock=!0,s._state="loading";var y=function(){s._state="loaded",v(),f.removeEventListener(t._canPlayEvent,y,!1)};f.addEventListener(t._canPlayEvent,y,!1),s._clearTimer(a._id)}}return a._id}s._ended(a)},pause:function(e){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"pause",action:function(){t.pause(e)}}),t;for(var i=t._getSoundIds(e),s=0;s<i.length;s++){t._clearTimer(i[s]);var r=t._soundById(i[s]);if(r&&!r._paused&&(r._seek=t.seek(i[s]),r._rateSeek=0,r._paused=!0,t._stopFade(i[s]),r._node))if(t._webAudio){if(!r._node.bufferSource)continue;void 0===r._node.bufferSource.stop?r._node.bufferSource.noteOff(0):r._node.bufferSource.stop(0),t._cleanBuffer(r._node)}else isNaN(r._node.duration)&&r._node.duration!==1/0||r._node.pause();arguments[1]||t._emit("pause",r?r._id:null)}return t},stop:function(e,t){var i=this;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"stop",action:function(){i.stop(e)}}),i;for(var s=i._getSoundIds(e),r=0;r<s.length;r++){i._clearTimer(s[r]);var n=i._soundById(s[r]);n&&(n._seek=n._start||0,n._rateSeek=0,n._paused=!0,n._ended=!0,i._stopFade(s[r]),n._node&&(i._webAudio?n._node.bufferSource&&(void 0===n._node.bufferSource.stop?n._node.bufferSource.noteOff(0):n._node.bufferSource.stop(0),i._cleanBuffer(n._node)):isNaN(n._node.duration)&&n._node.duration!==1/0||(n._node.currentTime=n._start||0,n._node.pause(),n._node.duration===1/0&&i._clearSound(n._node))),t||i._emit("stop",n._id))}return i},mute:function(e,i){var s=this;if("loaded"!==s._state||s._playLock)return s._queue.push({event:"mute",action:function(){s.mute(e,i)}}),s;if(void 0===i){if("boolean"!=typeof e)return s._muted;s._muted=e}for(var r=s._getSoundIds(i),n=0;n<r.length;n++){var o=s._soundById(r[n]);o&&(o._muted=e,o._interval&&s._stopFade(o._id),s._webAudio&&o._node?o._node.gain.setValueAtTime(e?0:o._volume,t.ctx.currentTime):o._node&&(o._node.muted=!!t._muted||e),s._emit("mute",o._id))}return s},volume:function(){var e,i,s,r=this,n=arguments;if(0===n.length)return r._volume;if(1===n.length||2===n.length&&void 0===n[1]){var o=r._getSoundIds(),a=o.indexOf(n[0]);a>=0?i=parseInt(n[0],10):e=parseFloat(n[0])}else n.length>=2&&(e=parseFloat(n[0]),i=parseInt(n[1],10));if(!(void 0!==e&&e>=0&&e<=1))return(s=i?r._soundById(i):r._sounds[0])?s._volume:0;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"volume",action:function(){r.volume.apply(r,n)}}),r;void 0===i&&(r._volume=e),i=r._getSoundIds(i);for(var h=0;h<i.length;h++)(s=r._soundById(i[h]))&&(s._volume=e,n[2]||r._stopFade(i[h]),r._webAudio&&s._node&&!s._muted?s._node.gain.setValueAtTime(e,t.ctx.currentTime):s._node&&!s._muted&&(s._node.volume=e*t.volume()),r._emit("volume",s._id));return r},fade:function(e,i,s,r){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"fade",action:function(){n.fade(e,i,s,r)}}),n;e=Math.min(Math.max(0,parseFloat(e)),1),i=Math.min(Math.max(0,parseFloat(i)),1),s=parseFloat(s),n.volume(e,r);for(var o=n._getSoundIds(r),a=0;a<o.length;a++){var h=n._soundById(o[a]);if(h){if(r||n._stopFade(o[a]),n._webAudio&&!h._muted){var l=t.ctx.currentTime,d=l+s/1e3;h._volume=e,h._node.gain.setValueAtTime(e,l),h._node.gain.linearRampToValueAtTime(i,d)}n._startFadeInterval(h,e,i,s,o[a],void 0===r)}}return n},_startFadeInterval:function(e,t,i,s,r,n){var o=this,a=t,h=i-t,l=Math.abs(h/.01),d=Math.max(4,l>0?s/l:s),u=Date.now();e._fadeTo=i,e._interval=setInterval((function(){var r=(Date.now()-u)/s;u=Date.now(),a+=h*r,a=Math.round(100*a)/100,a=h<0?Math.max(i,a):Math.min(i,a),o._webAudio?e._volume=a:o.volume(a,e._id,!0),n&&(o._volume=a),(i<t&&a<=i||i>t&&a>=i)&&(clearInterval(e._interval),e._interval=null,e._fadeTo=null,o.volume(i,e._id),o._emit("fade",e._id))}),d)},_stopFade:function(e){var i=this,s=i._soundById(e);return s&&s._interval&&(i._webAudio&&s._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(s._interval),s._interval=null,i.volume(s._fadeTo,e),s._fadeTo=null,i._emit("fade",e)),i},loop:function(){var e,t,i,s=this,r=arguments;if(0===r.length)return s._loop;if(1===r.length){if("boolean"!=typeof r[0])return!!(i=s._soundById(parseInt(r[0],10)))&&i._loop;e=r[0],s._loop=e}else 2===r.length&&(e=r[0],t=parseInt(r[1],10));for(var n=s._getSoundIds(t),o=0;o<n.length;o++)(i=s._soundById(n[o]))&&(i._loop=e,s._webAudio&&i._node&&i._node.bufferSource&&(i._node.bufferSource.loop=e,e&&(i._node.bufferSource.loopStart=i._start||0,i._node.bufferSource.loopEnd=i._stop,s.playing(n[o])&&(s.pause(n[o],!0),s.play(n[o],!0)))));return s},rate:function(){var e,i,s,r=this,n=arguments;if(0===n.length)i=r._sounds[0]._id;else if(1===n.length){var o=r._getSoundIds(),a=o.indexOf(n[0]);a>=0?i=parseInt(n[0],10):e=parseFloat(n[0])}else 2===n.length&&(e=parseFloat(n[0]),i=parseInt(n[1],10));if("number"!=typeof e)return(s=r._soundById(i))?s._rate:r._rate;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"rate",action:function(){r.rate.apply(r,n)}}),r;void 0===i&&(r._rate=e),i=r._getSoundIds(i);for(var h=0;h<i.length;h++)if(s=r._soundById(i[h])){r.playing(i[h])&&(s._rateSeek=r.seek(i[h]),s._playStart=r._webAudio?t.ctx.currentTime:s._playStart),s._rate=e,r._webAudio&&s._node&&s._node.bufferSource?s._node.bufferSource.playbackRate.setValueAtTime(e,t.ctx.currentTime):s._node&&(s._node.playbackRate=e);var l=r.seek(i[h]),d=(r._sprite[s._sprite][0]+r._sprite[s._sprite][1])/1e3-l,u=1e3*d/Math.abs(s._rate);!r._endTimers[i[h]]&&s._paused||(r._clearTimer(i[h]),r._endTimers[i[h]]=setTimeout(r._ended.bind(r,s),u)),r._emit("rate",s._id)}return r},seek:function(){var e,i,s=this,r=arguments;if(0===r.length)s._sounds.length&&(i=s._sounds[0]._id);else if(1===r.length){var n=s._getSoundIds(),o=n.indexOf(r[0]);o>=0?i=parseInt(r[0],10):s._sounds.length&&(i=s._sounds[0]._id,e=parseFloat(r[0]))}else 2===r.length&&(e=parseFloat(r[0]),i=parseInt(r[1],10));if(void 0===i)return 0;if("number"==typeof e&&("loaded"!==s._state||s._playLock))return s._queue.push({event:"seek",action:function(){s.seek.apply(s,r)}}),s;var a=s._soundById(i);if(a){if(!("number"==typeof e&&e>=0)){if(s._webAudio){var h=s.playing(i)?t.ctx.currentTime-a._playStart:0,l=a._rateSeek?a._rateSeek-a._seek:0;return a._seek+(l+h*Math.abs(a._rate))}return a._node.currentTime}var d=s.playing(i);d&&s.pause(i,!0),a._seek=e,a._ended=!1,s._clearTimer(i),s._webAudio||!a._node||isNaN(a._node.duration)||(a._node.currentTime=e);var u=function(){d&&s.play(i,!0),s._emit("seek",i)};if(d&&!s._webAudio){var c=function(){s._playLock?setTimeout(c,0):u()};setTimeout(c,0)}else u()}return s},playing:function(e){var t=this;if("number"==typeof e){var i=t._soundById(e);return!!i&&!i._paused}for(var s=0;s<t._sounds.length;s++)if(!t._sounds[s]._paused)return!0;return!1},duration:function(e){var t=this,i=t._duration,s=t._soundById(e);return s&&(i=t._sprite[s._sprite][1]/1e3),i},state:function(){return this._state},unload:function(){for(var e=this,i=e._sounds,s=0;s<i.length;s++)i[s]._paused||e.stop(i[s]._id),e._webAudio||(e._clearSound(i[s]._node),i[s]._node.removeEventListener("error",i[s]._errorFn,!1),i[s]._node.removeEventListener(t._canPlayEvent,i[s]._loadFn,!1),i[s]._node.removeEventListener("ended",i[s]._endFn,!1),t._releaseHtml5Audio(i[s]._node)),delete i[s]._node,e._clearTimer(i[s]._id);var n=t._howls.indexOf(e);n>=0&&t._howls.splice(n,1);var o=!0;for(s=0;s<t._howls.length;s++)if(t._howls[s]._src===e._src||e._src.indexOf(t._howls[s]._src)>=0){o=!1;break}return r&&o&&delete r[e._src],t.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,t,i,s){var r=this["_on"+e];return"function"==typeof t&&r.push(s?{id:i,fn:t,once:s}:{id:i,fn:t}),this},off:function(e,t,i){var s=this,r=s["_on"+e],n=0;if("number"==typeof t&&(i=t,t=null),t||i)for(n=0;n<r.length;n++){var o=i===r[n].id;if(t===r[n].fn&&o||!t&&o){r.splice(n,1);break}}else if(e)s["_on"+e]=[];else{var a=Object.keys(s);for(n=0;n<a.length;n++)0===a[n].indexOf("_on")&&Array.isArray(s[a[n]])&&(s[a[n]]=[])}return s},once:function(e,t,i){return this.on(e,t,i,1),this},_emit:function(e,t,i){for(var s=this,r=s["_on"+e],n=r.length-1;n>=0;n--)r[n].id&&r[n].id!==t&&"load"!==e||(setTimeout(function(e){e.call(this,t,i)}.bind(s,r[n].fn),0),r[n].once&&s.off(e,r[n].fn,r[n].id));return s._loadQueue(e),s},_loadQueue:function(e){var t=this;if(t._queue.length>0){var i=t._queue[0];i.event===e&&(t._queue.shift(),t._loadQueue()),e||i.action()}return t},_ended:function(e){var i=this,s=e._sprite;if(!i._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(i._ended.bind(i,e),100),i;var r=!(!e._loop&&!i._sprite[s][2]);if(i._emit("end",e._id),!i._webAudio&&r&&i.stop(e._id,!0).play(e._id),i._webAudio&&r){i._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=t.ctx.currentTime;var n=1e3*(e._stop-e._start)/Math.abs(e._rate);i._endTimers[e._id]=setTimeout(i._ended.bind(i,e),n)}return i._webAudio&&!r&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,i._clearTimer(e._id),i._cleanBuffer(e._node),t._autoSuspend()),i._webAudio||r||i.stop(e._id,!0),i},_clearTimer:function(e){var t=this;if(t._endTimers[e]){if("function"!=typeof t._endTimers[e])clearTimeout(t._endTimers[e]);else{var i=t._soundById(e);i&&i._node&&i._node.removeEventListener("ended",t._endTimers[e],!1)}delete t._endTimers[e]}return t},_soundById:function(e){for(var t=this,i=0;i<t._sounds.length;i++)if(e===t._sounds[i]._id)return t._sounds[i];return null},_inactiveSound:function(){var e=this;e._drain();for(var t=0;t<e._sounds.length;t++)if(e._sounds[t]._ended)return e._sounds[t].reset();return new s(e)},_drain:function(){var e=this,t=e._pool,i=0,s=0;if(!(e._sounds.length<t)){for(s=0;s<e._sounds.length;s++)e._sounds[s]._ended&&i++;for(s=e._sounds.length-1;s>=0;s--){if(i<=t)return;e._sounds[s]._ended&&(e._webAudio&&e._sounds[s]._node&&e._sounds[s]._node.disconnect(0),e._sounds.splice(s,1),i--)}}},_getSoundIds:function(e){if(void 0===e){for(var t=[],i=0;i<this._sounds.length;i++)t.push(this._sounds[i]._id);return t}return[e]},_refreshBuffer:function(e){return e._node.bufferSource=t.ctx.createBufferSource(),e._node.bufferSource.buffer=r[this._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,t.ctx.currentTime),this},_cleanBuffer:function(e){var i=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(t._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),i))try{e.bufferSource.buffer=t._scratchBuffer}catch(e){}return e.bufferSource=null,this},_clearSound:function(e){/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent)||(e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var s=function(e){this._parent=e,this.init()};s.prototype={init:function(){var e=this,i=e._parent;return e._muted=i._muted,e._loop=i._loop,e._volume=i._volume,e._rate=i._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++t._counter,i._sounds.push(e),e.create(),e},create:function(){var e=this,i=e._parent,s=t._muted||e._muted||e._parent._muted?0:e._volume;return i._webAudio?(e._node=void 0===t.ctx.createGain?t.ctx.createGainNode():t.ctx.createGain(),e._node.gain.setValueAtTime(s,t.ctx.currentTime),e._node.paused=!0,e._node.connect(t.masterGain)):t.noAudio||(e._node=t._obtainHtml5Audio(),e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(t._canPlayEvent,e._loadFn,!1),e._endFn=e._endListener.bind(e),e._node.addEventListener("ended",e._endFn,!1),e._node.src=i._src,e._node.preload=!0===i._preload?"auto":i._preload,e._node.volume=s*t.volume(),e._node.load()),e},reset:function(){var e=this,i=e._parent;return e._muted=i._muted,e._loop=i._loop,e._volume=i._volume,e._rate=i._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++t._counter,e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorFn,!1)},_loadListener:function(){var e=this,i=e._parent;i._duration=Math.ceil(10*e._node.duration)/10,0===Object.keys(i._sprite).length&&(i._sprite={__default:[0,1e3*i._duration]}),"loaded"!==i._state&&(i._state="loaded",i._emit("load"),i._loadQueue()),e._node.removeEventListener(t._canPlayEvent,e._loadFn,!1)},_endListener:function(){var e=this,t=e._parent;t._duration===1/0&&(t._duration=Math.ceil(10*e._node.duration)/10,t._sprite.__default[1]===1/0&&(t._sprite.__default[1]=1e3*t._duration),t._ended(e)),e._node.removeEventListener("ended",e._endFn,!1)}};var r={},n=function(e){var t=e._src;if(r[t])return e._duration=r[t].duration,void h(e);if(/^data:[^;]+;base64,/.test(t)){for(var i=atob(t.split(",")[1]),s=new Uint8Array(i.length),n=0;n<i.length;++n)s[n]=i.charCodeAt(n);a(s.buffer,e)}else{var l=new XMLHttpRequest;l.open(e._xhr.method,t,!0),l.withCredentials=e._xhr.withCredentials,l.responseType="arraybuffer",e._xhr.headers&&Object.keys(e._xhr.headers).forEach((function(t){l.setRequestHeader(t,e._xhr.headers[t])})),l.onload=function(){var t=(l.status+"")[0];"0"===t||"2"===t||"3"===t?a(l.response,e):e._emit("loaderror",null,"Failed loading audio file with status: "+l.status+".")},l.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete r[t],e.load())},o(l)}},o=function(e){try{e.send()}catch(t){e.onerror()}},a=function(e,i){var s=function(){i._emit("loaderror",null,"Decoding audio data failed.")},n=function(e){e&&i._sounds.length>0?(r[i._src]=e,h(i,e)):s()};"undefined"!=typeof Promise&&1===t.ctx.decodeAudioData.length?t.ctx.decodeAudioData(e).then(n).catch(s):t.ctx.decodeAudioData(e,n,s)},h=function(e,t){t&&!e._duration&&(e._duration=t.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},l=function(){if(t.usingWebAudio){try{"undefined"!=typeof AudioContext?t.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch(e){t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),i=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),s=i?parseInt(i[1],10):null;if(e&&s&&s<9){var r=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!r&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=void 0===t.ctx.createGain?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};exports.Howler=t,exports.Howl=i,void 0!==commonjsGlobal?(commonjsGlobal.HowlerGlobal=e,commonjsGlobal.Howler=t,commonjsGlobal.Howl=i,commonjsGlobal.Sound=s):"undefined"!=typeof window&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=i,window.Sound=s)}(),function(){var e;HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var t=this;if(!t.ctx||!t.ctx.listener)return t;for(var i=t._howls.length-1;i>=0;i--)t._howls[i].stereo(e);return t},HowlerGlobal.prototype.pos=function(e,t,i){var s=this;return s.ctx&&s.ctx.listener?(t="number"!=typeof t?s._pos[1]:t,i="number"!=typeof i?s._pos[2]:i,"number"!=typeof e?s._pos:(s._pos=[e,t,i],void 0!==s.ctx.listener.positionX?(s.ctx.listener.positionX.setTargetAtTime(s._pos[0],Howler.ctx.currentTime,.1),s.ctx.listener.positionY.setTargetAtTime(s._pos[1],Howler.ctx.currentTime,.1),s.ctx.listener.positionZ.setTargetAtTime(s._pos[2],Howler.ctx.currentTime,.1)):s.ctx.listener.setPosition(s._pos[0],s._pos[1],s._pos[2]),s)):s},HowlerGlobal.prototype.orientation=function(e,t,i,s,r,n){var o=this;if(!o.ctx||!o.ctx.listener)return o;var a=o._orientation;return t="number"!=typeof t?a[1]:t,i="number"!=typeof i?a[2]:i,s="number"!=typeof s?a[3]:s,r="number"!=typeof r?a[4]:r,n="number"!=typeof n?a[5]:n,"number"!=typeof e?a:(o._orientation=[e,t,i,s,r,n],void 0!==o.ctx.listener.forwardX?(o.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),o.ctx.listener.forwardY.setTargetAtTime(t,Howler.ctx.currentTime,.1),o.ctx.listener.forwardZ.setTargetAtTime(i,Howler.ctx.currentTime,.1),o.ctx.listener.upX.setTargetAtTime(s,Howler.ctx.currentTime,.1),o.ctx.listener.upY.setTargetAtTime(r,Howler.ctx.currentTime,.1),o.ctx.listener.upZ.setTargetAtTime(n,Howler.ctx.currentTime,.1)):o.ctx.listener.setOrientation(e,t,i,s,r,n),o)},Howl.prototype.init=(e=Howl.prototype.init,function(t){var i=this;return i._orientation=t.orientation||[1,0,0],i._stereo=t.stereo||null,i._pos=t.pos||null,i._pannerAttr={coneInnerAngle:void 0!==t.coneInnerAngle?t.coneInnerAngle:360,coneOuterAngle:void 0!==t.coneOuterAngle?t.coneOuterAngle:360,coneOuterGain:void 0!==t.coneOuterGain?t.coneOuterGain:0,distanceModel:void 0!==t.distanceModel?t.distanceModel:"inverse",maxDistance:void 0!==t.maxDistance?t.maxDistance:1e4,panningModel:void 0!==t.panningModel?t.panningModel:"HRTF",refDistance:void 0!==t.refDistance?t.refDistance:1,rolloffFactor:void 0!==t.rolloffFactor?t.rolloffFactor:1},i._onstereo=t.onstereo?[{fn:t.onstereo}]:[],i._onpos=t.onpos?[{fn:t.onpos}]:[],i._onorientation=t.onorientation?[{fn:t.onorientation}]:[],e.call(this,t)}),Howl.prototype.stereo=function(e,i){var s=this;if(!s._webAudio)return s;if("loaded"!==s._state)return s._queue.push({event:"stereo",action:function(){s.stereo(e,i)}}),s;var r=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===i){if("number"!=typeof e)return s._stereo;s._stereo=e,s._pos=[e,0,0]}for(var n=s._getSoundIds(i),o=0;o<n.length;o++){var a=s._soundById(n[o]);if(a){if("number"!=typeof e)return a._stereo;a._stereo=e,a._pos=[e,0,0],a._node&&(a._pannerAttr.panningModel="equalpower",a._panner&&a._panner.pan||t(a,r),"spatial"===r?void 0!==a._panner.positionX?(a._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),a._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),a._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):a._panner.setPosition(e,0,0):a._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),s._emit("stereo",a._id)}}return s},Howl.prototype.pos=function(e,i,s,r){var n=this;if(!n._webAudio)return n;if("loaded"!==n._state)return n._queue.push({event:"pos",action:function(){n.pos(e,i,s,r)}}),n;if(i="number"!=typeof i?0:i,s="number"!=typeof s?-.5:s,void 0===r){if("number"!=typeof e)return n._pos;n._pos=[e,i,s]}for(var o=n._getSoundIds(r),a=0;a<o.length;a++){var h=n._soundById(o[a]);if(h){if("number"!=typeof e)return h._pos;h._pos=[e,i,s],h._node&&(h._panner&&!h._panner.pan||t(h,"spatial"),void 0!==h._panner.positionX?(h._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):h._panner.setPosition(e,i,s)),n._emit("pos",h._id)}}return n},Howl.prototype.orientation=function(e,i,s,r){var n=this;if(!n._webAudio)return n;if("loaded"!==n._state)return n._queue.push({event:"orientation",action:function(){n.orientation(e,i,s,r)}}),n;if(i="number"!=typeof i?n._orientation[1]:i,s="number"!=typeof s?n._orientation[2]:s,void 0===r){if("number"!=typeof e)return n._orientation;n._orientation=[e,i,s]}for(var o=n._getSoundIds(r),a=0;a<o.length;a++){var h=n._soundById(o[a]);if(h){if("number"!=typeof e)return h._orientation;h._orientation=[e,i,s],h._node&&(h._panner||(h._pos||(h._pos=n._pos||[0,0,-.5]),t(h,"spatial")),void 0!==h._panner.orientationX?(h._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),h._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):h._panner.setOrientation(e,i,s)),n._emit("orientation",h._id)}}return n},Howl.prototype.pannerAttr=function(){var e,i,s,r=this,n=arguments;if(!r._webAudio)return r;if(0===n.length)return r._pannerAttr;if(1===n.length){if("object"!=typeof n[0])return(s=r._soundById(parseInt(n[0],10)))?s._pannerAttr:r._pannerAttr;e=n[0],void 0===i&&(e.pannerAttr||(e.pannerAttr={coneInnerAngle:e.coneInnerAngle,coneOuterAngle:e.coneOuterAngle,coneOuterGain:e.coneOuterGain,distanceModel:e.distanceModel,maxDistance:e.maxDistance,refDistance:e.refDistance,rolloffFactor:e.rolloffFactor,panningModel:e.panningModel}),r._pannerAttr={coneInnerAngle:void 0!==e.pannerAttr.coneInnerAngle?e.pannerAttr.coneInnerAngle:r._coneInnerAngle,coneOuterAngle:void 0!==e.pannerAttr.coneOuterAngle?e.pannerAttr.coneOuterAngle:r._coneOuterAngle,coneOuterGain:void 0!==e.pannerAttr.coneOuterGain?e.pannerAttr.coneOuterGain:r._coneOuterGain,distanceModel:void 0!==e.pannerAttr.distanceModel?e.pannerAttr.distanceModel:r._distanceModel,maxDistance:void 0!==e.pannerAttr.maxDistance?e.pannerAttr.maxDistance:r._maxDistance,refDistance:void 0!==e.pannerAttr.refDistance?e.pannerAttr.refDistance:r._refDistance,rolloffFactor:void 0!==e.pannerAttr.rolloffFactor?e.pannerAttr.rolloffFactor:r._rolloffFactor,panningModel:void 0!==e.pannerAttr.panningModel?e.pannerAttr.panningModel:r._panningModel})}else 2===n.length&&(e=n[0],i=parseInt(n[1],10));for(var o=r._getSoundIds(i),a=0;a<o.length;a++)if(s=r._soundById(o[a])){var h=s._pannerAttr;h={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:h.coneInnerAngle,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:h.coneOuterAngle,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:h.coneOuterGain,distanceModel:void 0!==e.distanceModel?e.distanceModel:h.distanceModel,maxDistance:void 0!==e.maxDistance?e.maxDistance:h.maxDistance,refDistance:void 0!==e.refDistance?e.refDistance:h.refDistance,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:h.rolloffFactor,panningModel:void 0!==e.panningModel?e.panningModel:h.panningModel};var l=s._panner;l?(l.coneInnerAngle=h.coneInnerAngle,l.coneOuterAngle=h.coneOuterAngle,l.coneOuterGain=h.coneOuterGain,l.distanceModel=h.distanceModel,l.maxDistance=h.maxDistance,l.refDistance=h.refDistance,l.rolloffFactor=h.rolloffFactor,l.panningModel=h.panningModel):(s._pos||(s._pos=r._pos||[0,0,-.5]),t(s,"spatial"))}return r},Sound.prototype.init=function(e){return function(){var t=this,i=t._parent;t._orientation=i._orientation,t._stereo=i._stereo,t._pos=i._pos,t._pannerAttr=i._pannerAttr,e.call(this),t._stereo?i.stereo(t._stereo):t._pos&&i.pos(t._pos[0],t._pos[1],t._pos[2],t._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var t=this,i=t._parent;return t._orientation=i._orientation,t._stereo=i._stereo,t._pos=i._pos,t._pannerAttr=i._pannerAttr,t._stereo?i.stereo(t._stereo):t._pos?i.pos(t._pos[0],t._pos[1],t._pos[2],t._id):t._panner&&(t._panner.disconnect(0),t._panner=void 0,i._refreshBuffer(t)),e.call(this)}}(Sound.prototype.reset);var t=function(e,t){"spatial"===(t=t||"spatial")?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,void 0!==e._panner.positionX?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),void 0!==e._panner.orientationX?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}}();class ObservableVector2d extends Vector2d{constructor(e=0,t=0,i){if(super(e,t),void 0===i)throw new Error("undefined `onUpdate` callback");this.setCallback(i.onUpdate,i.scope)}onResetEvent(e=0,t=0,i){return this.setMuted(e,t),void 0!==i&&this.setCallback(i.onUpdate,i.scope),this}get x(){return this._x}set x(e){var t=this.onUpdate.call(this.scope,e,this._y,this._x,this._y);this._x=t&&"x"in t?t.x:e}get y(){return this._y}set y(e){var t=this.onUpdate.call(this.scope,this._x,e,this._x,this._y);this._y=t&&"y"in t?t.y:e}_set(e,t){var i=this.onUpdate.call(this.scope,e,t,this._x,this._y);return i&&"x"in i&&"y"in i?(this._x=i.x,this._y=i.y):(this._x=e,this._y=t),this}setMuted(e,t){return this._x=e,this._y=t,this}setCallback(e,t=null){if("function"!=typeof e)throw new Error("invalid `onUpdate` callback");return this.onUpdate=e,this.scope=t,this}add(e){return this._set(this._x+e.x,this._y+e.y)}sub(e){return this._set(this._x-e.x,this._y-e.y)}scale(e,t){return this._set(this._x*e,this._y*(void 0!==t?t:e))}scaleV(e){return this._set(this._x*e.x,this._y*e.y)}div(e){return this._set(this._x/e,this._y/e)}abs(){return this._set(this._x<0?-this._x:this._x,this._y<0?-this._y:this._y)}clamp(e,t){return new ObservableVector2d(clamp(this.x,e,t),clamp(this.y,e,t),{onUpdate:this.onUpdate,scope:this.scope})}clampSelf(e,t){return this._set(clamp(this._x,e,t),clamp(this._y,e,t))}minV(e){return this._set(this._x<e.x?this._x:e.x,this._y<e.y?this._y:e.y)}maxV(e){return this._set(this._x>e.x?this._x:e.x,this._y>e.y?this._y:e.y)}floor(){return new ObservableVector2d(Math.floor(this._x),Math.floor(this._y),{onUpdate:this.onUpdate,scope:this.scope})}floorSelf(){return this._set(Math.floor(this._x),Math.floor(this._y))}ceil(){return new ObservableVector2d(Math.ceil(this._x),Math.ceil(this._y),{onUpdate:this.onUpdate,scope:this.scope})}ceilSelf(){return this._set(Math.ceil(this._x),Math.ceil(this._y))}negate(){return new ObservableVector2d(-this._x,-this._y,{onUpdate:this.onUpdate,scope:this.scope})}negateSelf(){return this._set(-this._x,-this._y)}copy(e){return this._set(e.x,e.y)}equals(e){return this._x===e.x&&this._y===e.y}perp(){return this._set(this._y,-this._x)}rotate(e,t){var i=0,s=0;"object"==typeof t&&(i=t.x,s=t.y);var r=this._x-i,n=this._y-s,o=Math.cos(e),a=Math.sin(e);return this._set(r*o-n*a+i,r*a+n*o+s)}dotProduct(e){return this._x*e.x+this._y*e.y}lerp(e,t){return this._x+=(e.x-this._x)*t,this._y+=(e.y-this._y)*t,this}distance(e){return Math.sqrt((this._x-e.x)*(this._x-e.x)+(this._y-e.y)*(this._y-e.y))}clone(){return pool.pull("ObservableVector2d",this._x,this._y,{onUpdate:this.onUpdate,scope:this.scope})}toVector2d(){return pool.pull("Vector2d",this._x,this._y)}toString(){return"x:"+this._x+",y:"+this._y}}class Vector3d{constructor(...e){this.onResetEvent(...e)}onResetEvent(e=0,t=0,i=0){return this.x=e,this.y=t,this.z=i,this}_set(e,t,i=0){return this.x=e,this.y=t,this.z=i,this}set(e,t,i){if(e!==+e||t!==+t||void 0!==i&&i!==+i)throw new Error("invalid x, y, z parameters (not a number)");return this._set(e,t,i)}setZero(){return this.set(0,0,0)}setV(e){return this._set(e.x,e.y,e.z)}add(e){return this._set(this.x+e.x,this.y+e.y,this.z+(e.z||0))}sub(e){return this._set(this.x-e.x,this.y-e.y,this.z-(e.z||0))}scale(e,t,i){return t=void 0!==t?t:e,this._set(this.x*e,this.y*t,this.z*(i||1))}scaleV(e){return this.scale(e.x,e.y,e.z)}toIso(){return this._set(this.x-this.y,.5*(this.x+this.y),this.z)}to2d(){return this._set(this.y+this.x/2,this.y-this.x/2,this.z)}div(e){return this._set(this.x/e,this.y/e,this.z/e)}abs(){return this._set(this.x<0?-this.x:this.x,this.y<0?-this.y:this.y,this.z<0?-this.z:this.z)}clamp(e,t){return new Vector3d(clamp(this.x,e,t),clamp(this.y,e,t),clamp(this.z,e,t))}clampSelf(e,t){return this._set(clamp(this.x,e,t),clamp(this.y,e,t),clamp(this.z,e,t))}minV(e){var t=e.z||0;return this._set(this.x<e.x?this.x:e.x,this.y<e.y?this.y:e.y,this.z<t?this.z:t)}maxV(e){var t=e.z||0;return this._set(this.x>e.x?this.x:e.x,this.y>e.y?this.y:e.y,this.z>t?this.z:t)}floor(){return new Vector3d(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}floorSelf(){return this._set(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}ceil(){return new Vector3d(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))}ceilSelf(){return this._set(Math.ceil(this.x),Math.ceil(this.y),Math.ceil(this.z))}negate(){return new Vector3d(-this.x,-this.y,-this.z)}negateSelf(){return this._set(-this.x,-this.y,-this.z)}copy(e){return this._set(e.x,e.y,e.z||0)}equals(){var e,t,i;return arguments.length>=2?(e=arguments[0],t=arguments[1],i=arguments[2]):(e=arguments[0].x,t=arguments[0].y,i=arguments[0].z),void 0===i&&(i=this.z),this.x===e&&this.y===t&&this.z===i}normalize(){return this.div(this.length()||1)}perp(){return this._set(this.y,-this.x,this.z)}rotate(e,t){var i=0,s=0;"object"==typeof t&&(i=t.x,s=t.y);var r=this.x-i,n=this.y-s,o=Math.cos(e),a=Math.sin(e);return this._set(r*o-n*a+i,r*a+n*o+s,this.z)}dotProduct(e){return this.x*e.x+this.y*e.y+this.z*(void 0!==e.z?e.z:this.z)}length2(){return this.dotProduct(this)}length(){return Math.sqrt(this.length2())}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}distance(e){var t=this.x-e.x,i=this.y-e.y,s=this.z-(e.z||0);return Math.sqrt(t*t+i*i+s*s)}angle(e){return Math.acos(clamp(this.dotProduct(e)/(this.length()*e.length()),-1,1))}project(e){var t=this.dotProduct(e)/e.length2();return this.scale(t,t,t)}projectN(e){var t=this.dotProduct(e)/e.length2();return this.scale(t,t,t)}clone(){return pool.pull("Vector3d",this.x,this.y,this.z)}toString(){return"x:"+this.x+",y:"+this.y+",z:"+this.z}}class ObservableVector3d extends Vector3d{constructor(e=0,t=0,i=0,s){if(super(e,t,i),void 0===s)throw new Error("undefined `onUpdate` callback");this.setCallback(s.onUpdate,s.scope)}onResetEvent(e=0,t=0,i=0,s){return this.setMuted(e,t,i),void 0!==s&&this.setCallback(s.onUpdate,s.scope),this}get x(){return this._x}set x(e){var t=this.onUpdate.call(this.scope,e,this._y,this._z,this._x,this._y,this._z);this._x=t&&"x"in t?t.x:e}get y(){return this._y}set y(e){var t=this.onUpdate.call(this.scope,this._x,e,this._z,this._x,this._y,this._z);this._y=t&&"y"in t?t.y:e}get z(){return this._z}set z(e){var t=this.onUpdate.call(this.scope,this._x,this._y,e,this._x,this._y,this._z);this._z=t&&"z"in t?t.z:e}_set(e,t,i){var s=this.onUpdate.call(this.scope,e,t,i,this._x,this._y,this._z);return s&&"x"in s&&"y"in s&&"z"in s?(this._x=s.x,this._y=s.y,this._z=s.z):(this._x=e,this._y=t,this._z=i||0),this}setMuted(e,t,i){return this._x=e,this._y=t,this._z=i||0,this}setCallback(e,t=null){if("function"!=typeof e)throw new Error("invalid `onUpdate` callback");return this.onUpdate=e,this.scope=t,this}add(e){return this._set(this._x+e.x,this._y+e.y,this._z+(e.z||0))}sub(e){return this._set(this._x-e.x,this._y-e.y,this._z-(e.z||0))}scale(e,t,i){return t=void 0!==t?t:e,this._set(this._x*e,this._y*t,this._z*(i||1))}scaleV(e){return this._set(this._x*e.x,this._y*e.y,this._z*(e.z||1))}div(e){return this._set(this._x/e,this._y/e,this._z/e)}abs(){return this._set(this._x<0?-this._x:this._x,this._y<0?-this._y:this._y,this._Z<0?-this._z:this._z)}clamp(e,t){return new ObservableVector3d(clamp(this._x,e,t),clamp(this._y,e,t),clamp(this._z,e,t),{onUpdate:this.onUpdate,scope:this.scope})}clampSelf(e,t){return this._set(clamp(this._x,e,t),clamp(this._y,e,t),clamp(this._z,e,t))}minV(e){var t=e.z||0;return this._set(this._x<e.x?this._x:e.x,this._y<e.y?this._y:e.y,this._z<t?this._z:t)}maxV(e){var t=e.z||0;return this._set(this._x>e.x?this._x:e.x,this._y>e.y?this._y:e.y,this._z>t?this._z:t)}floor(){return new ObservableVector3d(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z),{onUpdate:this.onUpdate,scope:this.scope})}floorSelf(){return this._set(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}ceil(){return new ObservableVector3d(Math.ceil(this._x),Math.ceil(this._y),Math.ceil(this._z),{onUpdate:this.onUpdate,scope:this.scope})}ceilSelf(){return this._set(Math.ceil(this._x),Math.ceil(this._y),Math.ceil(this._z))}negate(){return new ObservableVector3d(-this._x,-this._y,-this._z,{onUpdate:this.onUpdate,scope:this.scope})}negateSelf(){return this._set(-this._x,-this._y,-this._z)}copy(e){return this._set(e.x,e.y,e.z||0)}equals(e){return this._x===e.x&&this._y===e.y&&this._z===(e.z||this._z)}perp(){return this._set(this._y,-this._x,this._z)}rotate(e,t){var i=0,s=0;"object"==typeof t&&(i=t.x,s=t.y);var r=this.x-i,n=this.y-s,o=Math.cos(e),a=Math.sin(e);return this._set(r*o-n*a+i,r*a+n*o+s,this.z)}dotProduct(e){return this._x*e.x+this._y*e.y+this._z*(e.z||1)}lerp(e,t){return this._x+=(e.x-this._x)*t,this._y+=(e.y-this._y)*t,this._z+=(e.z-this._z)*t,this}distance(e){var t=this._x-e.x,i=this._y-e.y,s=this._z-(e.z||0);return Math.sqrt(t*t+i*i+s*s)}clone(){return pool.pull("ObservableVector3d",this._x,this._y,this._z,{onUpdate:this.onUpdate})}toVector3d(){return pool.pull("Vector3d",this._x,this._y,this._z)}toString(){return"x:"+this._x+",y:"+this._y+",z:"+this._z}}var earcut$2={exports:{}};function earcut(e,t,i){i=i||2;var s,r,n,o,a,h,l,d=t&&t.length,u=d?t[0]*i:e.length,c=linkedList(e,0,u,i,!0),p=[];if(!c||c.next===c.prev)return p;if(d&&(c=eliminateHoles(e,t,c,i)),e.length>80*i){s=n=e[0],r=o=e[1];for(var g=i;g<u;g+=i)(a=e[g])<s&&(s=a),(h=e[g+1])<r&&(r=h),a>n&&(n=a),h>o&&(o=h);l=0!==(l=Math.max(n-s,o-r))?1/l:0}return earcutLinked(c,p,i,s,r,l),p}function linkedList(e,t,i,s,r){var n,o;if(r===signedArea(e,t,i,s)>0)for(n=t;n<i;n+=s)o=insertNode(n,e[n],e[n+1],o);else for(n=i-s;n>=t;n-=s)o=insertNode(n,e[n],e[n+1],o);return o&&equals(o,o.next)&&(removeNode(o),o=o.next),o}function filterPoints(e,t){if(!e)return e;t||(t=e);var i,s=e;do{if(i=!1,s.steiner||!equals(s,s.next)&&0!==area(s.prev,s,s.next))s=s.next;else{if(removeNode(s),(s=t=s.prev)===s.next)break;i=!0}}while(i||s!==t);return t}function earcutLinked(e,t,i,s,r,n,o){if(e){!o&&n&&indexCurve(e,s,r,n);for(var a,h,l=e;e.prev!==e.next;)if(a=e.prev,h=e.next,n?isEarHashed(e,s,r,n):isEar(e))t.push(a.i/i),t.push(e.i/i),t.push(h.i/i),removeNode(e),e=h.next,l=h.next;else if((e=h)===l){o?1===o?earcutLinked(e=cureLocalIntersections(filterPoints(e),t,i),t,i,s,r,n,2):2===o&&splitEarcut(e,t,i,s,r,n):earcutLinked(filterPoints(e),t,i,s,r,n,1);break}}}function isEar(e){var t=e.prev,i=e,s=e.next;if(area(t,i,s)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(pointInTriangle(t.x,t.y,i.x,i.y,s.x,s.y,r.x,r.y)&&area(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function isEarHashed(e,t,i,s){var r=e.prev,n=e,o=e.next;if(area(r,n,o)>=0)return!1;for(var a=r.x<n.x?r.x<o.x?r.x:o.x:n.x<o.x?n.x:o.x,h=r.y<n.y?r.y<o.y?r.y:o.y:n.y<o.y?n.y:o.y,l=r.x>n.x?r.x>o.x?r.x:o.x:n.x>o.x?n.x:o.x,d=r.y>n.y?r.y>o.y?r.y:o.y:n.y>o.y?n.y:o.y,u=zOrder(a,h,t,i,s),c=zOrder(l,d,t,i,s),p=e.prevZ,g=e.nextZ;p&&p.z>=u&&g&&g.z<=c;){if(p!==e.prev&&p!==e.next&&pointInTriangle(r.x,r.y,n.x,n.y,o.x,o.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,g!==e.prev&&g!==e.next&&pointInTriangle(r.x,r.y,n.x,n.y,o.x,o.y,g.x,g.y)&&area(g.prev,g,g.next)>=0)return!1;g=g.nextZ}for(;p&&p.z>=u;){if(p!==e.prev&&p!==e.next&&pointInTriangle(r.x,r.y,n.x,n.y,o.x,o.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;g&&g.z<=c;){if(g!==e.prev&&g!==e.next&&pointInTriangle(r.x,r.y,n.x,n.y,o.x,o.y,g.x,g.y)&&area(g.prev,g,g.next)>=0)return!1;g=g.nextZ}return!0}function cureLocalIntersections(e,t,i){var s=e;do{var r=s.prev,n=s.next.next;!equals(r,n)&&intersects(r,s,s.next,n)&&locallyInside(r,n)&&locallyInside(n,r)&&(t.push(r.i/i),t.push(s.i/i),t.push(n.i/i),removeNode(s),removeNode(s.next),s=e=n),s=s.next}while(s!==e);return filterPoints(s)}function splitEarcut(e,t,i,s,r,n){var o=e;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&isValidDiagonal(o,a)){var h=splitPolygon(o,a);return o=filterPoints(o,o.next),h=filterPoints(h,h.next),earcutLinked(o,t,i,s,r,n),void earcutLinked(h,t,i,s,r,n)}a=a.next}o=o.next}while(o!==e)}function eliminateHoles(e,t,i,s){var r,n,o,a=[];for(r=0,n=t.length;r<n;r++)(o=linkedList(e,t[r]*s,r<n-1?t[r+1]*s:e.length,s,!1))===o.next&&(o.steiner=!0),a.push(getLeftmost(o));for(a.sort(compareX),r=0;r<a.length;r++)i=filterPoints(i=eliminateHole(a[r],i),i.next);return i}function compareX(e,t){return e.x-t.x}function eliminateHole(e,t){var i=findHoleBridge(e,t);if(!i)return t;var s=splitPolygon(i,e),r=filterPoints(i,i.next);return filterPoints(s,s.next),t===i?r:t}function findHoleBridge(e,t){var i,s=t,r=e.x,n=e.y,o=-1/0;do{if(n<=s.y&&n>=s.next.y&&s.next.y!==s.y){var a=s.x+(n-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(a<=r&&a>o){if(o=a,a===r){if(n===s.y)return s;if(n===s.next.y)return s.next}i=s.x<s.next.x?s:s.next}}s=s.next}while(s!==t);if(!i)return null;if(r===o)return i;var h,l=i,d=i.x,u=i.y,c=1/0;s=i;do{r>=s.x&&s.x>=d&&r!==s.x&&pointInTriangle(n<u?r:o,n,d,u,n<u?o:r,n,s.x,s.y)&&(h=Math.abs(n-s.y)/(r-s.x),locallyInside(s,e)&&(h<c||h===c&&(s.x>i.x||s.x===i.x&&sectorContainsSector(i,s)))&&(i=s,c=h)),s=s.next}while(s!==l);return i}function sectorContainsSector(e,t){return area(e.prev,e,t.prev)<0&&area(t.next,e,e.next)<0}function indexCurve(e,t,i,s){var r=e;do{null===r.z&&(r.z=zOrder(r.x,r.y,t,i,s)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,sortLinked(r)}function sortLinked(e){var t,i,s,r,n,o,a,h,l=1;do{for(i=e,e=null,n=null,o=0;i;){for(o++,s=i,a=0,t=0;t<l&&(a++,s=s.nextZ);t++);for(h=l;a>0||h>0&&s;)0!==a&&(0===h||!s||i.z<=s.z)?(r=i,i=i.nextZ,a--):(r=s,s=s.nextZ,h--),n?n.nextZ=r:e=r,r.prevZ=n,n=r;i=s}n.nextZ=null,l*=2}while(o>1);return e}function zOrder(e,t,i,s,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-s)*r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function getLeftmost(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function pointInTriangle(e,t,i,s,r,n,o,a){return(r-o)*(t-a)-(e-o)*(n-a)>=0&&(e-o)*(s-a)-(i-o)*(t-a)>=0&&(i-o)*(n-a)-(r-o)*(s-a)>=0}function isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!intersectsPolygon(e,t)&&(locallyInside(e,t)&&locallyInside(t,e)&&middleInside(e,t)&&(area(e.prev,e,t.prev)||area(e,t.prev,t))||equals(e,t)&&area(e.prev,e,e.next)>0&&area(t.prev,t,t.next)>0)}function area(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function equals(e,t){return e.x===t.x&&e.y===t.y}function intersects(e,t,i,s){var r=sign(area(e,t,i)),n=sign(area(e,t,s)),o=sign(area(i,s,e)),a=sign(area(i,s,t));return r!==n&&o!==a||!(0!==r||!onSegment(e,i,t))||!(0!==n||!onSegment(e,s,t))||!(0!==o||!onSegment(i,e,s))||!(0!==a||!onSegment(i,t,s))}function onSegment(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function sign(e){return e>0?1:e<0?-1:0}function intersectsPolygon(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&intersects(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}function locallyInside(e,t){return area(e.prev,e,e.next)<0?area(e,t,e.next)>=0&&area(e,e.prev,t)>=0:area(e,t,e.prev)<0||area(e,e.next,t)<0}function middleInside(e,t){var i=e,s=!1,r=(e.x+t.x)/2,n=(e.y+t.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==e);return s}function splitPolygon(e,t){var i=new Node$1(e.i,e.x,e.y),s=new Node$1(t.i,t.x,t.y),r=e.next,n=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,s.next=i,i.prev=s,n.next=s,s.prev=n,s}function insertNode(e,t,i,s){var r=new Node$1(e,t,i);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Node$1(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function signedArea(e,t,i,s){for(var r=0,n=t,o=i-s;n<i;n+=s)r+=(e[o]-e[n])*(e[n+1]+e[o+1]),o=n;return r}earcut$2.exports=earcut,earcut$2.exports.default=earcut,earcut.deviation=function(e,t,i,s){var r=t&&t.length,n=r?t[0]*i:e.length,o=Math.abs(signedArea(e,0,n,i));if(r)for(var a=0,h=t.length;a<h;a++){var l=t[a]*i,d=a<h-1?t[a+1]*i:e.length;o-=Math.abs(signedArea(e,l,d,i))}var u=0;for(a=0;a<s.length;a+=3){var c=s[a]*i,p=s[a+1]*i,g=s[a+2]*i;u+=Math.abs((e[c]-e[g])*(e[p+1]-e[c+1])-(e[c]-e[p])*(e[g+1]-e[c+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},earcut.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},s=0,r=0;r<e.length;r++){for(var n=0;n<e[r].length;n++)for(var o=0;o<t;o++)i.vertices.push(e[r][n][o]);r>0&&(s+=e[r-1].length,i.holes.push(s))}return i};var earcut$1=earcut$2.exports;class Polygon{constructor(e,t,i){this.pos=new Vector2d,this._bounds,this.points=[],this.edges=[],this.indices=[],this.normals=[],this.shapeType="Polygon",this.setShape(e,t,i)}onResetEvent(e,t,i){this.setShape(e,t,i)}setShape(e,t,i){return this.pos.set(e,t),this.setVertices(i),this}setVertices(e){if(!Array.isArray(e))return this;if(e[0]instanceof Vector2d)this.points=e;else if(this.points.length=0,"object"==typeof e[0])e.forEach((e=>{this.points.push(new Vector2d(e.x,e.y))}));else for(var t=0;t<e.length;t+=2)this.points.push(new Vector2d(e[t],e[t+1]));return this.recalc(),this.updateBounds(),this}transform(e){for(var t=this.points,i=t.length,s=0;s<i;s++)e.apply(t[s]);return this.recalc(),this.updateBounds(),this}toIso(){return this.rotate(Math.PI/4).scale(Math.SQRT2,Math.SQRT1_2)}to2d(){return this.scale(Math.SQRT1_2,Math.SQRT2).rotate(-Math.PI/4)}rotate(e,t){if(0!==e){for(var i=this.points,s=i.length,r=0;r<s;r++)i[r].rotate(e,t);this.recalc(),this.updateBounds()}return this}scale(e,t){t=void 0!==t?t:e;for(var i=this.points,s=i.length,r=0;r<s;r++)i[r].scale(e,t);return this.recalc(),this.updateBounds(),this}scaleV(e){return this.scale(e.x,e.y)}recalc(){var e,t=this.edges,i=this.normals,s=this.indices,r=this.points,n=r.length;if(n<3)throw new Error("Requires at least 3 points");for(e=0;e<n;e++)void 0===t[e]&&(t[e]=new Vector2d),t[e].copy(r[(e+1)%n]).sub(r[e]),void 0===i[e]&&(i[e]=new Vector2d),i[e].copy(t[e]).perp().normalize();return t.length=n,i.length=n,s.length=0,this}getIndices(){return 0===this.indices.length&&(this.indices=earcut$1(this.points.flatMap((e=>[e.x,e.y])))),this.indices}translate(){var e,t;return 2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),this.pos.x+=e,this.pos.y+=t,this.getBounds().translate(e,t),this}shift(){var e,t;2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),this.pos.x=e,this.pos.y=t,this.updateBounds()}contains(){var e,t;2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y);for(var i=!1,s=this.pos.x,r=this.pos.y,n=this.points,o=n.length,a=0,h=o-1;a<o;h=a++){var l=n[a].y+r,d=n[a].x+s,u=n[h].y+r,c=n[h].x+s;l>t!=u>t&&e<(c-d)*(t-l)/(u-l)+d&&(i=!i)}return i}getBounds(){return void 0===this._bounds&&(this._bounds=pool.pull("Bounds")),this._bounds}updateBounds(){var e=this.getBounds();return e.update(this.points),e.translate(this.pos),e}clone(){var e=[];return this.points.forEach((function(t){e.push(t.clone())})),new Polygon(this.pos.x,this.pos.y,e)}}class Rect extends Polygon{constructor(e,t,i,s){super(e,t,[new Vector2d(0,0),new Vector2d(i,0),new Vector2d(i,s),new Vector2d(0,s)]),this.shapeType="Rectangle"}onResetEvent(e,t,i,s){this.setShape(e,t,i,s)}setShape(e,t,i,s){var r=i;return this.pos.set(e,t),4===arguments.length&&((r=this.points)[0].set(0,0),r[1].set(i,0),r[2].set(i,s),r[3].set(0,s)),this.setVertices(r),this}get left(){return this.pos.x}get right(){var e=this.width;return this.pos.x+e||e}get top(){return this.pos.y}get bottom(){var e=this.height;return this.pos.y+e||e}get width(){return this.points[2].x}set width(e){this.points[1].x=this.points[2].x=e,this.recalc(),this.updateBounds()}get height(){return this.points[2].y}set height(e){this.points[2].y=this.points[3].y=e,this.recalc(),this.updateBounds()}get centerX(){return isFinite(this.width)?this.pos.x+this.width/2:this.width}set centerX(e){this.pos.x=e-this.width/2}get centerY(){return isFinite(this.height)?this.pos.y+this.height/2:this.height}set centerY(e){this.pos.y=e-this.height/2}resize(e,t){return this.width=e,this.height=t,this}scale(e,t=e){return this.width*=e,this.height*=t,this}clone(){return new Rect(this.pos.x,this.pos.y,this.width,this.height)}copy(e){return this.setShape(e.pos.x,e.pos.y,e.width,e.height)}union(e){var t=Math.min(this.left,e.left),i=Math.min(this.top,e.top);return this.resize(Math.max(this.right,e.right)-t,Math.max(this.bottom,e.bottom)-i),this.pos.set(t,i),this}overlaps(e){return this.left<e.right&&e.left<this.right&&this.top<e.bottom&&e.top<this.bottom}contains(){var e,t,i,s,r=arguments[0];return 2===arguments.length?(e=t=r,i=s=arguments[1]):r instanceof Rect?(e=r.left,t=r.right,i=r.top,s=r.bottom):(e=t=r.x,i=s=r.y),e>=this.left&&t<=this.right&&i>=this.top&&s<=this.bottom}equals(e){return e.left===this.left&&e.right===this.right&&e.top===this.top&&e.bottom===this.bottom}isFinite(){return isFinite(this.pos.x)&&isFinite(this.pos.y)&&isFinite(this.width)&&isFinite(this.height)}toPolygon(){return new Polygon(this.pos.x,this.pos.y,this.points)}}var _keyStatus={},_keyLock={},_keyLocked={},_keyRefs={},_preventDefaultForKeys={},_keyBindings={},keyDownEvent=function(e,t,i){t=t||e.keyCode||e.button;var s=_keyBindings[t];if(emit(KEYDOWN,s,t,!s||!_keyLocked[s]),s){if(!_keyLocked[s]){var r=void 0!==i?i:t;_keyRefs[s][r]||(_keyStatus[s]++,_keyRefs[s][r]=!0)}return!_preventDefaultForKeys[t]||"function"!=typeof e.preventDefault||e.preventDefault()}return!0},keyUpEvent=function(e,t,i){t=t||e.keyCode||e.button;var s=_keyBindings[t];if(emit(KEYUP,s,t),s){var r=void 0!==i?i:t;return _keyRefs[s][r]=void 0,_keyStatus[s]>0&&_keyStatus[s]--,_keyLocked[s]=!1,!_preventDefaultForKeys[t]||"function"!=typeof e.preventDefault||e.preventDefault()}return!0},keyBoardEventTarget=null,KEY={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,PRINT_SCREEN:42,INSERT:45,DELETE:46,NUM0:48,NUM1:49,NUM2:50,NUM3:51,NUM4:52,NUM5:53,NUM6:54,NUM7:55,NUM8:56,NUM9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,WINDOW_KEY:91,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,TILDE:126,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,PLUS:187,COMMA:188,MINUS:189,PERIOD:190,FORWAND_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};function initKeyboardEvent(){null===keyBoardEventTarget&&!1===device$1.isMobile&&((keyBoardEventTarget=window).addEventListener("keydown",keyDownEvent,!1),keyBoardEventTarget.addEventListener("keyup",keyUpEvent,!1))}function isKeyPressed(e){return!(!_keyStatus[e]||_keyLocked[e]||(_keyLock[e]&&(_keyLocked[e]=!0),0))}function keyStatus(e){return _keyStatus[e]>0}function triggerKeyEvent(e,t,i){!0===t?keyDownEvent({},e,i):keyUpEvent({},e,i)}function bindKey(e,t,i,s=preventDefault){_keyBindings[e]=t,_preventDefaultForKeys[e]=s,_keyStatus[t]=0,_keyLock[t]=i||!1,_keyLocked[t]=!1,_keyRefs[t]={}}function getBindingKey(e){return _keyBindings[e]}function unlockKey(e){_keyLocked[e]=!1}function unbindKey(e){var t=_keyBindings[e];_keyStatus[t]=0,_keyLock[t]=!1,_keyRefs[t]={},_keyBindings[e]=null,_preventDefaultForKeys[e]=null}class Bounds$1{constructor(e){this.onResetEvent(e)}onResetEvent(e){void 0===this.min?(this.min={x:1/0,y:1/0},this.max={x:-1/0,y:-1/0}):this.clear(),void 0!==e&&this.update(e),this._center=new Vector2d}clear(){this.setMinMax(1/0,1/0,-1/0,-1/0)}setMinMax(e,t,i,s){this.min.x=e,this.min.y=t,this.max.x=i,this.max.y=s}get x(){return this.min.x}set x(e){var t=this.max.x-this.min.x;this.min.x=e,this.max.x=e+t}get y(){return this.min.y}set y(e){var t=this.max.y-this.min.y;this.min.y=e,this.max.y=e+t}get width(){return this.max.x-this.min.x}set width(e){this.max.x=this.min.x+e}get height(){return this.max.y-this.min.y}set height(e){this.max.y=this.min.y+e}get left(){return this.min.x}get right(){return this.max.x}get top(){return this.min.y}get bottom(){return this.max.y}get centerX(){return this.min.x+this.width/2}get centerY(){return this.min.y+this.height/2}get center(){return this._center.set(this.centerX,this.centerY)}update(e){this.add(e,!0)}add(e,t=!1){!0===t&&this.clear();for(var i=0;i<e.length;i++){var s=e[i];s.x>this.max.x&&(this.max.x=s.x),s.x<this.min.x&&(this.min.x=s.x),s.y>this.max.y&&(this.max.y=s.y),s.y<this.min.y&&(this.min.y=s.y)}}addBounds(e,t=!1){!0===t&&this.clear(),e.max.x>this.max.x&&(this.max.x=e.max.x),e.min.x<this.min.x&&(this.min.x=e.min.x),e.max.y>this.max.y&&(this.max.y=e.max.y),e.min.y<this.min.y&&(this.min.y=e.min.y)}addPoint(e,t){void 0!==t&&(e=t.apply(e)),this.min.x=Math.min(this.min.x,e.x),this.max.x=Math.max(this.max.x,e.x),this.min.y=Math.min(this.min.y,e.y),this.max.y=Math.max(this.max.y,e.y)}addFrame(e,t,i,s,r){var n=me.pool.pull("Vector2d");this.addPoint(n.set(e,t),r),this.addPoint(n.set(i,t),r),this.addPoint(n.set(e,s),r),this.addPoint(n.set(i,s),r),me.pool.push(n)}contains(){var e,t,i,s,r=arguments[0];return 2===arguments.length?(e=t=r,i=s=arguments[1]):r instanceof Bounds$1?(e=r.min.x,t=r.max.x,i=r.min.y,s=r.max.y):(e=t=r.x,i=s=r.y),e>=this.min.x&&t<=this.max.x&&i>=this.min.y&&s<=this.max.y}overlaps(e){return!(this.right<e.left||this.left>e.right||this.bottom<e.top||this.top>e.bottom)}isFinite(){return isFinite(this.min.x)&&isFinite(this.max.x)&&isFinite(this.min.y)&&isFinite(this.max.y)}translate(){var e,t;2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),this.min.x+=e,this.max.x+=e,this.min.y+=t,this.max.y+=t}shift(){var e,t;2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y);var i=this.max.x-this.min.x,s=this.max.y-this.min.y;this.min.x=e,this.max.x=e+i,this.min.y=t,this.max.y=t+s}clone(){var e=new Bounds$1;return e.addBounds(this),e}toPolygon(){return new Polygon(this.x,this.y,[new Vector2d(0,0),new Vector2d(this.width,0),new Vector2d(this.width,this.height),new Vector2d(0,this.height)])}}var tmpVec=new Vector2d;class Pointer extends Bounds$1{constructor(e=0,t=0,i=1,s=1){super(),this.setMinMax(e,t,e+i,t+s),this.LEFT=0,this.MIDDLE=1,this.RIGHT=2,this.event=void 0,this.type=void 0,this.button=0,this.isPrimary=!1,this.pageX=0,this.pageY=0,this.clientX=0,this.clientY=0,this.deltaMode=0,this.deltaX=0,this.deltaY=0,this.deltaZ=0,this.gameX=0,this.gameY=0,this.gameScreenX=0,this.gameScreenY=0,this.gameWorldX=0,this.gameWorldY=0,this.gameLocalX=0,this.gameLocalY=0,this.pointerId=void 0,this.bind=[0,0,0]}setEvent(e,t=0,i=0,s=0,r=0,n=1){this.event=e,this.pageX=t,this.pageY=i,this.clientX=s,this.clientY=r,globalToLocal(this.pageX,this.pageY,tmpVec),this.gameScreenX=this.x=tmpVec.x,this.gameScreenY=this.y=tmpVec.y,this.isNormalized=!device$1.PointerEvent||device$1.PointerEvent&&!(e instanceof window.PointerEvent),"wheel"===e.type?(this.deltaMode=e.deltaMode||0,this.deltaX=e.deltaX||0,this.deltaY=e.deltaY||0,this.deltaZ=e.deltaZ||0):(this.deltaMode=0,this.deltaX=0,this.deltaY=0,this.deltaZ=0),this.pointerId=n,this.isPrimary=void 0===e.isPrimary||e.isPrimary,this.button=e.button||0,this.type=e.type,void 0!==viewport&&viewport.localToWorld(this.gameScreenX,this.gameScreenY,tmpVec),this.gameWorldX=tmpVec.x,this.gameWorldY=tmpVec.y,!1===this.isNormalized?(this.width=e.width||1,this.height=e.height||1):"number"==typeof e.radiusX?(this.width=2*e.radiusX||1,this.height=2*e.radiusY||1):this.width=this.height=1}}var T_POINTERS=[],eventHandlers=new Map,currentPointer,pointerInitialized=!1,lastTimeStamp=0,activeEventList=[],WHEEL=["wheel"],POINTER_MOVE=["pointermove","mousemove","touchmove"],POINTER_DOWN=["pointerdown","mousedown","touchstart"],POINTER_UP=["pointerup","mouseup","touchend"],POINTER_CANCEL=["pointercancel","mousecancel","touchcancel"],POINTER_ENTER=["pointerenter","mouseenter","touchenter"],POINTER_OVER=["pointerover","mouseover","touchover"],POINTER_LEAVE=["pointerleave","mouseleave","touchleave"],pointerEventList=[WHEEL[0],POINTER_MOVE[0],POINTER_DOWN[0],POINTER_UP[0],POINTER_CANCEL[0],POINTER_ENTER[0],POINTER_OVER[0],POINTER_LEAVE[0]],mouseEventList=[WHEEL[0],POINTER_MOVE[1],POINTER_DOWN[1],POINTER_UP[1],POINTER_CANCEL[1],POINTER_ENTER[1],POINTER_OVER[1],POINTER_LEAVE[1]],touchEventList=[POINTER_MOVE[2],POINTER_DOWN[2],POINTER_UP[2],POINTER_CANCEL[2],POINTER_ENTER[2],POINTER_OVER[2],POINTER_LEAVE[2]],pointerEventMap={wheel:WHEEL,pointermove:POINTER_MOVE,pointerdown:POINTER_DOWN,pointerup:POINTER_UP,pointercancel:POINTER_CANCEL,pointerenter:POINTER_ENTER,pointerover:POINTER_OVER,pointerleave:POINTER_LEAVE},normalizedEvents=[];function registerEventListener(e,t){for(var i=0;i<e.length;i++)-1===POINTER_MOVE.indexOf(e[i])&&pointerEventTarget.addEventListener(e[i],t,{passive:!1===preventDefault})}function enablePointerEvent(){if(!pointerInitialized){currentPointer=new Rect(0,0,1,1);for(var e=0;e<device$1.maxTouchPoints;e++)T_POINTERS.push(new Pointer);var t;null===pointerEventTarget&&(pointerEventTarget=renderer.getScreenCanvas()),activeEventList=device$1.PointerEvent?pointerEventList:mouseEventList,device$1.touch&&!device$1.PointerEvent&&(activeEventList=activeEventList.concat(touchEventList)),registerEventListener(activeEventList,onPointerEvent),void 0===throttlingInterval&&(throttlingInterval=~~(1e3/timer$1.maxfps)),!0===device$1.autoFocus&&(device$1.focus(),pointerEventTarget.addEventListener(activeEventList[2],(function(){device$1.focus()}),{passive:!1===preventDefault}));var i=findAllActiveEvents(activeEventList,POINTER_MOVE);if(throttlingInterval<17)for(t=0;t<i.length;t++)-1!==activeEventList.indexOf(i[t])&&pointerEventTarget.addEventListener(i[t],onMoveEvent,{passive:!0});else for(t=0;t<i.length;t++)-1!==activeEventList.indexOf(i[t])&&pointerEventTarget.addEventListener(i[t],throttle(onMoveEvent,throttlingInterval,!1),{passive:!0});setTouchAction(pointerEventTarget),pointerInitialized=!0}}function findActiveEvent(e,t){for(var i=0;i<t.length;i++)if(-1!==e.indexOf(t[i]))return t[i]}function findAllActiveEvents(e,t){for(var i=[],s=0;s<t.length;s++)-1!==e.indexOf(t[s])&&i.push(t[s]);return i}function triggerEvent(e,t,i,s){var r;if(e.callbacks[t]){e.pointerId=s;for(var n=e.callbacks[t].length-1;n>=0&&(r=e.callbacks[t][n]);n--)if(!1===r(i))return!0}return!1}function dispatchEvent(e){for(var t=!1;e.length>0;){var i=e.pop();if(T_POINTERS.push(i),void 0!==i.event.timeStamp){if(i.event.timeStamp<lastTimeStamp)continue;lastTimeStamp=i.event.timeStamp}currentPointer.setShape(i.gameWorldX,i.gameWorldY,i.width,i.height),POINTER_MOVE.includes(i.type)&&(i.gameX=i.gameLocalX=i.gameScreenX,i.gameY=i.gameLocalY=i.gameScreenY,emit(POINTERMOVE,i));for(var s,r=world.broadphase.retrieve(currentPointer,Container.prototype._sortReverseZ),n=(r=r.concat([viewport])).length;s=r[--n];){if(eventHandlers.has(s)&&!0!==s.isKinematic){var o=eventHandlers.get(s),a=o.region,h=a.ancestor,l=a.getBounds(),d=!1;if(!0===a.floating?(i.gameX=i.gameLocalX=i.gameScreenX,i.gameY=i.gameLocalY=i.gameScreenY):(i.gameX=i.gameLocalX=i.gameWorldX,i.gameY=i.gameLocalY=i.gameWorldY),void 0!==h){var u=h.getBounds();i.gameLocalX=i.gameX-u.x,i.gameLocalY=i.gameY-u.y}if(a instanceof Renderable){var c=i.gameX,p=i.gameY;if(!a.currentTransform.isIdentity()){var g=a.currentTransform.applyInverse(pool.pull("Vector2d",c,p));c=g.x,p=g.y,pool.push(g)}d=l.contains(c,p)}else d=l.contains(i.gameX,i.gameY)&&(l===a||a.contains(i.gameLocalX,i.gameLocalY));switch(i.type){case POINTER_MOVE[0]:case POINTER_MOVE[1]:case POINTER_MOVE[2]:case POINTER_MOVE[3]:if(o.pointerId!==i.pointerId||d){if(null===o.pointerId&&d&&triggerEvent(o,findActiveEvent(activeEventList,POINTER_ENTER),i,i.pointerId)){t=!0;break}}else if(triggerEvent(o,findActiveEvent(activeEventList,POINTER_LEAVE),i,null)){t=!0;break}if(d&&triggerEvent(o,i.type,i,i.pointerId)){t=!0;break}break;case POINTER_UP[0]:case POINTER_UP[1]:case POINTER_UP[2]:case POINTER_UP[3]:if(o.pointerId===i.pointerId&&d&&triggerEvent(o,i.type,i,null)){t=!0;break}break;case POINTER_CANCEL[0]:case POINTER_CANCEL[1]:case POINTER_CANCEL[2]:case POINTER_CANCEL[3]:if(o.pointerId===i.pointerId&&triggerEvent(o,i.type,i,null)){t=!0;break}break;default:if(d&&triggerEvent(o,i.type,i,i.pointerId)){t=!0;break}}}if(!0===t)break}}return t}function normalizeEvent(e){var t;if(device$1.TouchEvent&&e.changedTouches)for(var i=0,s=e.changedTouches.length;i<s;i++){var r=e.changedTouches[i];(t=T_POINTERS.pop()).setEvent(e,r.pageX,r.pageY,r.clientX,r.clientY,r.identifier),normalizedEvents.push(t)}else(t=T_POINTERS.pop()).setEvent(e,e.pageX,e.pageY,e.clientX,e.clientY,e.pointerId),normalizedEvents.push(t);return!1===e.isPrimary||(normalizedEvents[0].isPrimary=!0,Object.assign(pointer,normalizedEvents[0])),normalizedEvents}function onMoveEvent(e){dispatchEvent(normalizeEvent(e))}function onPointerEvent(e){normalizeEvent(e);var t=normalizedEvents[0].button;(dispatchEvent(normalizedEvents)||"wheel"===e.type)&&e.preventDefault();var i=pointer.bind[t];i&&triggerKeyEvent(i,POINTER_DOWN.includes(e.type),t+1)}var pointerEventTarget=null,pointer=new Pointer(0,0,1,1),throttlingInterval;function globalToLocal(e,t,i){i=i||new Vector2d;var s=device$1.getElementBounds(renderer.getScreenCanvas()),r=device$1.devicePixelRatio;e-=s.left+(window.pageXOffset||0),t-=s.top+(window.pageYOffset||0);var n=scaleRatio;return 1===n.x&&1===n.y||(e/=n.x,t/=n.y),i.set(e*r,t*r)}function setTouchAction(e,t){e.style["touch-action"]=t||"none"}function bindPointer(){var e=arguments.length<2?pointer.LEFT:arguments[0],t=arguments.length<2?arguments[0]:arguments[1];if(enablePointerEvent(),!getBindingKey(t))throw new Error("no action defined for keycode "+t);pointer.bind[e]=t}function unbindPointer(e){pointer.bind[void 0===e?pointer.LEFT:e]=null}function registerPointerEvent(e,t,i){if(enablePointerEvent(),-1===pointerEventList.indexOf(e))throw new Error("invalid event type : "+e);if(void 0===t)throw new Error("registerPointerEvent: region for "+toString(t)+" event is undefined ");var s=findAllActiveEvents(activeEventList,pointerEventMap[e]);eventHandlers.has(t)||eventHandlers.set(t,{region:t,callbacks:{},pointerId:null});for(var r=eventHandlers.get(t),n=0;n<s.length;n++)e=s[n],r.callbacks[e]?r.callbacks[e].push(i):r.callbacks[e]=[i]}function releasePointerEvent(e,t,i){if(-1===pointerEventList.indexOf(e))throw new Error("invalid event type : "+e);var s=findAllActiveEvents(activeEventList,pointerEventMap[e]),r=eventHandlers.get(t);if(void 0!==r){for(var n=0;n<s.length;n++)if(e=s[n],r.callbacks[e]){if(void 0!==i)remove(r.callbacks[e],i);else for(;r.callbacks[e].length>0;)r.callbacks[e].pop();0===r.callbacks[e].length&&delete r.callbacks[e]}0===Object.keys(r.callbacks).length&&eventHandlers.delete(t)}}function releaseAllPointerEvents(e){if(eventHandlers.has(e))for(var t=0;t<pointerEventList.length;t++)this.releasePointerEvent(pointerEventList[t],e)}var deadzone=.1;function wiredXbox360NormalizeFn(e,t,i){return i===this.GAMEPAD.BUTTONS.L2||i===this.GAMEPAD.BUTTONS.R2?(e+1)/2:e}function ouyaNormalizeFn(e,t,i){return e>0?i===this.GAMEPAD.BUTTONS.L2?Math.max(0,e-2e4)/111070:(e-1)/131070:(65536+e)/131070+.5}var vendorProductRE=/^([0-9a-f]{1,4})-([0-9a-f]{1,4})-/i,leadingZeroRE=/^0+/;function addMapping(e,t){var i=e.replace(vendorProductRE,(function(e,t,i){return"000".substr(t.length-1)+t+"-"+"000".substr(i.length-1)+i+"-"})),s=e.replace(vendorProductRE,(function(e,t,i){return t.replace(leadingZeroRE,"")+"-"+i.replace(leadingZeroRE,"")+"-"}));t.analog=t.analog||t.buttons.map((function(){return-1})),t.normalize_fn=t.normalize_fn||function(e){return e},remap.set(i,t),remap.set(s,t)}var bindings={},remap=new Map,updateEventHandler;[["45e-28e-Xbox 360 Wired Controller",{axes:[0,1,3,4],buttons:[11,12,13,14,8,9,-1,-1,5,4,6,7,0,1,2,3,10],analog:[-1,-1,-1,-1,-1,-1,2,5,-1,-1,-1,-1,-1,-1,-1,-1,-1],normalize_fn:wiredXbox360NormalizeFn}],["54c-268-PLAYSTATION(R)3 Controller",{axes:[0,1,2,3],buttons:[14,13,15,12,10,11,8,9,0,3,1,2,4,6,7,5,16]}],["54c-5c4-Wireless Controller",{axes:[0,1,2,3],buttons:[1,0,2,3,4,5,6,7,8,9,10,11,14,15,16,17,12,13]}],["2836-1-OUYA Game Controller",{axes:[0,3,7,9],buttons:[3,6,4,5,7,8,15,16,-1,-1,9,10,11,12,13,14,-1],analog:[-1,-1,-1,-1,-1,-1,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1],normalize_fn:ouyaNormalizeFn}],["OUYA Game Controller (Vendor: 2836 Product: 0001)",{axes:[0,1,3,4],buttons:[0,3,1,2,4,5,12,13,-1,-1,6,7,8,9,10,11,-1],analog:[-1,-1,-1,-1,-1,-1,2,5,-1,-1,-1,-1,-1,-1,-1,-1,-1],normalize_fn:ouyaNormalizeFn}]].forEach((function(e){addMapping(e[0],e[1])}));var updateGamepads=function(){var e=navigator.getGamepads();Object.keys(bindings).forEach((function(t){var i=e[t];if(i){var s=null;"standard"!==i.mapping&&(s=remap.get(i.id));var r=bindings[t];Object.keys(r.buttons).forEach((function(e){var n=r.buttons[e],o=e,a=-1;if(!(s&&(o=s.buttons[e],a=s.analog[e],o<0&&a<0))){var h=i.buttons[o]||{};if(s&&a>=0){var l=s.normalize_fn(i.axes[a],-1,+e);h={value:l,pressed:h.pressed||Math.abs(l)>=deadzone}}emit(GAMEPAD_UPDATE,t,"buttons",+e,h),!n.pressed&&h.pressed?triggerKeyEvent(n.keyCode,!0,o+256):n.pressed&&!h.pressed&&triggerKeyEvent(n.keyCode,!1,o+256),n.value=h.value,n.pressed=h.pressed}})),Object.keys(r.axes).forEach((function(e){var n=r.axes[e],o=e;if(!(s&&(o=s.axes[e])<0)){var a=i.axes[o];if(void 0!==a){s&&(a=s.normalize_fn(a,+e,-1));var h=Math.sign(a)||1;if(0!==n[h].keyCode){var l=Math.abs(a)>=deadzone+Math.abs(n[h].threshold);emit(GAMEPAD_UPDATE,t,"axes",+e,a),!n[h].pressed&&l?(n[-h].pressed&&(triggerKeyEvent(n[-h].keyCode,!1,o+256),n[-h].value=0,n[-h].pressed=!1),triggerKeyEvent(n[h].keyCode,!0,o+256)):!n[h].pressed&&!n[-h].pressed||l||triggerKeyEvent(n[h=n[h].pressed?h:-h].keyCode,!1,o+256),n[h].value=a,n[h].pressed=l}}}}))}}))};window.addEventListener("gamepadconnected",(function(e){emit(GAMEPAD_CONNECTED,e.gamepad)}),!1),window.addEventListener("gamepaddisconnected",(function(e){emit(GAMEPAD_DISCONNECTED,e.gamepad)}),!1);var GAMEPAD={AXES:{LX:0,LY:1,RX:2,RY:3,EXTRA_1:4,EXTRA_2:5,EXTRA_3:6,EXTRA_4:7},BUTTONS:{FACE_1:0,FACE_2:1,FACE_3:2,FACE_4:3,L1:4,R1:5,L2:6,R2:7,SELECT:8,BACK:8,START:9,FORWARD:9,L3:10,R3:11,UP:12,DOWN:13,LEFT:14,RIGHT:15,HOME:16,EXTRA_1:17,EXTRA_2:18,EXTRA_3:19,EXTRA_4:20}};function bindGamepad(e,t,i){if(!getBindingKey(i))throw new Error("no action defined for keycode "+i);void 0===updateEventHandler&&"function"==typeof navigator.getGamepads&&(updateEventHandler=on(GAME_BEFORE_UPDATE,updateGamepads)),bindings[e]||(bindings[e]={axes:{},buttons:{}});var s={keyCode:i,value:0,pressed:!1,threshold:t.threshold},r=bindings[e][t.type];if("buttons"===t.type)r[t.code]=s;else if("axes"===t.type){var n=Math.sign(t.threshold)||1;r[t.code]||(r[t.code]={});var o=r[t.code];o[n]=s,o[-n]||(o[-n]={keyCode:0,value:0,pressed:!1,threshold:-n})}}function unbindGamepad(e,t){if(!bindings[e])throw new Error("no bindings for gamepad "+e);bindings[e].buttons[t]={}}function setGamepadDeadzone(e){deadzone=e}var setGamepadMapping=addMapping,preventDefault=!0,input=Object.freeze({__proto__:null,preventDefault,get pointerEventTarget(){return pointerEventTarget},pointer,get throttlingInterval(){return throttlingInterval},globalToLocal,setTouchAction,bindPointer,unbindPointer,registerPointerEvent,releasePointerEvent,releaseAllPointerEvents,get keyBoardEventTarget(){return keyBoardEventTarget},KEY,initKeyboardEvent,isKeyPressed,keyStatus,triggerKeyEvent,bindKey,getBindingKey,unlockKey,unbindKey,GAMEPAD,bindGamepad,unbindGamepad,setGamepadDeadzone,setGamepadMapping});class Renderable extends Rect{constructor(e,t,i,s){super(e,t,i,s),this.isRenderable=!0,this.isKinematic=!0,this.body=void 0,void 0===this.currentTransform&&(this.currentTransform=pool.pull("Matrix2d")),this.currentTransform.identity(),this.GUID=void 0,this.onVisibilityChange=void 0,this.alwaysUpdate=!1,this.updateWhenPaused=!1,this.isPersistent=!1,this.floating=!1,this.anchorPoint instanceof ObservableVector2d?this.anchorPoint.setMuted(.5,.5).setCallback(this.onAnchorUpdate,this):this.anchorPoint=pool.pull("ObservableVector2d",.5,.5,{onUpdate:this.onAnchorUpdate,scope:this}),this.autoTransform=!0,this.alpha=1,this.ancestor=void 0,this.mask=void 0,this.tint=pool.pull("Color",255,255,255,1),this.name="",this.pos instanceof ObservableVector3d?this.pos.setMuted(e,t,0).setCallback(this.updateBoundsPos,this):this.pos=pool.pull("ObservableVector3d",e,t,0,{onUpdate:this.updateBoundsPos,scope:this}),this.isDirty=!1,this._flip={x:!1,y:!1},this._inViewport=!1,this.setOpacity(1)}get inViewport(){return this._inViewport}set inViewport(e){this._inViewport!==e&&(this._inViewport=e,"function"==typeof this.onVisibilityChange&&this.onVisibilityChange.call(this,e))}get isFlippedX(){return!0===this._flip.x}get isFlippedY(){return!0===this._flip.y}getBounds(){return void 0===this._bounds&&(super.getBounds(),this.isFinite()?this._bounds.setMinMax(this.pos.x,this.pos.y,this.pos.x+this.width,this.pos.y+this.height):this._bounds.setMinMax(this.pos.x,this.pos.y,this.width,this.height)),this._bounds}getOpacity(){return this.alpha}setOpacity(e){"number"==typeof e&&(this.alpha=clamp(e,0,1),isNaN(this.alpha)&&(this.alpha=1),this.isDirty=!0)}flipX(e=!0){return this._flip.x=!!e,this.isDirty=!0,this}flipY(e=!0){return this._flip.y=!!e,this.isDirty=!0,this}transform(e){return this.currentTransform.multiply(e),this.updateBoundsPos(this.pos.x,this.pos.y),this.isDirty=!0,this}angleTo(e){var t,i,s=this.getBounds();if(e instanceof Renderable){var r=e.getBounds();t=r.centerX-s.centerX,i=r.centerY-s.centerY}else t=e.x-s.centerX,i=e.y-s.centerY;return Math.atan2(i,t)}distanceTo(e){var t,i,s=this.getBounds();if(e instanceof Renderable){var r=e.getBounds();t=s.centerX-r.centerX,i=s.centerY-r.centerY}else t=s.centerX-e.x,i=s.centerY-e.y;return Math.sqrt(t*t+i*i)}lookAt(e){var t;t=e instanceof Renderable?e.pos:e;var i=this.angleTo(t);return this.rotate(i),this}rotate(e){return isNaN(e)||(this.currentTransform.rotate(e),this.isDirty=!0),this}scale(e,t){return this.currentTransform.scale(e,t),super.scale(e,t),this.isDirty=!0,this}scaleV(e){return this.scale(e.x,e.y),this}update(){return this.isDirty}updateBounds(){return super.updateBounds(),this.updateBoundsPos(this.pos.x,this.pos.y),this.getBounds()}updateBoundsPos(e,t){var i=this.getBounds();i.shift(e,t),void 0!==this.anchorPoint&&i.isFinite()&&i.translate(-this.anchorPoint.x*i.width,-this.anchorPoint.y*i.height),this.ancestor instanceof Container&&!0!==this.floating&&i.translate(this.ancestor.getAbsolutePosition())}getAbsolutePosition(){return void 0===this._absPos&&(this._absPos=pool.pull("Vector2d")),this._absPos.set(this.pos.x,this.pos.y),this.ancestor instanceof Container&&!0!==this.floating&&this._absPos.add(this.ancestor.getAbsolutePosition()),this._absPos}onAnchorUpdate(e,t){this.anchorPoint.setMuted(e,t),this.updateBoundsPos(this.pos.x,this.pos.y)}preDraw(e){var t=this.getBounds(),i=t.width*this.anchorPoint.x,s=t.height*this.anchorPoint.y;if(e.save(),e.setGlobalAlpha(e.globalAlpha()*this.getOpacity()),this._flip.x||this._flip.y){var r=this._flip.x?this.centerX-i:0,n=this._flip.y?this.centerY-s:0;e.translate(r,n),e.scale(this._flip.x?-1:1,this._flip.y?-1:1),e.translate(-r,-n)}void 0!==this.mask&&(e.translate(this.pos.x,this.pos.y),e.setMask(this.mask),e.translate(-this.pos.x,-this.pos.y)),!0!==this.autoTransform||this.currentTransform.isIdentity()||(e.translate(this.pos.x,this.pos.y),e.transform(this.currentTransform),e.translate(-this.pos.x,-this.pos.y)),e.translate(-i,-s),e.setTint(this.tint,this.getOpacity())}draw(){}postDraw(e){e.clearTint(),void 0!==this.mask&&e.clearMask(),e.restore(),this.isDirty=!1}onCollision(){return!1}destroy(){pool.push(this.currentTransform),this.currentTransform=void 0,pool.push(this.anchorPoint),this.anchorPoint=void 0,pool.push(this.pos),this.pos=void 0,void 0!==this._absPos&&(pool.push(this._absPos),this._absPos=void 0),pool.push(this._bounds),this._bounds=void 0,this.onVisibilityChange=void 0,void 0!==this.mask&&(pool.push(this.mask),this.mask=void 0),void 0!==this.tint&&(pool.push(this.tint),this.tint=void 0),this.ancestor=void 0,void 0!==this.body&&(this.body.destroy.apply(this.body,arguments),this.body=void 0),releaseAllPointerEvents(this),this.onDestroyEvent.apply(this,arguments)}onDestroyEvent(){}}class Ellipse{constructor(e,t,i,s){this.pos=new Vector2d,this._bounds=void 0,this.radius=NaN,this.radiusV=new Vector2d,this.radiusSq=new Vector2d,this.ratio=new Vector2d,this.shapeType="Ellipse",this.setShape(e,t,i,s)}onResetEvent(e,t,i,s){this.setShape(e,t,i,s)}setShape(e,t,i,s){var r=i/2,n=s/2;this.pos.set(e,t),this.radius=Math.max(r,n),this.ratio.set(r/this.radius,n/this.radius),this.radiusV.set(this.radius,this.radius).scaleV(this.ratio);var o=this.radius*this.radius;return this.radiusSq.set(o,o).scaleV(this.ratio),this.getBounds().setMinMax(e,t,e+i,e+s),this.getBounds().translate(-this.radiusV.x,-this.radiusV.y),this}rotate(e,t){return this.pos.rotate(e,t),this.getBounds().shift(this.pos),this.getBounds().translate(-this.radiusV.x,-this.radiusV.y),this}scale(e,t){return t=void 0!==t?t:e,this.setShape(this.pos.x,this.pos.y,2*this.radiusV.x*e,2*this.radiusV.y*t)}scaleV(e){return this.scale(e.x,e.y)}transform(){return this}translate(){var e,t;return 2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),this.pos.x+=e,this.pos.y+=t,this.getBounds().translate(e,t),this}contains(){var e,t;return 2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),e-=this.pos.x,t-=this.pos.y,e*e/this.radiusSq.x+t*t/this.radiusSq.y<=1}getBounds(){return void 0===this._bounds&&(this._bounds=pool.pull("Bounds")),this._bounds}clone(){return new Ellipse(this.pos.x,this.pos.y,2*this.radiusV.x,2*this.radiusV.y)}}for(var LEFT_VORNOI_REGION=-1,MIDDLE_VORNOI_REGION=0,RIGHT_VORNOI_REGION=1,T_VECTORS=[],v=0;v<10;v++)T_VECTORS.push(new Vector2d);for(var T_ARRAYS=[],a=0;a<5;a++)T_ARRAYS.push([]);function flattenPointsOn(e,t,i){for(var s=Number.MAX_VALUE,r=-Number.MAX_VALUE,n=e.length,o=0;o<n;o++){var a=e[o].dotProduct(t);a<s&&(s=a),a>r&&(r=a)}i[0]=s,i[1]=r}function isSeparatingAxis(e,t,i,s,r,n){var o=T_ARRAYS.pop(),a=T_ARRAYS.pop(),h=T_VECTORS.pop().copy(t).sub(e),l=h.dotProduct(r);if(flattenPointsOn(i,r,o),flattenPointsOn(s,r,a),a[0]+=l,a[1]+=l,o[0]>a[1]||a[0]>o[1])return T_VECTORS.push(h),T_ARRAYS.push(o),T_ARRAYS.push(a),!0;if(n){var d=0;if(o[0]<a[0])if(n.aInB=!1,o[1]<a[1])d=o[1]-a[0],n.bInA=!1;else{var u=o[1]-a[0],c=a[1]-o[0];d=u<c?u:-c}else if(n.bInA=!1,o[1]>a[1])d=o[0]-a[1],n.aInB=!1;else{var p=o[1]-a[0],g=a[1]-o[0];d=p<g?p:-g}var f=Math.abs(d);f<n.overlap&&(n.overlap=f,n.overlapN.copy(r),d<0&&n.overlapN.negateSelf())}return T_VECTORS.push(h),T_ARRAYS.push(o),T_ARRAYS.push(a),!1}function vornoiRegion(e,t){var i=e.length2(),s=t.dotProduct(e);return s<0?LEFT_VORNOI_REGION:s>i?RIGHT_VORNOI_REGION:MIDDLE_VORNOI_REGION}function testPolygonPolygon(e,t,i,s,r){var n,o=t.points,a=t.normals,h=a.length,l=s.points,d=s.normals,u=d.length,c=T_VECTORS.pop().copy(e.pos).add(e.ancestor.getAbsolutePosition()).add(t.pos),p=T_VECTORS.pop().copy(i.pos).add(i.ancestor.getAbsolutePosition()).add(s.pos);for(n=0;n<h;n++)if(isSeparatingAxis(c,p,o,l,a[n],r))return T_VECTORS.push(c),T_VECTORS.push(p),!1;for(n=0;n<u;n++)if(isSeparatingAxis(c,p,o,l,d[n],r))return T_VECTORS.push(c),T_VECTORS.push(p),!1;return r&&(r.a=e,r.b=i,r.overlapV.copy(r.overlapN).scale(r.overlap)),T_VECTORS.push(c),T_VECTORS.push(p),!0}function testEllipseEllipse(e,t,i,s,r){var n=T_VECTORS.pop().copy(i.pos).add(i.ancestor.getAbsolutePosition()).add(s.pos).sub(e.pos).add(e.ancestor.getAbsolutePosition()).sub(t.pos),o=t.radius,a=s.radius,h=o+a,l=h*h,d=n.length2();if(d>l)return T_VECTORS.push(n),!1;if(r){var u=Math.sqrt(d);r.a=e,r.b=i,r.overlap=h-u,r.overlapN.copy(n.normalize()),r.overlapV.copy(n).scale(r.overlap),r.aInB=o<=a&&u<=a-o,r.bInA=a<=o&&u<=o-a}return T_VECTORS.push(n),!0}function testPolygonEllipse(e,t,i,s,r){for(var n=T_VECTORS.pop().copy(i.pos).add(i.ancestor.getAbsolutePosition()).add(s.pos).sub(e.pos).add(e.ancestor.getAbsolutePosition()).sub(t.pos),o=s.radius,a=o*o,h=t.points,l=t.edges,d=l.length,u=T_VECTORS.pop(),c=T_VECTORS.pop(),p=T_VECTORS.pop(),g=0,f=0;f<d;f++){var m=f===d-1?0:f+1,v=0===f?d-1:f-1,_=0,y=null;u.copy(l[f]),p.copy(n).sub(h[f]),r&&p.length2()>a&&(r.aInB=!1);var x=vornoiRegion(u,p),w=!0;if(x===LEFT_VORNOI_REGION){var T=null;if(d>1&&(u.copy(l[v]),(x=vornoiRegion(u,T=T_VECTORS.pop().copy(n).sub(h[v])))!==RIGHT_VORNOI_REGION&&(w=!1)),w){if((g=p.length())>o)return T_VECTORS.push(n),T_VECTORS.push(u),T_VECTORS.push(c),T_VECTORS.push(p),T&&T_VECTORS.push(T),!1;r&&(r.bInA=!1,y=p.normalize(),_=o-g)}T&&T_VECTORS.push(T)}else if(x===RIGHT_VORNOI_REGION){if(d>1&&(u.copy(l[m]),p.copy(n).sub(h[m]),(x=vornoiRegion(u,p))!==LEFT_VORNOI_REGION&&(w=!1)),w){if((g=p.length())>o)return T_VECTORS.push(n),T_VECTORS.push(u),T_VECTORS.push(c),T_VECTORS.push(p),!1;r&&(r.bInA=!1,y=p.normalize(),_=o-g)}}else{c.copy(t.normals[f]),g=p.dotProduct(c);var b=Math.abs(g);if((1===d||g>0)&&b>o)return T_VECTORS.push(n),T_VECTORS.push(u),T_VECTORS.push(c),T_VECTORS.push(p),!1;r&&(y=c,_=o-g,(g>=0||_<2*o)&&(r.bInA=!1))}y&&r&&Math.abs(_)<Math.abs(r.overlap)&&(r.overlap=_,r.overlapN.copy(y))}return r&&(r.a=e,r.b=i,r.overlapV.copy(r.overlapN).scale(r.overlap)),T_VECTORS.push(n),T_VECTORS.push(u),T_VECTORS.push(c),T_VECTORS.push(p),!0}function testEllipsePolygon(e,t,i,s,r){var n=this.testPolygonEllipse(i,s,e,t,r);if(n&&r){var o=r.a,a=r.aInB;r.overlapN.negateSelf(),r.overlapV.negateSelf(),r.a=r.b,r.b=o,r.aInB=r.bInA,r.bInA=a}return n}var SAT=Object.freeze({__proto__:null,testPolygonPolygon,testEllipseEllipse,testPolygonEllipse,testEllipsePolygon}),dummyObj={pos:new Vector2d(0,0),ancestor:{_absPos:new Vector2d(0,0),getAbsolutePosition:function(){return this._absPos}}};function shouldCollide(e,t){return!0!==e.isKinematic&&!0!==t.isKinematic&&e.body&&t.body&&0!=(e.body.collisionMask&t.body.collisionType)&&0!=(e.body.collisionType&t.body.collisionMask)}class ResponseObject{constructor(){return this.a=null,this.b=null,this.overlapN=new Vector2d,this.overlapV=new Vector2d,this.aInB=!0,this.bInA=!0,this.indexShapeA=-1,this.indexShapeB=-1,this.overlap=Number.MAX_VALUE,this}clear(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this.indexShapeA=-1,this.indexShapeB=-1,this}}var globalResponse=new ResponseObject;function collisionCheck(e,t=globalResponse){for(var i,s=0,r=world.broadphase.retrieve(e),n=r.length;i=r[--n];)if(i!==e&&shouldCollide(e,i)&&e.body.getBounds().overlaps(i.body.getBounds())){var o=e.body.shapes.length,a=i.body.shapes.length;if(0===o||0===a)continue;var h=0;do{var l=e.body.getShape(h),d=0;do{var u=i.body.getShape(d);!0===SAT["test"+l.shapeType+u.shapeType].call(this,e,l,i,u,t.clear())&&(s++,t.indexShapeA=h,t.indexShapeB=d,e.onCollision&&!1!==e.onCollision(t,i)&&e.body.respondToCollision.call(e.body,t),i.onCollision&&!1!==i.onCollision(t,e)&&i.body.respondToCollision.call(i.body,t)),d++}while(d<a);h++}while(h<o)}return s>0}function rayCast(e,t=[]){for(var i,s=0,r=world.broadphase.retrieve(e),n=r.length;i=r[--n];)if(i.body&&e.getBounds().overlaps(i.getBounds())){var o=i.body.shapes.length;if(0===i.body.shapes.length)continue;var a=e,h=0;do{var l=i.body.getShape(h);SAT["test"+a.shapeType+l.shapeType].call(this,dummyObj,a,i,l)&&(t[s]=i,s++),h++}while(h<o)}return t.length=s,t}var collision={maxChildren:8,maxDepth:4,types:{NO_OBJECT:0,PLAYER_OBJECT:1,NPC_OBJECT:2,ENEMY_OBJECT:4,COLLECTABLE_OBJECT:8,ACTION_OBJECT:16,PROJECTILE_OBJECT:32,WORLD_SHAPE:64,USER:128,ALL_OBJECT:4294967295},response:globalResponse,rayCast:(e,t)=>rayCast(e,t)};class Body{constructor(e,t,i){if(this.ancestor=e,void 0===this.bounds&&(this.bounds=new Bounds$1),void 0===this.shapes&&(this.shapes=[]),this.collisionMask=collision.types.ALL_OBJECT,this.collisionType=collision.types.ENEMY_OBJECT,void 0===this.vel&&(this.vel=new Vector2d),this.vel.set(0,0),void 0===this.force&&(this.force=new Vector2d),this.force.set(0,0),void 0===this.friction&&(this.friction=new Vector2d),this.friction.set(0,0),this.bounce=0,this.mass=1,void 0===this.maxVel&&(this.maxVel=new Vector2d),this.maxVel.set(490,490),this.isStatic=!1,this.gravityScale=1,this.ignoreGravity=!1,this.falling=!1,this.jumping=!1,"function"==typeof i&&(this.onBodyUpdate=i),this.bounds.clear(),void 0!==t)if(Array.isArray(t))for(var s=0;s<t.length;s++)this.addShape(t[s]);else this.addShape(t);this.ancestor.isKinematic=!1}setStatic(e=!0){this.isStatic=!0===e}addShape(e){if(e instanceof Rect||e instanceof Bounds$1){var t=e.toPolygon();this.shapes.push(t),this.bounds.add(t.points),this.bounds.translate(t.pos)}else e instanceof Ellipse?(this.shapes.includes(e)||this.shapes.push(e),this.bounds.addBounds(e.getBounds()),this.bounds.translate(e.getBounds().x,e.getBounds().y)):e instanceof Polygon?(this.shapes.includes(e)||this.shapes.push(e),this.bounds.add(e.points),this.bounds.translate(e.pos)):this.fromJSON(e);return"function"==typeof this.onBodyUpdate&&this.onBodyUpdate(this),this.shapes.length}setVertices(e,t=0,i=!0){var s=this.getShape(t);s instanceof Polygon?s.setShape(0,0,e):this.shapes[t]=new Polygon(0,0,e),this.bounds.add(this.shapes[t].points,i),"function"==typeof this.onBodyUpdate&&this.onBodyUpdate(this)}addVertices(e,t=0){this.setVertices(e,t,!1)}fromJSON(e,t){var i=e;if(void 0!==t&&(i=e[t]),void 0===i)throw new Error("Identifier ("+t+") undefined for the given JSON object)");if(i.length){for(var s=0;s<i.length;s++)this.addVertices(i[s].shape,s);this.mass=i[0].density||0,this.friction.set(i[0].friction||0,i[0].friction||0),this.bounce=i[0].bounce||0}return i.length}getShape(e){return this.shapes[e||0]}getBounds(){return this.bounds}removeShape(e){this.bounds.clear(),remove(this.shapes,e);for(var t=0;t<this.shapes.length;t++)this.addShape(this.shapes[t]);return this.shapes.length}removeShapeAt(e){return this.removeShape(this.getShape(e))}setCollisionMask(e=collision.types.ALL_OBJECT){this.collisionMask=e}setCollisionType(e){if(void 0!==e){if(void 0===collision.types[e])throw new Error("Invalid value for the collisionType property");this.collisionType=collision.types[e]}}respondToCollision(e){var t=e.overlapV;if(this.ancestor.pos.sub(t),0!==t.x&&(this.vel.x=~~(.5+this.vel.x-t.x)||0,this.bounce>0&&(this.vel.x*=-this.bounce)),0!==t.y){this.vel.y=~~(.5+this.vel.y-t.y)||0,this.bounce>0&&(this.vel.y*=-this.bounce);var i=Math.sign(world.gravity.y*this.gravityScale)||1;this.falling=t.y>=i,this.jumping=t.y<=-i}}forEach(e,t){var i=this,s=0,r=this.shapes,n=r.length;if("function"!=typeof e)throw new Error(e+" is not a function");for(arguments.length>1&&(i=t);s<n;)e.call(i,r[s],s,r),s++}contains(){var e,t;if(2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),this.getBounds().contains(e,t))for(var i,s=this.shapes.length;s--,i=this.shapes[s];)if(i.contains(e,t))return!0;return!1}rotate(e,t=this.getBounds().center){return this.bounds.clear(),this.forEach((i=>{i.rotate(e,t),this.bounds.addBounds(i.getBounds()),i instanceof Ellipse?this.bounds.translate(i.getBounds().x,i.getBounds().y):this.bounds.translate(i.pos)})),this}setMaxVelocity(e,t){this.maxVel.x=e,this.maxVel.y=t}setFriction(e=0,t=0){this.friction.x=e,this.friction.y=t}computeVelocity(){var e=timer$1.tick;if(!this.ignoreGravity){var t=world.gravity;this.vel.x+=t.x*this.gravityScale*e,this.vel.y+=t.y*this.gravityScale*e,this.falling=this.vel.y*Math.sign(t.y*this.gravityScale)>0,this.jumping=!this.falling&&this.jumping}if(0!==this.force.x&&(this.vel.x+=this.force.x*e),0!==this.force.y&&(this.vel.y+=this.force.y*e),this.friction.x>0){var i=this.friction.x*e,s=this.vel.x+i,r=this.vel.x-i;this.vel.x=s<0?s:r>0?r:0}if(this.friction.y>0){var n=this.friction.y*e,o=this.vel.y+n,a=this.vel.y-n;this.vel.y=o<0?o:a>0?a:0}0!==this.vel.y&&(this.vel.y=clamp(this.vel.y,-this.maxVel.y,this.maxVel.y)),0!==this.vel.x&&(this.vel.x=clamp(this.vel.x,-this.maxVel.x,this.maxVel.x))}update(e){return this.computeVelocity(e),this.ancestor.pos.add(this.vel),0!==this.vel.x||0!==this.vel.y}destroy(){this.onBodyUpdate=void 0,this.ancestor=void 0,this.bounds=void 0,this.setStatic(!1),this.shapes.length=0}}var deferredRemove=function(e,t){this.removeChildNow(e,t)},globalFloatingCounter=0;class Container extends Renderable{constructor(e=0,t=0,i=viewport.width,s=viewport.height,r=!1){super(e,t,i,s),this.pendingSort=null,this.root=r,this.children=void 0,this.sortOn=sortOn,this.autoSort=!0,this.autoDepth=!0,this.clipping=!1,this.onChildChange=function(){},this.enableChildBoundsUpdate=!1,this.drawCount=0,this.autoTransform=!0,this.isKinematic=!1,this.anchorPoint.set(0,0),!0===this.root&&on(CANVAS_ONRESIZE,this.updateBounds.bind(this,!0))}reset(){this.pendingSort&&(clearTimeout(this.pendingSort),this.pendingSort=null);for(var e,t=this.getChildren(),i=t.length;i>=0;e=t[--i])e&&!0!==e.isPersistent&&this.removeChildNow(e);void 0!==this.currentTransform&&this.currentTransform.identity()}addChild(e,t){return e.ancestor instanceof Container?e.ancestor.removeChildNow(e):e.isRenderable&&(e.GUID=utils.createGUID(e.id)),e.ancestor=this,this.getChildren().push(e),void 0!==e.pos&&("number"==typeof t?e.pos.z=t:!0===this.autoDepth&&(e.pos.z=this.getChildren().length)),!0===this.autoSort&&this.sort(),"function"==typeof e.onActivateEvent&&this.isAttachedToRoot()&&e.onActivateEvent(),!0===this.isAttachedToRoot()&&repaint(),this.enableChildBoundsUpdate&&this.updateBounds(!0),e.body instanceof Body&&world.addBody(e.body),this.onChildChange.call(this,this.getChildren().length-1),e}addChildAt(e,t){if(t>=0&&t<this.getChildren().length)return e.ancestor instanceof Container?e.ancestor.removeChildNow(e):e.isRenderable&&(e.GUID=utils.createGUID()),e.ancestor=this,this.getChildren().splice(t,0,e),"function"==typeof e.onActivateEvent&&this.isAttachedToRoot()&&e.onActivateEvent(),!0===this.isAttachedToRoot()&&repaint(),this.enableChildBoundsUpdate&&this.updateBounds(!0),e.body instanceof Body&&world.addBody(e.body),this.onChildChange.call(this,t),e;throw new Error("Index ("+t+") Out Of Bounds for addChildAt()")}forEach(e,t){var i=this,s=0,r=this.getChildren(),n=r.length;if("function"!=typeof e)throw new Error(e+" is not a function");for(arguments.length>1&&(i=t);s<n;)e.call(i,r[s],s,r),s++}swapChildren(e,t){var i=this.getChildIndex(e),s=this.getChildIndex(t);if(-1===i||-1===s)throw new Error(e+" Both the supplied childs must be a child of the caller "+this);var r=e.pos.z;e.pos.z=t.pos.z,t.pos.z=r,this.getChildren()[i]=t,this.getChildren()[s]=e}getChildAt(e){if(e>=0&&e<this.getChildren().length)return this.getChildren()[e];throw new Error("Index ("+e+") Out Of Bounds for getChildAt()")}getChildIndex(e){return this.getChildren().indexOf(e)}getNextChild(e){var t=this.getChildren().indexOf(e)-1;if(t>=0&&t<this.getChildren().length)return this.getChildAt(t)}hasChild(e){return this===e.ancestor}getChildByProp(e,t){var i=[];return this.forEach((s=>{!function(e,s){var r=e[s];t instanceof RegExp&&"string"==typeof r?t.test(r)&&i.push(e):r===t&&i.push(e)}(s,e),s instanceof Container&&(i=i.concat(s.getChildByProp(e,t)))})),i}getChildByType(e){var t=[];return this.forEach((i=>{i instanceof e&&t.push(i),i instanceof Container&&(t=t.concat(i.getChildByType(e)))})),t}getChildByName(e){return this.getChildByProp("name",e)}getChildByGUID(e){var t=this.getChildByProp("GUID",e);return t.length>0?t[0]:null}getChildren(){return void 0===this.children&&(this.children=[]),this.children}updateBounds(e=!1){super.updateBounds();var t=this.getBounds();return!0!==e&&!0!==this.enableChildBoundsUpdate||this.forEach((e=>{e.isRenderable&&e.getBounds().isFinite()&&t.addBounds(e.getBounds())})),t}isAttachedToRoot(){if(!0===this.root)return!0;for(var e=this.ancestor;e;){if(!0===e.root)return!0;e=e.ancestor}return!1}updateBoundsPos(e,t){return super.updateBoundsPos(e,t),this.forEach((i=>{i.isRenderable&&i.updateBoundsPos(i.pos.x+e-this.pos.x,i.pos.y+t-this.pos.y)})),this.getBounds()}onActivateEvent(){this.forEach((e=>{"function"==typeof e.onActivateEvent&&e.onActivateEvent()}))}removeChild(e,t){if(!this.hasChild(e))throw new Error("Child is not mine.");utils.function.defer(deferredRemove,this,e,t)}removeChildNow(e,t){if(this.hasChild(e)&&this.getChildIndex(e)>=0){"function"==typeof e.onDeactivateEvent&&e.onDeactivateEvent(),e.body instanceof Body&&world.removeBody(e.body),t||!1===pool.push(e,!1)&&"function"==typeof e.destroy&&e.destroy();var i=this.getChildIndex(e);i>=0&&(this.getChildren().splice(i,1),e.ancestor=void 0),!0===this.isAttachedToRoot()&&repaint(),this.enableChildBoundsUpdate&&this.updateBounds(!0),this.onChildChange.call(this,i)}}setChildsProperty(e,t,i){this.forEach((s=>{!0===i&&s instanceof Container&&s.setChildsProperty(e,t,i),s[e]=t}))}moveUp(e){var t=this.getChildIndex(e);t-1>=0&&this.swapChildren(e,this.getChildAt(t-1))}moveDown(e){var t=this.getChildIndex(e);t>=0&&t+1<this.getChildren().length&&this.swapChildren(e,this.getChildAt(t+1))}moveToTop(e){var t=this.getChildIndex(e);if(t>0){var i=this.getChildren();i.splice(0,0,i.splice(t,1)[0]),e.pos.z=i[1].pos.z+1}}moveToBottom(e){var t=this.getChildIndex(e),i=this.getChildren();t>=0&&t<i.length-1&&(i.splice(i.length-1,0,i.splice(t,1)[0]),e.pos.z=i[i.length-2].pos.z-1)}sort(e){this.pendingSort||(!0===e&&this.forEach((t=>{t instanceof Container&&t.sort(e)})),this.pendingSort=utils.function.defer((function(){this.getChildren().sort(this["_sort"+this.sortOn.toUpperCase()]),this.pendingSort=null,repaint()}),this))}onDeactivateEvent(){this.forEach((e=>{"function"==typeof e.onDeactivateEvent&&e.onDeactivateEvent()}))}_sortZ(e,t){return t.pos&&e.pos?t.pos.z-e.pos.z:e.pos?-1/0:1/0}_sortReverseZ(e,t){return e.pos&&t.pos?e.pos.z-t.pos.z:e.pos?1/0:-1/0}_sortX(e,t){return t.pos&&e.pos?t.pos.z-e.pos.z||t.pos.x-e.pos.x:e.pos?-1/0:1/0}_sortY(e,t){return t.pos&&e.pos?t.pos.z-e.pos.z||t.pos.y-e.pos.y:e.pos?-1/0:1/0}destroy(){this.reset(),super.destroy(arguments)}update(e){for(var t,i=!1,s=state.isPaused(),r=this.getChildren(),n=r.length;n--,t=r[n];)s&&!t.updateWhenPaused||(t.isRenderable?((i=globalFloatingCounter>0||t.floating)&&globalFloatingCounter++,t.inViewport=!1,state.current().cameras.forEach((function(e){e.isVisible(t,i)&&(t.inViewport=!0)})),this.isDirty|=(t.inViewport||t.alwaysUpdate)&&t.update(e),globalFloatingCounter>0&&globalFloatingCounter--):this.isDirty|=t.update(e));return super.update(e)}draw(e,t){var i=!1,s=this.getBounds();this.drawCount=0,!1===this.root&&!0===this.clipping&&!0===s.isFinite()&&e.clipRect(s.left,s.top,s.width,s.height),e.translate(this.pos.x,this.pos.y);for(var r,n=this.getChildren(),o=n.length;r=n[--o];)r.isRenderable&&(i=!0===r.floating,(r.inViewport||i)&&(i&&(e.save(),e.resetTransform()),r.preDraw(e),r.draw(e,t),r.postDraw(e),i&&e.restore(),this.drawCount++))}}var QT_ARRAY=[];function QT_ARRAY_POP(e,t=4,i=4,s=0){if(QT_ARRAY.length>0){var r=QT_ARRAY.pop();return r.bounds=e,r.max_objects=t,r.max_levels=i,r.level=s,r}return new QuadTree(e,t,i,s)}function QT_ARRAY_PUSH(e){QT_ARRAY.push(e)}var QT_VECTOR=new Vector2d;class QuadTree{constructor(e,t=4,i=4,s=0){this.max_objects=t,this.max_levels=i,this.level=s,this.bounds=e,this.objects=[],this.nodes=[]}split(){var e=this.level+1,t=this.bounds.width/2,i=this.bounds.height/2,s=this.bounds.left,r=this.bounds.top;this.nodes[0]=QT_ARRAY_POP({left:s+t,top:r,width:t,height:i},this.max_objects,this.max_levels,e),this.nodes[1]=QT_ARRAY_POP({left:s,top:r,width:t,height:i},this.max_objects,this.max_levels,e),this.nodes[2]=QT_ARRAY_POP({left:s,top:r+i,width:t,height:i},this.max_objects,this.max_levels,e),this.nodes[3]=QT_ARRAY_POP({left:s+t,top:r+i,width:t,height:i},this.max_objects,this.max_levels,e)}getIndex(e){var t,i=-1,s=(t=e.floating||e.ancestor&&e.ancestor.floating?viewport.localToWorld(e.left,e.top,QT_VECTOR):QT_VECTOR.set(e.left,e.top)).x,r=t.y,n=e.width,o=e.height,a=this.bounds.left+this.bounds.width/2,h=this.bounds.top+this.bounds.height/2,l=r<h&&r+o<h,d=r>h;return s<a&&s+n<a?l?i=1:d&&(i=2):s>a&&(l?i=0:d&&(i=3)),i}insertContainer(e){for(var t,i=e.children.length;i--,t=e.children[i];)!0!==t.isKinematic&&(t instanceof Container?("rootContainer"!==t.name&&this.insert(t),this.insertContainer(t)):"function"==typeof t.getBounds&&this.insert(t))}insert(e){var t=-1;if(this.nodes.length>0&&-1!==(t=this.getIndex(e)))this.nodes[t].insert(e);else if(this.objects.push(e),this.objects.length>this.max_objects&&this.level<this.max_levels){0===this.nodes.length&&this.split();for(var i=0;i<this.objects.length;)-1!==(t=this.getIndex(this.objects[i]))?this.nodes[t].insert(this.objects.splice(i,1)[0]):i+=1}}retrieve(e,t){var i=this.objects;if(this.nodes.length>0){var s=this.getIndex(e);if(-1!==s)i=i.concat(this.nodes[s].retrieve(e));else for(var r=0;r<this.nodes.length;r+=1)i=i.concat(this.nodes[r].retrieve(e))}return"function"==typeof t&&i.sort(t),i}remove(e){var t=!1;if(void 0===e.getBounds)return!1;if(this.nodes.length>0){var i=this.getIndex(e);-1!==i&&(t=remove(this.nodes[i],e))&&this.nodes[i].isPrunable()&&this.nodes.splice(i,1)}return!1===t&&-1!==this.objects.indexOf(e)&&(remove(this.objects,e),t=!0),t}isPrunable(){return!(this.hasChildren()||this.objects.length>0)}hasChildren(){for(var e=0;e<this.nodes.length;e+=1){var t=this.nodes[e];if(t.length>0||t.objects.length>0)return!0}return!1}clear(e){this.objects.length=0;for(var t=0;t<this.nodes.length;t++)this.nodes[t].clear(),QT_ARRAY_PUSH(this.nodes[t]);this.nodes.length=0,void 0!==e&&this.bounds.setMinMax(e.min.x,e.min.y,e.max.x,e.max.y)}}class World extends Container{constructor(e=0,t=0,i=1/0,s=1/0){super(e,t,i,s,!0),this.name="rootContainer",this.anchorPoint.set(0,0),this.fps=60,this.gravity=new Vector2d(0,.98),this.preRender=!1,this.bodies=new Set,this.broadphase=new QuadTree(this.getBounds().clone(),collision.maxChildren,collision.maxDepth),on(GAME_RESET,this.reset,this),on(LEVEL_LOADED,(()=>{this.broadphase.clear(this.getBounds())}))}reset(){this.broadphase.clear(),this.anchorPoint.set(0,0),super.reset(),this.bodies.clear()}addBody(e){return this.bodies.add(e),this}removeBody(e){return this.bodies.delete(e),this}update(e){var t=state.isPaused();return this.broadphase.clear(),this.broadphase.insertContainer(this),this.bodies.forEach((i=>{if(!i.isStatic){var s=i.ancestor;t&&!s.updateWhenPaused||!s.inViewport&&!s.alwaysUpdate||(!0===i.update(e)&&(s.isDirty=!0),collisionCheck(s))}})),super.update(e)}}var isDirty=!0,isAlwaysDirty=!1,frameCounter=0,frameRate=1,accumulator=0,accumulatorMax=0,accumulatorUpdateDelta=0,stepSize=1e3/60,updateDelta=0,lastUpdateStart=null,updateAverageDelta=0;let viewport,world;on(BOOT,(()=>{world=new World,emit(GAME_INIT)}));let mergeGroup=!0,sortOn="z",lastUpdate=window.performance.now();function onLevelLoaded(){}function reset(){var e=state.current();void 0!==e&&(viewport=e.cameras.get("default")),emit(GAME_RESET),updateFrameRate()}function updateFrameRate(){frameCounter=0,frameRate=~~(.5+60/timer$1.maxfps),stepSize=1e3/world.fps,accumulator=0,accumulatorMax=10*stepSize,isAlwaysDirty=timer$1.maxfps>world.fps}function getParentContainer(e){return e.ancestor}function repaint(){isDirty=!0}function update$1(e,t){if(++frameCounter%frameRate==0){for(frameCounter=0,emit(GAME_BEFORE_UPDATE,e),accumulator+=timer$1.getDelta(),accumulator=Math.min(accumulator,accumulatorMax),updateDelta=timer$1.interpolation?timer$1.getDelta():stepSize,accumulatorUpdateDelta=timer$1.interpolation?updateDelta:Math.max(updateDelta,updateAverageDelta);accumulator>=accumulatorUpdateDelta||timer$1.interpolation;)if(lastUpdateStart=window.performance.now(),!0!==state.isPaused()&&emit(GAME_UPDATE,e),isDirty=t.update(updateDelta)||isDirty,lastUpdate=window.performance.now(),updateAverageDelta=lastUpdate-lastUpdateStart,accumulator-=accumulatorUpdateDelta,timer$1.interpolation){accumulator=0;break}emit(GAME_AFTER_UPDATE,lastUpdate)}}function draw(e){!0===renderer.isContextValid&&(isDirty||isAlwaysDirty)&&(emit(GAME_BEFORE_DRAW,window.performance.now()),renderer.clear(),e.draw(renderer),isDirty=!1,renderer.flush(),emit(GAME_AFTER_DRAW,window.performance.now()))}var game=Object.freeze({__proto__:null,get viewport(){return viewport},get world(){return world},mergeGroup,sortOn,get lastUpdate(){return lastUpdate},onLevelLoaded,reset,updateFrameRate,getParentContainer,repaint,update:update$1,draw}),MIN=Math.min,MAX=Math.max,targetV=new Vector2d,default_camera;class Camera2d extends Renderable{constructor(e,t,i,s){super(e,t,i-e,s-t),this.AXIS={NONE:0,HORIZONTAL:1,VERTICAL:2,BOTH:3},this.bounds=pool.pull("Bounds"),this.smoothFollow=!0,this.damping=1,this.near=-1e3,this.far=1e3,this.projectionMatrix=new Matrix3d,this.invCurrentTransform=new Matrix2d,this.offset=new Vector2d,this.target=null,this.follow_axis=this.AXIS.NONE,this._shake={intensity:0,duration:0,axis:this.AXIS.BOTH,onComplete:null},this._fadeOut={color:null,tween:null},this._fadeIn={color:null,tween:null},this.name="default",this.setDeadzone(this.width/6,this.height/6),this.anchorPoint.set(0,0),this.isKinematic=!1,this.bounds.setMinMax(e,t,i,s),this._updateProjectionMatrix(),on(GAME_RESET,this.reset,this),on(CANVAS_ONRESIZE,this.resize,this)}_updateProjectionMatrix(){this.projectionMatrix.ortho(0,this.width,this.height,0,this.near,this.far)}_followH(e){var t=this.pos.x;return e.x-this.pos.x>this.deadzone.right?t=MIN(e.x-this.deadzone.right,this.bounds.width-this.width):e.x-this.pos.x<this.deadzone.pos.x&&(t=MAX(e.x-this.deadzone.pos.x,this.bounds.left)),t}_followV(e){var t=this.pos.y;return e.y-this.pos.y>this.deadzone.bottom?t=MIN(e.y-this.deadzone.bottom,this.bounds.height-this.height):e.y-this.pos.y<this.deadzone.pos.y&&(t=MAX(e.y-this.deadzone.pos.y,this.bounds.top)),t}reset(e=0,t=0){this.pos.x=e,this.pos.y=t,this.unfollow(),this.smoothFollow=!0,this.damping=1,this.currentTransform.identity(),this.invCurrentTransform.identity().invert(),this._updateProjectionMatrix()}setDeadzone(e,t){void 0===this.deadzone&&(this.deadzone=new Rect(0,0,0,0)),this.deadzone.pos.set(~~((this.width-e)/2),~~((this.height-t)/2-.25*t)),this.deadzone.resize(e,t),this.smoothFollow=!1,this.updateTarget(),this.smoothFollow=!0}resize(e,t){return super.resize(e,t),this.smoothFollow=!1,this.setBounds(0,0,e,t),this.setDeadzone(e/6,t/6),this.update(),this.smoothFollow=!0,this._updateProjectionMatrix(),emit(VIEWPORT_ONRESIZE,this.width,this.height),this}setBounds(e,t,i,s){this.smoothFollow=!1,this.bounds.setMinMax(e,t,i+e,s+t),this.moveTo(this.pos.x,this.pos.y),this.update(),this.smoothFollow=!0}follow(e,t,i){if(e instanceof Renderable)this.target=e.pos;else{if(!(e instanceof Vector2d||e instanceof Vector3d||e instanceof ObservableVector2d||e instanceof ObservableVector3d))throw new Error("invalid target for me.Camera2d.follow");this.target=e}this.follow_axis=void 0===t?this.AXIS.BOTH:t,this.smoothFollow=!1,this.damping="number"!=typeof i?1:clamp(i,0,1),this.updateTarget(),this.smoothFollow=!0}unfollow(){this.target=null,this.follow_axis=this.AXIS.NONE}move(e,t){this.moveTo(this.pos.x+e,this.pos.y+t)}moveTo(e,t){var i=this.pos.x,s=this.pos.y;this.pos.x=clamp(e,this.bounds.left,this.bounds.width),this.pos.y=clamp(t,this.bounds.top,this.bounds.height),i===this.pos.x&&s===this.pos.y||emit(VIEWPORT_ONCHANGE,this.pos)}updateTarget(){if(this.target){switch(targetV.setV(this.pos),this.follow_axis){case this.AXIS.NONE:break;case this.AXIS.HORIZONTAL:targetV.x=this._followH(this.target);break;case this.AXIS.VERTICAL:targetV.y=this._followV(this.target);break;case this.AXIS.BOTH:targetV.x=this._followH(this.target),targetV.y=this._followV(this.target)}if(!this.pos.equals(targetV)){if(!0===this.smoothFollow&&this.damping<1){if(toBeCloseTo(targetV.x,this.pos.x,2)&&toBeCloseTo(targetV.y,this.pos.y,2))return this.pos.setV(targetV),!1;this.pos.lerp(targetV,this.damping)}else this.pos.setV(targetV);return!0}}return!1}update(e){var t=this.updateTarget(e);return this._shake.duration>0&&(this._shake.duration-=e,this._shake.duration<=0?(this._shake.duration=0,this.offset.setZero(),"function"==typeof this._shake.onComplete&&this._shake.onComplete()):(this._shake.axis!==this.AXIS.BOTH&&this._shake.axis!==this.AXIS.HORIZONTAL||(this.offset.x=(Math.random()-.5)*this._shake.intensity),this._shake.axis!==this.AXIS.BOTH&&this._shake.axis!==this.AXIS.VERTICAL||(this.offset.y=(Math.random()-.5)*this._shake.intensity)),t=!0),!0===t&&emit(VIEWPORT_ONCHANGE,this.pos),null==this._fadeIn.tween&&null==this._fadeOut.tween||(t=!0),this.currentTransform.isIdentity()?this.invCurrentTransform.identity():this.invCurrentTransform.copy(this.currentTransform).invert(),t}shake(e,t,i,s,r){0!==this._shake.duration&&!0!==r||(this._shake.intensity=e,this._shake.duration=t,this._shake.axis=i||this.AXIS.BOTH,this._shake.onComplete="function"==typeof s?s:void 0)}fadeOut(e,t=1e3,i){this._fadeOut.color=pool.pull("Color").copy(e),this._fadeOut.tween=pool.pull("Tween",this._fadeOut.color).to({alpha:0},t).onComplete(i||null),this._fadeOut.tween.isPersistent=!0,this._fadeOut.tween.start()}fadeIn(e,t=1e3,i){this._fadeIn.color=pool.pull("Color").copy(e);var s=this._fadeIn.color.alpha;this._fadeIn.color.alpha=0,this._fadeIn.tween=pool.pull("Tween",this._fadeIn.color).to({alpha:s},t).onComplete(i||null),this._fadeIn.tween.isPersistent=!0,this._fadeIn.tween.start()}getWidth(){return this.width}getHeight(){return this.height}focusOn(e){var t=e.getBounds();this.moveTo(e.pos.x+t.left+t.width/2,e.pos.y+t.top+t.height/2)}isVisible(e,t=e.floating){return!0===t||!0===e.floating?renderer.overlaps(e.getBounds()):e.getBounds().overlaps(this)}localToWorld(e,t,i){return(i=i||new Vector2d).set(e,t).add(this.pos).sub(world.pos),this.currentTransform.isIdentity()||this.invCurrentTransform.apply(i),i}worldToLocal(e,t,i){return(i=i||new Vector2d).set(e,t),this.currentTransform.isIdentity()||this.currentTransform.apply(i),i.sub(this.pos).add(world.pos)}drawFX(e){this._fadeIn.tween&&(e.save(),e.resetTransform(),e.setColor(this._fadeIn.color),e.fillRect(0,0,this.width,this.height),e.restore(),1===this._fadeIn.color.alpha&&(this._fadeIn.tween=null,pool.push(this._fadeIn.color),this._fadeIn.color=null)),this._fadeOut.tween&&(e.save(),e.resetTransform(),e.setColor(this._fadeOut.color),e.fillRect(0,0,this.width,this.height),e.restore(),0===this._fadeOut.color.alpha&&(this._fadeOut.tween=null,pool.push(this._fadeOut.color),this._fadeOut.color=null))}draw(e,t){var i=this.pos.x+this.offset.x,s=this.pos.y+this.offset.y;t.currentTransform.translate(-i,-s),e.setProjection(this.projectionMatrix),e.clipRect(0,0,this.width,this.height),this.preDraw(e),t.preDraw(e),t.draw(e,this),this.drawFX(e),t.postDraw(e),this.postDraw(e),t.currentTransform.translate(i,s)}}var default_settings={cameras:[]};class Stage{constructor(e){this.cameras=new Map,this.settings=Object.assign(default_settings,e||{})}reset(){if(this.settings.cameras.forEach((e=>{this.cameras.set(e.name,e)})),!1===this.cameras.has("default")){if(void 0===default_camera){var e=renderer.getWidth(),t=renderer.getHeight();default_camera=new Camera2d(0,0,e,t)}this.cameras.set("default",default_camera)}reset(),this.onResetEvent.apply(this,arguments)}update(e){var t=world.update(e);return this.cameras.forEach((function(i){i.update(e)&&(t=!0)})),t}draw(e){this.cameras.forEach((function(t){t.draw(e,world)}))}destroy(){this.cameras.clear(),this.onDestroyEvent.apply(this,arguments)}onResetEvent(){"function"==typeof this.settings.onResetEvent&&this.settings.onResetEvent.apply(this,arguments)}onDestroyEvent(){"function"==typeof this.settings.onDestroyEvent&&this.settings.onDestroyEvent.apply(this,arguments)}}class ColorLayer extends Renderable{constructor(e,t,i){super(0,0,1/0,1/0),this.color=pool.pull("Color").parseCSS(t),this.onResetEvent(e,t,i)}onResetEvent(e,t,i=0){this.name=e,this.pos.z=i,this.floating=!0,this.color.parseCSS(t)}draw(e,t){var i=e.getColor(),s=viewport.pos;e.setColor(this.color),e.fillRect(t.left-s.x,t.top-s.y,t.width,t.height),e.setColor(i)}destroy(){pool.push(this.color),this.color=void 0,super.destroy()}}class ProgressBar extends Renderable{constructor(e,t,i,s){super(e,t,i,s),this.barHeight=s,this.anchorPoint.set(0,0),on(LOADER_PROGRESS,this.onProgressUpdate,this),on(VIEWPORT_ONRESIZE,this.resize,this),this.anchorPoint.set(0,0),this.progress=0}onProgressUpdate(e){this.progress=~~(e*this.width),this.isDirty=!0}draw(e){e.setColor("black"),e.fillRect(this.pos.x,viewport.centerY,e.getWidth(),this.barHeight/2),e.setColor("#55aa00"),e.fillRect(this.pos.x,viewport.centerY,this.progress,this.barHeight/2)}onDestroyEvent(){off(LOADER_PROGRESS,this.onProgressUpdate),off(VIEWPORT_ONRESIZE,this.resize)}}class IconLogo extends Renderable{constructor(e,t){super(e,t,100,85),this.iconCanvas=createCanvas(nextPowerOfTwo(this.width),nextPowerOfTwo(this.height),!1);var i=renderer.getContext2d(this.iconCanvas);i.beginPath(),i.moveTo(.7,48.9),i.bezierCurveTo(10.8,68.9,38.4,75.8,62.2,64.5),i.bezierCurveTo(86.1,53.1,97.2,27.7,87,7.7),i.lineTo(87,7.7),i.bezierCurveTo(89.9,15.4,73.9,30.2,50.5,41.4),i.bezierCurveTo(27.1,52.5,5.2,55.8,.7,48.9),i.lineTo(.7,48.9),i.closePath(),i.fillStyle="rgb(255, 255, 255)",i.fill(),i.beginPath(),i.moveTo(84,7),i.bezierCurveTo(87.6,14.7,72.5,30.2,50.2,41.6),i.bezierCurveTo(27.9,53,6.9,55.9,3.2,48.2),i.bezierCurveTo(-.5,40.4,14.6,24.9,36.9,13.5),i.bezierCurveTo(59.2,2.2,80.3,-.8,84,7),i.lineTo(84,7),i.closePath(),i.lineWidth=5.3,i.strokeStyle="rgb(255, 255, 255)",i.lineJoin="miter",i.miterLimit=4,i.stroke(),this.anchorPoint.set(.5,.5)}draw(e){e.drawImage(this.iconCanvas,e.getWidth()/2,this.pos.y)}}class DefaultLoadingScreen extends Stage{onResetEvent(){world.addChild(new ColorLayer("background","#202020"),0),world.addChild(new ProgressBar(0,renderer.getHeight()/2,renderer.getWidth(),8),1),world.addChild(new IconLogo(renderer.getWidth()/2,renderer.getHeight()/2-16-35),2);var e=pool.pull("Text",renderer.getWidth()/2,renderer.getHeight()/2+16,{font:"century gothic",size:32,fillStyle:"white",textAlign:"left",textBaseline:"top",text:"melon",offScreenCanvas:!0});e.anchorPoint.set(0,0);var t=pool.pull("Text",renderer.getWidth()/2,renderer.getHeight()/2+16,{font:"century gothic",size:32,fillStyle:"#55aa00",textAlign:"left",textBaseline:"top",bold:!0,text:"JS",offScreenCanvas:!0});t.anchorPoint.set(0,0);var i=e.getBounds().width+t.getBounds().width;e.pos.x=renderer.getWidth()/2-i/2,t.pos.x=e.pos.x+e.getBounds().width,world.addChild(e,2),world.addChild(t,2)}}var _state=-1,_animFrameId=-1,_isPaused=!1,_stages={},_fade={color:"",duration:0},_onSwitchComplete=null,_extraArgs=null,_pauseTime=0;function _startRunLoop(){-1===_animFrameId&&-1!==_state&&(timer$1.reset(),_animFrameId=window.requestAnimationFrame(_renderFrame))}function _resumeRunLoop(){_isPaused&&-1!==_state&&(timer$1.reset(),_isPaused=!1)}function _pauseRunLoop(){_isPaused=!0}function _renderFrame(e){var t=_stages[_state].stage;update$1(e,t),draw(t),-1!==_animFrameId&&(_animFrameId=window.requestAnimationFrame(_renderFrame))}function _stopRunLoop(){window.cancelAnimationFrame(_animFrameId),_animFrameId=-1}function _switchState(e){_stopRunLoop(),_stages[_state]&&_stages[_state].stage.destroy(),_stages[e]&&(_stages[_state=e].stage.reset.apply(_stages[_state].stage,_extraArgs),_startRunLoop(),_onSwitchComplete&&_onSwitchComplete(),repaint())}on(BOOT,(()=>{state.set(state.LOADING,new DefaultLoadingScreen),state.set(state.DEFAULT,new Stage),on(VIDEO_INIT,(()=>{state.change(state.DEFAULT,!0)}))}));var state={LOADING:0,MENU:1,READY:2,PLAY:3,GAMEOVER:4,GAME_END:5,SCORE:6,CREDITS:7,SETTINGS:8,DEFAULT:9,USER:100,stop(e){_state!==this.LOADING&&this.isRunning()&&(_stopRunLoop(),!0===e&&pauseTrack(),_pauseTime=window.performance.now(),emit(STATE_STOP))},pause(e){_state===this.LOADING||this.isPaused()||(_pauseRunLoop(),!0===e&&pauseTrack(),_pauseTime=window.performance.now(),emit(STATE_PAUSE))},restart(e){this.isRunning()||(_startRunLoop(),!0===e&&resumeTrack(),_pauseTime=window.performance.now()-_pauseTime,repaint(),emit(STATE_RESTART,_pauseTime))},resume(e){this.isPaused()&&(_resumeRunLoop(),!0===e&&resumeTrack(),_pauseTime=window.performance.now()-_pauseTime,emit(STATE_RESUME,_pauseTime))},isRunning:()=>-1!==_animFrameId,isPaused:()=>_isPaused,set(e,t,i=!1){if(!(t instanceof Stage))throw new Error(t+" is not an instance of me.Stage");_stages[e]={},_stages[e].stage=t,_stages[e].transition=!0,!0===i&&this.change(e)},current(){if(void 0!==_stages[_state])return _stages[_state].stage},transition(e,t,i){"fade"===e&&(_fade.color=t,_fade.duration=i)},setTransition(e,t){_stages[e].transition=t},change(e,t){if(void 0===_stages[e])throw new Error("Undefined Stage for state '"+e+"'");this.isCurrent(e)||(_extraArgs=null,arguments.length>1&&(_extraArgs=Array.prototype.slice.call(arguments,1)),_fade.duration&&_stages[e].transition?(_onSwitchComplete=function(){viewport.fadeOut(_fade.color,_fade.duration)},viewport.fadeIn(_fade.color,_fade.duration,(function(){defer(_switchState,this,e)}))):!0===t?_switchState(e):defer(_switchState,this,e))},isCurrent:e=>_state===e};function setTMXValue(name,type,value){var match;if("string"!=typeof value)return value;switch(type){case"int":case"float":value=Number(value);break;case"bool":value="true"===value;break;default:if(!value||isBoolean(value))value=!value||"true"===value;else if(isNumeric(value))value=Number(value);else if(0===value.search(/^json:/i)){match=value.split(/^json:/i)[1];try{value=JSON.parse(match)}catch(e){throw new Error("Unable to parse JSON: "+match)}}else if(0===value.search(/^eval:/i)){match=value.split(/^eval:/i)[1];try{value=eval(match)}catch(e){throw new Error("Unable to evaluate: "+match)}}else((match=value.match(/^#([\da-fA-F])([\da-fA-F]{3})$/))||(match=value.match(/^#([\da-fA-F]{2})([\da-fA-F]{6})$/)))&&(value="#"+match[2]+match[1]);0===name.search(/^(ratio|anchorPoint)$/)&&"number"==typeof value&&(value={x:value,y:value})}return value}function parseAttributes(e,t){if(t.attributes&&t.attributes.length>0)for(var i=0;i<t.attributes.length;i++){var s=t.attributes.item(i);void 0!==s.name?e[s.name]=s.value:e[s.nodeName]=s.nodeValue}}function decompress(){throw new Error("GZIP/ZLIB compressed TMX Tile Map not supported!")}function decodeCSV(e){for(var t=e.replace("\n","").trim().split(","),i=[],s=0;s<t.length;s++)i.push(+t[s]);return i}function decodeBase64AsArray(e,t){var i,s,r;t=t||1;var n=window.atob(e.replace(/[^A-Za-z0-9\+\/\=]/g,"")),o=new Uint32Array(n.length/t);for(i=0,r=n.length/t;i<r;i++)for(o[i]=0,s=t-1;s>=0;--s)o[i]+=n.charCodeAt(i*t+s)<<(s<<3);return o}function decode(e,t,i){switch(i=i||"none",t=t||"none"){case"csv":return decodeCSV(e);case"base64":var s=decodeBase64AsArray(e,4);return"none"===i?s:decompress();case"none":return e;case"xml":throw new Error("XML encoding is deprecated, use base64 instead");default:throw new Error("Unknown layer encoding: "+t)}}function normalize(e,t){var i=t.nodeName;switch(i){case"data":var s=parse(t);s.text=s.text||s.chunk.text,s.encoding=s.encoding||"xml",e.data=decode(s.text,s.encoding,s.compression),e.encoding="none";break;case"imagelayer":case"layer":case"objectgroup":case"group":var r=parse(t);r.type="layer"===i?"tilelayer":i,r.image&&(r.image=r.image.source),e.layers=e.layers||[],e.layers.push(r);break;case"animation":e.animation=parse(t).frames;break;case"frame":case"object":var n=i+"s";e[n]=e[n]||[],e[n].push(parse(t));break;case"tile":var o=parse(t);o.image&&(o.imagewidth=o.image.width,o.imageheight=o.image.height,o.image=o.image.source),e.tiles=e.tiles||{},e.tiles[o.id]=o;break;case"tileset":var a=parse(t);a.image&&(a.imagewidth=a.image.width,a.imageheight=a.image.height,a.image=a.image.source),e.tilesets=e.tilesets||[],e.tilesets.push(a);break;case"polygon":case"polyline":e[i]=[];for(var h,l=parse(t).points.split(" "),d=0;d<l.length;d++)h=l[d].split(","),e[i].push({x:+h[0],y:+h[1]});break;case"properties":e.properties=parse(t);break;case"property":var u=parse(t),c=void 0!==u.value?u.value:u.text;e[u.name]=setTMXValue(u.name,u.type||"string",c);break;default:e[i]=parse(t)}}function parse(e){var t={},i="";if(1===e.nodeType&&parseAttributes(t,e),e.hasChildNodes())for(var s=0;s<e.childNodes.length;s++){var r=e.childNodes.item(s);switch(r.nodeType){case 1:normalize(t,r);break;case 3:i+=r.nodeValue.trim()}}return i&&(t.text=i),t}function applyTMXProperties(e,t){var i=t.properties,s=t.propertytypes;if(void 0!==i)for(var r in i)if(i.hasOwnProperty(r)){var n="string",o=r,a=i[r];void 0!==i[r].name&&(o=i[r].name),void 0!==s?n=s[r]:void 0!==i[r].type&&(n=i[r].type),void 0!==i[r].value&&(a=i[r].value),e[o]=setTMXValue(o,n,a)}}class TextureCache{constructor(e){this.cache=new Map,this.tinted=new Map,this.units=new Map,this.max_size=e||1/0,this.clear()}clear(){this.cache.clear(),this.tinted.clear(),this.units.clear(),this.length=0}validate(){if(this.length>=this.max_size)throw new Error("Texture cache overflow: "+this.max_size+" texture units available for this GPU.")}get(e,t){return this.cache.has(e)||(t||(t=createAtlas(e.width,e.height,e.src?getBasename(e.src):void 0)),this.set(e,new Texture(t,e,!1))),this.cache.get(e)}remove(e){this.cache.has(e)||!0===this.cache.remove(e)&&this.length--}tint(e,t){var i=this.tinted.get(e);return void 0===i&&(i=this.tinted.set(e,new Map)),i.has(t)||i.set(t,renderer.tint(e,t,"multiply")),i.get(t)}set(e,t){var i=e.width,s=e.height;if(!(1!==renderer.WebGLVersion||isPowerOfTwo(i)&&isPowerOfTwo(s))){var r=void 0!==e.src?e.src:e;console.warn("[Texture] "+r+" is not a POT texture ("+i+"x"+s+")")}this.cache.set(e,t)}getUnit(e){return this.units.has(e)||(this.validate(),this.units.set(e,this.length++)),this.units.get(e)}}function createAtlas(e,t,i="default",s="no-repeat"){return{meta:{app:"melonJS",size:{w:e,h:t},repeat:s,image:"default"},frames:[{filename:i,frame:{x:0,y:0,w:e,h:t}}]}}class Texture{constructor(e,t,i){if(this.format=null,this.sources=new Map,this.atlases=new Map,void 0!==e)for(var s in e=Array.isArray(e)?e:[e]){var r=e[s];if(void 0!==r.meta){if(r.meta.app.includes("texturepacker")||r.meta.app.includes("free-tex-packer")){if(this.format="texturepacker",void 0===t){var n=loader.getImage(r.meta.image);if(!n)throw new Error("Atlas texture '"+n+"' not found");this.sources.set(r.meta.image,n)}else this.sources.set(r.meta.image||"default","string"==typeof t?loader.getImage(t):t);this.repeat="no-repeat"}else if(r.meta.app.includes("ShoeBox")){if(!r.meta.exporter||!r.meta.exporter.includes("melonJS"))throw new Error("ShoeBox requires the JSON exporter : https://github.com/melonjs/melonJS/tree/master/media/shoebox_JSON_export.sbx");this.format="ShoeBox",this.repeat="no-repeat",this.sources.set("default","string"==typeof t?loader.getImage(t):t)}else r.meta.app.includes("melonJS")&&(this.format="melonJS",this.repeat=r.meta.repeat||"no-repeat",this.sources.set("default","string"==typeof t?loader.getImage(t):t));this.atlases.set(r.meta.image||"default",this.parse(r))}else void 0!==r.framewidth&&void 0!==r.frameheight&&(this.format="Spritesheet (fixed cell size)",this.repeat="no-repeat",void 0!==t&&(r.image="string"==typeof t?loader.getImage(t):t),this.atlases.set("default",this.parseFromSpriteSheet(r)),this.sources.set("default",r.image))}if(0===this.atlases.length)throw new Error("texture atlas format not supported");!1!==i&&this.sources.forEach((e=>{i instanceof TextureCache?i.set(e,this):renderer.cache.set(e,this)}))}parse(e){var t={};return e.frames.forEach((i=>{if(i.hasOwnProperty("filename")){var s,r,n=i.frame,o=i.spriteSourceSize&&i.sourceSize&&i.pivot;o&&(s=i.sourceSize.w*i.pivot.x-(i.trimmed?i.spriteSourceSize.x:0),r=i.sourceSize.h*i.pivot.y-(i.trimmed?i.spriteSourceSize.y:0)),t[i.filename]={name:i.filename,texture:e.meta.image||"default",offset:new Vector2d(n.x,n.y),anchorPoint:o?new Vector2d(s/n.w,r/n.h):null,trimmed:!!i.trimmed,width:n.w,height:n.h,angle:!0===i.rotated?-ETA:0},this.addUvsMap(t,i.filename,e.meta.size.w,e.meta.size.h)}})),t}parseFromSpriteSheet(e){var t={},i=e.image,s=e.spacing||0,r=e.margin||0,n=i.width,o=i.height,a=pool.pull("Vector2d",~~((n-r+s)/(e.framewidth+s)),~~((o-r+s)/(e.frameheight+s)));if(n%(e.framewidth+s)!=0||o%(e.frameheight+s)!=0){var h=a.x*(e.framewidth+s),l=a.y*(e.frameheight+s);h-n!==s&&l-o!==s&&(n=h,o=l,console.warn("Spritesheet Texture for image: "+i.src+" is not divisible by "+(e.framewidth+s)+"x"+(e.frameheight+s)+", truncating effective size to "+n+"x"+o))}for(var d=0,u=a.x*a.y;d<u;d++){var c=""+d;t[c]={name:c,texture:"default",offset:new Vector2d(r+(s+e.framewidth)*(d%a.x),r+(s+e.frameheight)*~~(d/a.x)),anchorPoint:e.anchorPoint||null,trimmed:!1,width:e.framewidth,height:e.frameheight,angle:0},this.addUvsMap(t,c,n,o)}return pool.push(a),t}addUvsMap(e,t,i,s){if(renderer instanceof WebGLRenderer){var r=e[t].offset,n=e[t].width,o=e[t].height;e[t].uvs=new Float32Array([r.x/i,r.y/s,(r.x+n)/i,(r.y+o)/s]),e[r.x+","+r.y+","+i+","+s]=e[t]}return e[t]}addQuadRegion(e,t,i,s,r){!0===renderer.settings.verbose&&console.warn("Adding texture region",e,"for texture",this);var n=this.getTexture(),o=this.getAtlas(),a=n.width,h=n.height;return o[e]={name:e,offset:new Vector2d(t,i),width:s,height:r,angle:0},this.addUvsMap(o,e,a,h),o[e]}getAtlas(e){return"string"==typeof e?this.atlases.get(e):this.atlases.values().next().value}getFormat(){return this.format}getTexture(e){return"object"==typeof e&&"string"==typeof e.texture?this.sources.get(e.texture):this.sources.values().next().value}getRegion(e,t){var i;return"string"==typeof t?i=this.getAtlas(t)[e]:this.atlases.forEach((function(t){void 0!==t[e]&&(i=t[e])})),i}getUVs(e){var t=this.getRegion(e);if(void 0===t){var i=e.split(","),s=+i[0],r=+i[1],n=+i[2],o=+i[3];t=this.addQuadRegion(e,s,r,n,o)}return t.uvs}createSpriteFromName(e,t,i=!1){return pool.pull(!0===i?"me.NineSliceSprite":"me.Sprite",0,0,Object.assign({image:this,region:e},t||{}))}createAnimationFromName(e,t){for(var i,s=[],r={},n=0,o=0,a=0;a<e.length;++a){if(null==(i=this.getRegion(e[a])))throw new Error("Texture - region for "+e[a]+" not found");s[a]=i,r[e[a]]=a,n=Math.max(i.width,n),o=Math.max(i.height,o)}return new Sprite(0,0,Object.assign({image:this,framewidth:n,frameheight:o,margin:0,spacing:0,atlas:s,atlasIndices:r},t||{}))}}class Sprite extends Renderable{constructor(e,t,i){if(super(e,t,0,0),this.animationpause=!1,this.animationspeed=100,this.offset=pool.pull("Vector2d",0,0),this.source=null,this.anim={},this.resetAnim=void 0,this.current={name:"default",length:0,offset:new Vector2d,width:0,height:0,angle:0,idx:0},this.dt=0,this._flicker={isFlickering:!1,duration:0,callback:null,state:!1},i.image instanceof Texture){if(this.source=i.image,this.image=this.source.getTexture(),this.textureAtlas=i.image,void 0!==i.region){var s=this.source.getRegion(i.region);if(!s)throw new Error("Texture - region for "+i.region+" not found");this.setRegion(s),this.current.width=i.framewidth||s.width,this.current.height=i.frameheight||s.height}}else{if(this.image="object"==typeof i.image?i.image:loader.getImage(i.image),!this.image)throw new Error("me.Sprite: '"+i.image+"' image/texture not found!");this.current.width=i.framewidth=i.framewidth||this.image.width,this.current.height=i.frameheight=i.frameheight||this.image.height,this.source=renderer.cache.get(this.image,i),this.textureAtlas=this.source.getAtlas()}void 0!==i.atlas&&(this.textureAtlas=i.atlas,this.atlasIndices=i.atlasIndices),this.width=this.current.width,this.height=this.current.height,void 0!==i.flipX&&this.flipX(!!i.flipX),void 0!==i.flipY&&this.flipY(!!i.flipY),void 0!==i.rotation&&this.rotate(i.rotation),i.anchorPoint&&this.anchorPoint.set(i.anchorPoint.x,i.anchorPoint.y),void 0!==i.tint&&this.tint.setColor(i.tint),"string"==typeof i.name&&(this.name=i.name),void 0!==i.z&&(this.pos.z=i.z),0!==this.addAnimation("default",null)&&this.setCurrentAnimation("default"),this.autoTransform=!0}isFlickering(){return this._flicker.isFlickering}flicker(e,t){return this._flicker.duration=e,this._flicker.duration<=0?(this._flicker.isFlickering=!1,this._flicker.callback=null):this._flicker.isFlickering||(this._flicker.callback=t,this._flicker.isFlickering=!0),this}addAnimation(e,t,i){this.anim[e]={name:e,frames:[],idx:0,length:0};var s=0;if("object"!=typeof this.textureAtlas)return 0;null==t&&(t=[],Object.keys(this.textureAtlas).forEach((function(e,i){t[i]=i})));for(var r=0,n=t.length;r<n;r++){var o,a=t[r],h=(o="number"==typeof a||"string"==typeof a?{name:a,delay:i||this.animationspeed}:a).name;if("number"==typeof h)void 0!==this.textureAtlas[h]&&(this.anim[e].frames[r]=Object.assign({},this.textureAtlas[h],o),s++);else{if(this.source.getFormat().includes("Spritesheet"))throw new Error("string parameters for addAnimation are not allowed for standard spritesheet based Texture");this.anim[e].frames[r]=Object.assign({},this.textureAtlas[this.atlasIndices[h]],o),s++}}return this.anim[e].length=s,s}setCurrentAnimation(e,t,i){if(!this.anim[e])throw new Error("animation id '"+e+"' not defined");return this.current.name=e,this.current.length=this.anim[this.current.name].length,this.resetAnim="string"==typeof t?this.setCurrentAnimation.bind(this,t,null,!0):"function"==typeof t?t:void 0,this.setAnimationFrame(this.current.idx),i||(this.dt=0),this.isDirty=!0,this}reverseAnimation(e){return void 0!==e&&void 0!==this.anim[e]?this.anim[e].frames.reverse():this.anim[this.current.name].frames.reverse(),this.isDirty=!0,this}isCurrentAnimation(e){return this.current.name===e}setRegion(e){return this.image=this.source.getTexture(e),this.current.offset.setV(e.offset),this.current.angle=e.angle,this.width=this.current.width=e.width,this.height=this.current.height=e.height,e.anchorPoint&&this.anchorPoint.set(this._flip.x&&!0===e.trimmed?1-e.anchorPoint.x:e.anchorPoint.x,this._flip.y&&!0===e.trimmed?1-e.anchorPoint.y:e.anchorPoint.y),this.isDirty=!0,this}setAnimationFrame(e){return this.current.idx=(e||0)%this.current.length,this.setRegion(this.getAnimationFrameObjectByIndex(this.current.idx))}getCurrentAnimationFrame(){return this.current.idx}getAnimationFrameObjectByIndex(e){return this.anim[this.current.name].frames[e]}update(e){if(!this.animationpause&&this.current&&this.current.length>0){var t=this.getAnimationFrameObjectByIndex(this.current.idx).delay;for(this.dt+=e;this.dt>=t;){this.isDirty=!0,this.dt-=t;var i=this.current.length>1?this.current.idx+1:this.current.idx;if(this.setAnimationFrame(i),0===this.current.idx&&"function"==typeof this.resetAnim&&!1===this.resetAnim()){this.setAnimationFrame(this.current.length-1),this.dt%=t;break}t=this.getAnimationFrameObjectByIndex(this.current.idx).delay}}return this._flicker.isFlickering&&(this._flicker.duration-=e,this._flicker.duration<0&&("function"==typeof this._flicker.callback&&this._flicker.callback(),this.flicker(-1)),this.isDirty=!0),this.isDirty}destroy(){pool.push(this.offset),this.offset=void 0,super.destroy()}draw(e){if(!this._flicker.isFlickering||(this._flicker.state=!this._flicker.state,this._flicker.state)){var t=this.current,i=this.pos.x,s=this.pos.y,r=t.width,n=t.height,o=t.offset,a=this.offset;0!==t.angle&&(e.translate(-i,-s),e.rotate(t.angle),i-=n,r=t.height,n=t.width),e.drawImage(this.image,a.x+o.x,a.y+o.y,r,n,i,s,r,n)}}}var TMX_FLIP_H=2147483648,TMX_FLIP_V=1073741824,TMX_FLIP_AD=536870912,TMX_CLEAR_BIT_MASK$1=536870911;class Tile extends Bounds$1{constructor(e,t,i,s){var r,n;if(super(),s.isCollection){var o=s.getTileImage(i&TMX_CLEAR_BIT_MASK$1);r=o.width,n=o.height}else r=s.tilewidth,n=s.tileheight;this.setMinMax(0,0,r,n),this.tileset=s,this.currentTransform=null,this.col=e,this.row=t,this.tileId=i,this.flippedX=0!=(this.tileId&TMX_FLIP_H),this.flippedY=0!=(this.tileId&TMX_FLIP_V),this.flippedAD=0!=(this.tileId&TMX_FLIP_AD),this.flipped=this.flippedX||this.flippedY||this.flippedAD,!0===this.flipped&&(null===this.currentTransform&&(this.currentTransform=new Matrix2d),this.setTileTransform(this.currentTransform.identity())),this.tileId&=TMX_CLEAR_BIT_MASK$1}setTileTransform(e){e.translate(this.width/2,this.height/2),this.flippedAD&&(e.rotate(-90*Math.PI/180),e.scale(-1,1)),this.flippedX&&e.scale(this.flippedAD?1:-1,this.flippedAD?-1:1),this.flippedY&&e.scale(this.flippedAD?-1:1,this.flippedAD?1:-1),e.translate(-this.width/2,-this.height/2)}getRenderable(e){var t,i=this.tileset;if(i.animations.has(this.tileId)){var s=[],r=[];i.animations.get(this.tileId).frames.forEach((function(e){r.push(e.tileid),s.push({name:""+e.tileid,delay:e.duration})})),(t=i.texture.createAnimationFromName(r,e)).addAnimation(this.tileId-i.firstgid,s),t.setCurrentAnimation(this.tileId-i.firstgid)}else if(!0===i.isCollection){var n=i.getTileImage(this.tileId);(t=new Sprite(0,0,Object.assign({image:n}))).anchorPoint.set(0,0),t.scale(e.width/this.width,e.height/this.height),void 0!==e.rotation&&(t.anchorPoint.set(.5,.5),t.currentTransform.rotate(e.rotation),t.currentTransform.translate(e.width/2,e.height/2),e.rotation=void 0)}else(t=i.texture.createSpriteFromName(this.tileId-i.firstgid,e)).anchorPoint.set(0,0);return this.setTileTransform(t.currentTransform),t}}class Line extends Polygon{contains(){var e,t;2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),e-=this.pos.x,t-=this.pos.y;var i=this.points[0],s=this.points[1];return(t-i.y)*(s.x-i.x)==(s.y-i.y)*(e-i.x)}recalc(){var e=this.edges,t=this.normals,i=this.indices,s=this.points;if(2!==s.length)throw new Error("Requires exactly 2 points");return void 0===e[0]&&(e[0]=new Vector2d),e[0].copy(s[1]).sub(s[0]),void 0===t[0]&&(t[0]=new Vector2d),t[0].copy(e[0]).perp().normalize(),i.length=0,this}clone(){var e=[];return this.points.forEach((function(t){e.push(t.clone())})),new Line(this.pos.x,this.pos.y,e)}}class Renderer{constructor(e){return this.settings=e,this.isContextValid=!0,this.currentScissor=new Int32Array([0,0,this.settings.width,this.settings.height]),this.currentBlendMode="normal",!0===device$1.ejecta?this.canvas=document.getElementById("canvas"):void 0!==window.canvas?this.canvas=window.canvas:void 0!==this.settings.canvas?this.canvas=this.settings.canvas:this.canvas=createCanvas(this.settings.zoomX,this.settings.zoomY),this.backBufferCanvas=this.canvas,this.context=null,this.currentColor=new Color(0,0,0,1),this.currentTint=new Color(255,255,255,1),this.projectionMatrix=new Matrix3d,this.uvOffset=0,this.Texture=Texture,on(GAME_RESET,(()=>{renderer.reset()})),this}clear(){}reset(){this.resetTransform(),this.setBlendMode(this.settings.blendMode),this.setColor("#000000"),this.clearTint(),this.cache.clear(),this.currentScissor[0]=0,this.currentScissor[1]=0,this.currentScissor[2]=this.backBufferCanvas.width,this.currentScissor[3]=this.backBufferCanvas.height}getCanvas(){return this.backBufferCanvas}getScreenCanvas(){return this.canvas}getScreenContext(){return this.context}getBlendMode(){return this.currentBlendMode}getContext2d(e,t){if(null==e)throw new Error("You must pass a canvas element in order to create a 2d context");if(void 0===e.getContext)throw new Error("Your browser does not support HTML5 canvas.");"boolean"!=typeof t&&(t=!0);var i=e.getContext("2d",{alpha:t});return i.canvas||(i.canvas=e),this.setAntiAlias(i,this.settings.antiAlias),i}getWidth(){return this.backBufferCanvas.width}getHeight(){return this.backBufferCanvas.height}getColor(){return this.currentColor}globalAlpha(){return this.currentColor.glArray[3]}overlaps(e){return e.left<=this.getWidth()&&e.right>=0&&e.top<=this.getHeight()&&e.bottom>=0}resize(e,t){e===this.backBufferCanvas.width&&t===this.backBufferCanvas.height||(this.canvas.width=this.backBufferCanvas.width=e,this.canvas.height=this.backBufferCanvas.height=t,this.currentScissor[0]=0,this.currentScissor[1]=0,this.currentScissor[2]=e,this.currentScissor[3]=t,emit(CANVAS_ONRESIZE,e,t))}setAntiAlias(e,t){var i=e.canvas;setPrefixed("imageSmoothingEnabled",!0===t,e),!0!==t?(i.style["image-rendering"]="optimizeSpeed",i.style["image-rendering"]="-moz-crisp-edges",i.style["image-rendering"]="-o-crisp-edges",i.style["image-rendering"]="-webkit-optimize-contrast",i.style["image-rendering"]="optimize-contrast",i.style["image-rendering"]="crisp-edges",i.style["image-rendering"]="pixelated",i.style.msInterpolationMode="nearest-neighbor"):i.style["image-rendering"]="auto"}setProjection(e){this.projectionMatrix.copy(e)}stroke(e,t){e instanceof Rect||e instanceof Bounds$1?this.strokeRect(e.left,e.top,e.width,e.height,t):e instanceof Line||e instanceof Polygon?this.strokePolygon(e,t):e instanceof Ellipse&&this.strokeEllipse(e.pos.x,e.pos.y,e.radiusV.x,e.radiusV.y,t)}tint(e,t,i){var s=createCanvas(e.width,e.height,!0),r=this.getContext2d(s);return r.save(),r.fillStyle=t instanceof Color?t.toRGB():t,r.fillRect(0,0,e.width,e.height),r.globalCompositeOperation=i||"multiply",r.drawImage(e,0,0),r.globalCompositeOperation="destination-atop",r.drawImage(e,0,0),r.restore(),s}fill(e){this.stroke(e,!0)}setMask(e){}clearMask(){}setTint(e,t=e.alpha){this.currentTint.copy(e),this.currentTint.alpha*=t}clearTint(){this.currentTint.setColor(255,255,255,1)}drawFont(){}}class CanvasRenderer extends Renderer{constructor(e){return super(e),this.context=this.getContext2d(this.getScreenCanvas(),this.settings.transparent),this.settings.doubleBuffering?(this.backBufferCanvas=createCanvas(this.settings.width,this.settings.height,!0),this.backBufferContext2D=this.getContext2d(this.backBufferCanvas)):(this.backBufferCanvas=this.getScreenCanvas(),this.backBufferContext2D=this.context),this.setBlendMode(this.settings.blendMode),this.setColor(this.currentColor),this.cache=new TextureCache,!1===this.settings.textureSeamFix||this.settings.antiAlias||(this.uvOffset=1),this}reset(){super.reset(),this.clearColor(this.currentColor,!0!==this.settings.transparent)}resetTransform(){this.backBufferContext2D.setTransform(1,0,0,1,0,0)}setBlendMode(e,t){t=t||this.getContext(),this.currentBlendMode=e,"multiply"===e?t.globalCompositeOperation="multiply":(t.globalCompositeOperation="source-over",this.currentBlendMode="normal"),this.settings.doubleBuffering&&this.settings.transparent&&(this.context.globalCompositeOperation="copy")}clear(){this.settings.transparent&&this.clearColor("rgba(0,0,0,0)",!0)}flush(){this.settings.doubleBuffering&&this.context.drawImage(this.backBufferCanvas,0,0)}clearColor(e,t){this.save(),this.resetTransform(),this.backBufferContext2D.globalCompositeOperation=t?"copy":"source-over",this.backBufferContext2D.fillStyle=e instanceof Color?e.toRGBA():e,this.fillRect(0,0,this.backBufferCanvas.width,this.backBufferCanvas.height),this.restore()}clearRect(e,t,i,s){this.backBufferContext2D.clearRect(e,t,i,s)}createPattern(e,t){return this.backBufferContext2D.createPattern(e,t)}drawImage(e,t,i,s,r,n,o,a,h){if(!(this.backBufferContext2D.globalAlpha<1/255)){void 0===s?(s=a=e.width,r=h=e.height,n=t,o=i,t=0,i=0):void 0===n&&(n=t,o=i,a=s,h=r,s=e.width,r=e.height,t=0,i=0),!1===this.settings.subPixel&&(n=~~n,o=~~o);var l=e,d=this.currentTint.toArray();1===d[0]&&1===d[1]&&1===d[2]||(l=this.cache.tint(e,this.currentTint.toRGB())),this.backBufferContext2D.drawImage(l,t,i,s,r,n,o,a,h)}}drawPattern(e,t,i,s,r){if(!(this.backBufferContext2D.globalAlpha<1/255)){var n=this.backBufferContext2D.fillStyle;this.backBufferContext2D.fillStyle=e,this.backBufferContext2D.fillRect(t,i,s,r),this.backBufferContext2D.fillStyle=n}}strokeArc(e,t,i,s,r,n,o=!1){var a=this.backBufferContext2D;a.globalAlpha<1/255||(a.translate(e,t),a.beginPath(),a.arc(0,0,i,s,r,n||!1),a[!0===o?"fill":"stroke"](),a.translate(-e,-t))}fillArc(e,t,i,s,r,n){this.strokeArc(e,t,i,s,r,n||!1,!0)}strokeEllipse(e,t,i,s,r=!1){var n=this.backBufferContext2D;if(!(n.globalAlpha<1/255)){var o=e-i,a=e+i,h=t-s,l=t+s,d=.551784*i,u=.551784*s,c=e-d,p=e+d,g=t-u,f=t+u;n.beginPath(),n.moveTo(e,h),n.bezierCurveTo(p,h,a,g,a,t),n.bezierCurveTo(a,f,p,l,e,l),n.bezierCurveTo(c,l,o,f,o,t),n.bezierCurveTo(o,g,c,h,e,h),n[!0===r?"fill":"stroke"](),n.closePath()}}fillEllipse(e,t,i,s){this.strokeEllipse(e,t,i,s,!0)}strokeLine(e,t,i,s){var r=this.backBufferContext2D;r<1/255||(r.beginPath(),r.moveTo(e,t),r.lineTo(i,s),r.stroke())}fillLine(e,t,i,s){this.strokeLine(e,t,i,s)}strokePolygon(e,t=!1){var i=this.backBufferContext2D;if(!(i.globalAlpha<1/255)){var s;this.translate(e.pos.x,e.pos.y),i.beginPath(),i.moveTo(e.points[0].x,e.points[0].y);for(var r=1;r<e.points.length;r++)s=e.points[r],i.lineTo(s.x,s.y);i.lineTo(e.points[0].x,e.points[0].y),i[!0===t?"fill":"stroke"](),i.closePath(),this.translate(-e.pos.x,-e.pos.y)}}fillPolygon(e){this.strokePolygon(e,!0)}strokeRect(e,t,i,s,r=!1){if(!0===r)this.fillRect(e,t,i,s);else{if(this.backBufferContext2D.globalAlpha<1/255)return;this.backBufferContext2D.strokeRect(e,t,i,s)}}fillRect(e,t,i,s){this.backBufferContext2D.globalAlpha<1/255||this.backBufferContext2D.fillRect(e,t,i,s)}getContext(){return this.backBufferContext2D}getFontContext(){return this.getContext()}save(){this.backBufferContext2D.save()}restore(){this.backBufferContext2D.restore(),this.currentColor.glArray[3]=this.backBufferContext2D.globalAlpha,this.currentScissor[0]=0,this.currentScissor[1]=0,this.currentScissor[2]=this.backBufferCanvas.width,this.currentScissor[3]=this.backBufferCanvas.height}rotate(e){this.backBufferContext2D.rotate(e)}scale(e,t){this.backBufferContext2D.scale(e,t)}setColor(e){this.backBufferContext2D.strokeStyle=this.backBufferContext2D.fillStyle=e instanceof Color?e.toRGBA():e}setGlobalAlpha(e){this.backBufferContext2D.globalAlpha=this.currentColor.glArray[3]=e}setLineWidth(e){this.backBufferContext2D.lineWidth=e}setTransform(e){this.resetTransform(),this.transform(e)}transform(e){var t=e.toArray(),i=t[0],s=t[1],r=t[3],n=t[4],o=t[6],a=t[7];!1===this.settings.subPixel&&(o|=0,a|=0),this.backBufferContext2D.transform(i,s,r,n,o,a)}translate(e,t){!1===this.settings.subPixel?this.backBufferContext2D.translate(~~e,~~t):this.backBufferContext2D.translate(e,t)}clipRect(e,t,i,s){var r=this.backBufferCanvas;if(0!==e||0!==t||i!==r.width||s!==r.height){var n=this.currentScissor;if(n[0]!==e||n[1]!==t||n[2]!==i||n[3]!==s){var o=this.backBufferContext2D;o.beginPath(),o.rect(e,t,i,s),o.clip(),n[0]=e,n[1]=t,n[2]=i,n[3]=s}}}setMask(e){var t=this.backBufferContext2D,i=e.pos.x,s=e.pos.y;if(t.save(),e instanceof Ellipse){var r=e.radiusV.x,n=e.radiusV.y,o=i-r,a=i+r,h=s-n,l=s+n,d=.551784*r,u=.551784*n,c=i-d,p=i+d,g=s-u,f=s+u;t.beginPath(),t.moveTo(i,h),t.bezierCurveTo(p,h,a,g,a,s),t.bezierCurveTo(a,f,p,l,i,l),t.bezierCurveTo(c,l,o,f,o,s),t.bezierCurveTo(o,g,c,h,i,h)}else{var m;t.beginPath(),t.moveTo(i+e.points[0].x,s+e.points[0].y);for(var v=1;v<e.points.length;v++)m=e.points[v],t.lineTo(i+m.x,s+m.y)}t.clip()}clearMask(){this.backBufferContext2D.restore()}}function initArray(e){e.layerData=new Array(e.cols);for(var t=0;t<e.cols;t++){e.layerData[t]=new Array(e.rows);for(var i=0;i<e.rows;i++)e.layerData[t][i]=null}}function setLayerData(e,t){var i=0;initArray(e);for(var s=0;s<e.rows;s++)for(var r=0;r<e.cols;r++){var n=t[i++];0!==n&&(e.layerData[r][s]=e.getTileById(n,r,s))}}function preRenderLayer(e,t){for(var i=0;i<e.rows;i++)for(var s=0;s<e.cols;s++){var r=e.layerData[s][i];r instanceof Tile&&e.getRenderer().drawTile(t,s,i,r)}}class TMXLayer extends Renderable{constructor(e,t,i,s,r,n,o){super(0,0,0,0),this.tilewidth=t.tilewidth||i,this.tileheight=t.tileheight||s,this.orientation=r,this.tilesets=n,this.tileset=this.tilesets?this.tilesets.getTilesetByIndex(0):null,this.maxTileSize={width:0,height:0};for(var a=0;a<this.tilesets.length;a++){var h=this.tilesets.getTilesetByIndex(a);this.maxTileSize.width=Math.max(this.maxTileSize.width,h.tilewidth),this.maxTileSize.height=Math.max(this.maxTileSize.height,h.tileheight)}this.animatedTilesets=[],this.isAnimated=!1,this.renderorder=t.renderorder||"right-down",this.pos.z=o,this.anchorPoint.set(0,0),this.name=t.name,this.cols=+t.width,this.rows=+t.height;var l=void 0!==t.visible?+t.visible:1;this.setOpacity(l?+t.opacity:0),"string"==typeof t.tintcolor&&this.tint.parseHex(t.tintcolor,!0),"isometric"===this.orientation?(this.width=(this.cols+this.rows)*(this.tilewidth/2),this.height=(this.cols+this.rows)*(this.tileheight/2)):(this.width=this.cols*this.tilewidth,this.height=this.rows*this.tileheight),applyTMXProperties(this,t),void 0===this.preRender&&(this.preRender=world.preRender),this.setRenderer(e.getRenderer()),setLayerData(this,decode(t.data,t.encoding,t.compression))}onActivateEvent(){if(void 0===this.animatedTilesets&&(this.animatedTilesets=[]),this.tilesets)for(var e=this.tilesets.tilesets,t=0;t<e.length;t++)e[t].isAnimated&&this.animatedTilesets.push(e[t]);this.isAnimated=this.animatedTilesets.length>0,this.isAnimated&&(this.preRender=!1),this.getBounds().addBounds(this.getRenderer().getBounds(),!0),this.getBounds().shift(this.pos),!0!==this.preRender||this.canvasRenderer||(this.canvasRenderer=new CanvasRenderer({canvas:createCanvas(this.width,this.height),widht:this.width,heigth:this.height,transparent:!0}),preRenderLayer(this,this.canvasRenderer))}onDeactivateEvent(){this.animatedTilesets=void 0}setRenderer(e){this.renderer=e}getRenderer(){return this.renderer}getTileId(e,t){var i=this.getTile(e,t);return i?i.tileId:null}getTile(e,t){var i=null;if(this.contains(e,t)){var s=this.getRenderer().pixelToTileCoords(e,t,pool.pull("Vector2d"));i=this.cellAt(s.x,s.y),pool.push(s)}return i}setTile(e,t,i){return this.layerData[t][i]=e,e}getTileById(e,t,i){return this.tileset.contains(e)||(this.tileset=this.tilesets.getTilesetByGid(e)),new Tile(t,i,e,this.tileset)}cellAt(e,t,i){var s=~~e,r=~~t,n=this.getRenderer();return!1===i||s>=0&&s<n.cols&&r>=0&&r<n.rows?this.layerData[s][r]:null}clearTile(e,t){this.layerData[e][t]=null,this.preRender&&this.canvasRenderer.clearRect(e*this.tilewidth,t*this.tileheight,this.tilewidth,this.tileheight)}update(e){if(this.isAnimated){for(var t=!1,i=0;i<this.animatedTilesets.length;i++)t=this.animatedTilesets[i].update(e)||t;return t}return!1}draw(e,t){if(this.preRender){var i=Math.min(t.width,this.width),s=Math.min(t.height,this.height);e.drawImage(this.canvasRenderer.getCanvas(),t.pos.x,t.pos.y,i,s,t.pos.x,t.pos.y,i,s)}else this.getRenderer().drawTileLayer(e,this,t)}}class Bounds{constructor(e){this.onResetEvent(e)}onResetEvent(e){void 0===this.min?(this.min={x:1/0,y:1/0},this.max={x:-1/0,y:-1/0}):this.clear(),void 0!==e&&this.update(e),this._center=new Vector2d}clear(){this.setMinMax(1/0,1/0,-1/0,-1/0)}setMinMax(e,t,i,s){this.min.x=e,this.min.y=t,this.max.x=i,this.max.y=s}get x(){return this.min.x}set x(e){var t=this.max.x-this.min.x;this.min.x=e,this.max.x=e+t}get y(){return this.min.y}set y(e){var t=this.max.y-this.min.y;this.min.y=e,this.max.y=e+t}get width(){return this.max.x-this.min.x}set width(e){this.max.x=this.min.x+e}get height(){return this.max.y-this.min.y}set height(e){this.max.y=this.min.y+e}get left(){return this.min.x}get right(){return this.max.x}get top(){return this.min.y}get bottom(){return this.max.y}get centerX(){return this.min.x+this.width/2}get centerY(){return this.min.y+this.height/2}get center(){return this._center.set(this.centerX,this.centerY)}update(e){this.add(e,!0)}add(e,t=!1){!0===t&&this.clear();for(var i=0;i<e.length;i++){var s=e[i];s.x>this.max.x&&(this.max.x=s.x),s.x<this.min.x&&(this.min.x=s.x),s.y>this.max.y&&(this.max.y=s.y),s.y<this.min.y&&(this.min.y=s.y)}}addBounds(e,t=!1){!0===t&&this.clear(),e.max.x>this.max.x&&(this.max.x=e.max.x),e.min.x<this.min.x&&(this.min.x=e.min.x),e.max.y>this.max.y&&(this.max.y=e.max.y),e.min.y<this.min.y&&(this.min.y=e.min.y)}addPoint(e,t){void 0!==t&&(e=t.apply(e)),this.min.x=Math.min(this.min.x,e.x),this.max.x=Math.max(this.max.x,e.x),this.min.y=Math.min(this.min.y,e.y),this.max.y=Math.max(this.max.y,e.y)}addFrame(e,t,i,s,r){var n=me.pool.pull("Vector2d");this.addPoint(n.set(e,t),r),this.addPoint(n.set(i,t),r),this.addPoint(n.set(e,s),r),this.addPoint(n.set(i,s),r),me.pool.push(n)}contains(){var e,t,i,s,r=arguments[0];return 2===arguments.length?(e=t=r,i=s=arguments[1]):r instanceof Bounds?(e=r.min.x,t=r.max.x,i=r.min.y,s=r.max.y):(e=t=r.x,i=s=r.y),e>=this.min.x&&t<=this.max.x&&i>=this.min.y&&s<=this.max.y}overlaps(e){return!(this.right<e.left||this.left>e.right||this.bottom<e.top||this.top>e.bottom)}isFinite(){return isFinite(this.min.x)&&isFinite(this.max.x)&&isFinite(this.min.y)&&isFinite(this.max.y)}translate(){var e,t;2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y),this.min.x+=e,this.max.x+=e,this.min.y+=t,this.max.y+=t}shift(){var e,t;2===arguments.length?(e=arguments[0],t=arguments[1]):(e=arguments[0].x,t=arguments[0].y);var i=this.max.x-this.min.x,s=this.max.y-this.min.y;this.min.x=e,this.max.x=e+i,this.min.y=t,this.max.y=t+s}clone(){var e=new Bounds;return e.addBounds(this),e}toPolygon(){return new Polygon(this.x,this.y,[new Vector2d(0,0),new Vector2d(this.width,0),new Vector2d(this.width,this.height),new Vector2d(0,this.height)])}}class TMXRenderer{constructor(e,t,i,s){this.cols=e,this.rows=t,this.tilewidth=i,this.tileheight=s,this.bounds=new Bounds}canRender(e){return this.tilewidth===e.tilewidth&&this.tileheight===e.tileheight}getBounds(e){var t=e instanceof TMXLayer?pool.pull("Bounds"):this.bounds;return t.setMinMax(0,0,this.cols*this.tilewidth,this.rows*this.tileheight),t}pixelToTileCoords(e,t,i){return i}tileToPixelCoords(e,t,i){return i}drawTile(e,t,i,s){}drawTileLayer(e,t,i){}}class TMXOrthogonalRenderer extends TMXRenderer{constructor(e){super(e.cols,e.rows,e.tilewidth,e.tileheight)}canRender(e){return"orthogonal"===e.orientation&&super.canRender(e)}pixelToTileCoords(e,t,i){return(i||new Vector2d).set(e/this.tilewidth,t/this.tileheight)}tileToPixelCoords(e,t,i){return(i||new Vector2d).set(e*this.tilewidth,t*this.tileheight)}adjustPosition(e){"number"==typeof e.gid&&(e.y-=e.height)}drawTile(e,t,i,s){var r=s.tileset;r.drawTile(e,r.tileoffset.x+t*this.tilewidth,r.tileoffset.y+(i+1)*this.tileheight-r.tileheight,s)}drawTileLayer(e,t,i){var s=1,r=1,n=this.pixelToTileCoords(Math.max(i.pos.x-(t.maxTileSize.width-t.tilewidth),0),Math.max(i.pos.y-(t.maxTileSize.height-t.tileheight),0),pool.pull("Vector2d")).floorSelf(),o=this.pixelToTileCoords(i.pos.x+i.width+this.tilewidth,i.pos.y+i.height+this.tileheight,pool.pull("Vector2d")).ceilSelf();switch(o.x=o.x>this.cols?this.cols:o.x,o.y=o.y>this.rows?this.rows:o.y,t.renderorder){case"right-up":o.y=n.y+(n.y=o.y)-o.y,r=-1;break;case"left-down":o.x=n.x+(n.x=o.x)-o.x,s=-1;break;case"left-up":o.x=n.x+(n.x=o.x)-o.x,o.y=n.y+(n.y=o.y)-o.y,s=-1,r=-1}for(var a=n.y;a!==o.y;a+=r)for(var h=n.x;h!==o.x;h+=s){var l=t.cellAt(h,a,!1);l&&this.drawTile(e,h,a,l)}pool.push(n),pool.push(o)}}class TMXIsometricRenderer extends TMXRenderer{constructor(e){super(e.cols,e.rows,e.tilewidth,e.tileheight),this.hTilewidth=this.tilewidth/2,this.hTileheight=this.tileheight/2,this.originX=this.rows*this.hTilewidth}canRender(e){return"isometric"===e.orientation&&super.canRender(e)}getBounds(e){var t=e instanceof TMXLayer?pool.pull("Bounds"):this.bounds;return t.setMinMax(0,0,(this.cols+this.rows)*(this.tilewidth/2),(this.cols+this.rows)*(this.tileheight/2)),t}pixelToTileCoords(e,t,i){return(i||new Vector2d).set(t/this.tileheight+(e-this.originX)/this.tilewidth,t/this.tileheight-(e-this.originX)/this.tilewidth)}tileToPixelCoords(e,t,i){return(i||new Vector2d).set((e-t)*this.hTilewidth+this.originX,(e+t)*this.hTileheight)}adjustPosition(e){var t=e.x/this.hTilewidth,i=e.y/this.tileheight,s=pool.pull("Vector2d");this.tileToPixelCoords(t,i,s),e.x=s.x,e.y=s.y,pool.push(s)}drawTile(e,t,i,s){var r=s.tileset;r.drawTile(e,(this.cols-1)*r.tilewidth+(t-i)*r.tilewidth>>1,-r.tilewidth+(t+i)*r.tileheight>>2,s)}drawTileLayer(e,t,i){var s=t.tileset,r=this.pixelToTileCoords(i.pos.x-s.tilewidth,i.pos.y-s.tileheight,pool.pull("Vector2d")).floorSelf(),n=this.pixelToTileCoords(i.pos.x+i.width+s.tilewidth,i.pos.y+i.height+s.tileheight,pool.pull("Vector2d")).ceilSelf(),o=this.tileToPixelCoords(n.x,n.y,pool.pull("Vector2d")),a=this.tileToPixelCoords(r.x,r.y,pool.pull("Vector2d"));a.x-=this.hTilewidth,a.y+=this.tileheight;var h=a.y-i.pos.y>this.hTileheight,l=i.pos.x-a.x<this.hTilewidth;h&&(l?(r.x--,a.x-=this.hTilewidth):(r.y--,a.x+=this.hTilewidth),a.y-=this.hTileheight);for(var d=h^l,u=r.clone(),c=2*a.y;c-2*this.tileheight<2*o.y;c+=this.tileheight){u.setV(r);for(var p=a.x;p<o.x;p+=this.tilewidth){var g=t.cellAt(u.x,u.y);if(g){var f=(s=g.tileset).tileoffset;s.drawTile(e,f.x+p,f.y+c/2-s.tileheight,g)}u.x++,u.y--}d?(r.y++,a.x-=this.hTilewidth,d=!1):(r.x++,a.x+=this.hTilewidth,d=!0)}pool.push(u),pool.push(r),pool.push(n),pool.push(o),pool.push(a)}}var offsetsStaggerX=[{x:0,y:0},{x:1,y:-1},{x:1,y:0},{x:2,y:0}],offsetsStaggerY=[{x:0,y:0},{x:-1,y:1},{x:0,y:1},{x:0,y:2}];class TMXHexagonalRenderer extends TMXRenderer{constructor(e){super(e.cols,e.rows,-2&e.tilewidth,-2&e.tileheight),this.hexsidelength=e.hexsidelength||0,this.staggerX="x"===e.staggeraxis,this.staggerEven="even"===e.staggerindex,this.sidelengthx=0,this.sidelengthy=0,"hexagonal"===e.orientation&&(this.staggerX?this.sidelengthx=this.hexsidelength:this.sidelengthy=this.hexsidelength),this.sideoffsetx=(this.tilewidth-this.sidelengthx)/2,this.sideoffsety=(this.tileheight-this.sidelengthy)/2,this.columnwidth=this.sideoffsetx+this.sidelengthx,this.rowheight=this.sideoffsety+this.sidelengthy,this.centers=[new Vector2d,new Vector2d,new Vector2d,new Vector2d]}canRender(e){return"hexagonal"===e.orientation&&super.canRender(e)}getBounds(e){var t=e instanceof TMXLayer?pool.pull("Bounds"):this.bounds;return this.staggerX?(t.setMinMax(0,0,this.cols*this.columnwidth+this.sideoffsetx,this.rows*(this.tileheight+this.sidelengthy)),t.width>1&&(t.height+=this.rowheight)):(t.setMinMax(0,0,this.cols*(this.tilewidth+this.sidelengthx),this.rows*this.rowheight+this.sideoffsety),t.height>1&&(t.width+=this.columnwidth)),t}doStaggerX(e){return this.staggerX&&1&e^this.staggerEven}doStaggerY(e){return!this.staggerX&&1&e^this.staggerEven}topLeft(e,t,i){var s=i||new Vector2d;return this.staggerX?1&e^this.staggerEven?s.set(e-1,t):s.set(e-1,t-1):1&t^this.staggerEven?s.set(e,t-1):s.set(e-1,t-1),s}topRight(e,t,i){var s=i||new Vector2d;return this.staggerX?1&e^this.staggerEven?s.set(e+1,t):s.set(e+1,t-1):1&t^this.staggerEven?s.set(e+1,t-1):s.set(e,t-1),s}bottomLeft(e,t,i){var s=i||new Vector2d;return this.staggerX?1&e^this.staggerEven?s.set(e-1,t+1):s.set(e-1,t):1&t^this.staggerEven?s.set(e,t+1):s.set(e-1,t+1),s}bottomRight(e,t,i){var s=i||new Vector2d;return this.staggerX?1&e^this.staggerEven?s.set(e+1,t+1):s.set(e+1,t):1&t^this.staggerEven?s.set(e+1,t+1):s.set(e,t+1),s}pixelToTileCoords(e,t,i){var s=i||new Vector2d;this.staggerX?e-=this.staggerEven?this.tilewidth:this.sideoffsetx:t-=this.staggerEven?this.tileheight:this.sideoffsety;var r,n,o,a,h=pool.pull("Vector2d",Math.floor(e/(2*this.columnwidth)),Math.floor(t/(2*this.rowheight))),l=pool.pull("Vector2d",e-h.x*(2*this.columnwidth),t-h.y*(2*this.rowheight));this.staggerX?(h.x=2*h.x,this.staggerEven&&++h.x):(h.y=2*h.y,this.staggerEven&&++h.y),this.staggerX?(o=(r=this.sidelengthx/2)+this.columnwidth,a=this.tileheight/2,this.centers[0].set(r,a),this.centers[1].set(o,a-this.rowheight),this.centers[2].set(o,a+this.rowheight),this.centers[3].set(o+this.columnwidth,a)):(n=this.sidelengthy/2,o=this.tilewidth/2,a=n+this.rowheight,this.centers[0].set(o,n),this.centers[1].set(o-this.columnwidth,a),this.centers[2].set(o+this.columnwidth,a),this.centers[3].set(o,a+this.rowheight));for(var d=0,u=Number.MAX_VALUE,c=0;c<4;++c){var p=this.centers[c].sub(l).length2();p<u&&(u=p,d=c)}var g=this.staggerX?offsetsStaggerX:offsetsStaggerY;return s.set(h.x+g[d].x,h.y+g[d].y),pool.push(h),pool.push(l),s}tileToPixelCoords(e,t,i){var s=Math.floor(e),r=Math.floor(t),n=i||new Vector2d;return this.staggerX?(n.y=r*(this.tileheight+this.sidelengthy),this.doStaggerX(s)&&(n.y+=this.rowheight),n.x=s*this.columnwidth):(n.x=s*(this.tilewidth+this.sidelengthx),this.doStaggerY(r)&&(n.x+=this.columnwidth),n.y=r*this.rowheight),n}adjustPosition(e){"number"==typeof e.gid&&(e.y-=e.height)}drawTile(e,t,i,s){var r=s.tileset,n=this.tileToPixelCoords(t,i,pool.pull("Vector2d"));r.drawTile(e,r.tileoffset.x+n.x,r.tileoffset.y+n.y+(this.tileheight-r.tileheight),s),pool.push(n)}drawTileLayer(e,t,i){var s,r=this.pixelToTileCoords(i.pos.x,i.pos.y,pool.pull("Vector2d"));r.sub(t.pos);var n=this.tileToPixelCoords(r.x+t.pos.x,r.y+t.pos.y,pool.pull("Vector2d")),o=r.clone(),a=n.clone(),h=i.pos.y-n.y<this.sideoffsety,l=i.pos.x-n.x<this.sideoffsetx;h&&r.y--,l&&r.x--;var d=t.cols,u=t.rows;if(this.staggerX){r.x=Math.max(0,r.x),r.y=Math.max(0,r.y),n=this.tileToPixelCoords(r.x+t.pos.x,r.y+t.pos.y);for(var c=this.doStaggerX(r.x+t.pos.x);n.y<i.bottom&&r.y<u;){for(o.setV(r),a.setV(n);a.x<i.right&&o.x<d;o.x+=2)(s=t.cellAt(o.x,o.y,!1))&&s.tileset.drawTile(e,a.x,a.y,s),a.x+=this.tilewidth+this.sidelengthx;c?(r.x-=1,r.y+=1,n.x-=this.columnwidth,c=!1):(r.x+=1,n.x+=this.columnwidth,c=!0),n.y+=this.rowheight}pool.push(o),pool.push(a)}else{for(r.x=Math.max(0,r.x),r.y=Math.max(0,r.y),n=this.tileToPixelCoords(r.x+t.pos.x,r.y+t.pos.y),this.doStaggerY(r.y)&&(n.x-=this.columnwidth);n.y<i.bottom&&r.y<u;r.y++){for(o.setV(r),a.setV(n),this.doStaggerY(r.y)&&(a.x+=this.columnwidth);a.x<i.right&&o.x<d;o.x++)(s=t.cellAt(o.x,o.y,!1))&&s.tileset.drawTile(e,a.x,a.y,s),a.x+=this.tilewidth+this.sidelengthx;n.y+=this.rowheight}pool.push(o),pool.push(a)}pool.push(r),pool.push(n)}}class TMXStaggeredRenderer extends TMXHexagonalRenderer{canRender(e){return"staggered"===e.orientation&&super.canRender(e)}pixelToTileCoords(e,t,i){var s=i||new Vector2d,r=e,n=t;this.staggerX?r-=this.staggerEven?this.sideoffsetx:0:n-=this.staggerEven?this.sideoffsety:0;var o=pool.pull("Vector2d",Math.floor(r/this.tilewidth),Math.floor(n/this.tileheight));this.staggerX?(o.x=2*o.x,this.staggerEven&&++o.x):(o.y=2*o.y,this.staggerEven&&++o.y);var a=pool.pull("Vector2d",r-o.x*this.tilewidth,n-o.y*this.tileheight),h=a.x*(this.tileheight/this.tilewidth);return this.sideoffsety-h>a.y&&(o=this.topLeft(o.x,o.y,o)),-this.sideoffsety+h>a.y&&(o=this.topRight(o.x,o.y,o)),this.sideoffsety+h<a.y&&(o=this.bottomLeft(o.x,o.y,o)),3*this.sideoffsety-h<a.y&&(o=this.bottomRight(o.x,o.y,o)),(s=this.tileToPixelCoords(o.x,o.y,s)).set(e-s.x,t-s.y),s.set(s.x-this.tilewidth/2,s.y*(this.tilewidth/this.tileheight)),s.div(this.tilewidth/Math.sqrt(2)).rotate(degToRad(-45)).add(o),pool.push(o),pool.push(a),s}}class TMXTileset{constructor(e){var t=0;if(this.TileProperties=[],this.imageCollection=[],this.firstgid=this.lastgid=+e.firstgid,void 0!==e.source){var i=e.source,s=getExtension(i);if(("tsx"===s||"json"===s)&&!(e=loader.getTMX(getBasename(i))))throw new Error(i+" external TSX/JSON tileset not found")}this.name=e.name,this.tilewidth=+e.tilewidth,this.tileheight=+e.tileheight,this.spacing=+e.spacing||0,this.margin=+e.margin||0,this.tileoffset=new Vector2d,this.isAnimated=!1,this.isCollection=!1,this.animations=new Map,this._lastUpdate=0;var r=e.tiles;for(t in r)if(r.hasOwnProperty(t)){if("animation"in r[t]&&(this.isAnimated=!0,this.animations.set(r[+t].animation[0].tileid,{dt:0,idx:0,frames:r[+t].animation,cur:r[+t].animation[0]})),"properties"in r[t])if(Array.isArray(r[t].properties)){var n={};for(var o in r[t].properties)n[r[t].properties[o].name]=r[t].properties[o].value;this.setTileProperty(+r[t].id+this.firstgid,n)}else this.setTileProperty(+t+this.firstgid,r[t].properties);if("image"in r[t]){var a=loader.getImage(r[t].image);if(!a)throw new Error("melonJS: '"+r[t].image+"' file for tile '"+(+t+this.firstgid)+"' not found!");this.imageCollection[+t+this.firstgid]=a}}this.isCollection=this.imageCollection.length>0;var h=e.tileoffset;h&&(this.tileoffset.x=+h.x,this.tileoffset.y=+h.y);var l=e.tileproperties;if(l)for(t in l)l.hasOwnProperty(t)&&this.setTileProperty(+t+this.firstgid,l[t]);if(!1===this.isCollection){if(this.image=loader.getImage(e.image),!this.image)throw new Error("melonJS: '"+e.image+"' file for tileset '"+this.name+"' not found!");this.texture=renderer.cache.get(this.image,{framewidth:this.tilewidth,frameheight:this.tileheight,margin:this.margin,spacing:this.spacing}),this.atlas=this.texture.getAtlas();var d=+e.columns||Math.round(this.image.width/(this.tilewidth+this.spacing)),u=Math.round(this.image.height/(this.tileheight+this.spacing));e.tilecount%d>0&&++u,this.lastgid=this.firstgid+(d*u-1||0),e.tilecount&&this.lastgid-this.firstgid+1!=+e.tilecount&&console.warn("Computed tilecount ("+(this.lastgid-this.firstgid+1)+") does not match expected tilecount ("+e.tilecount+")")}}getTileImage(e){return this.imageCollection[e]}setTileProperty(e,t){this.TileProperties[e]=t}contains(e){return e>=this.firstgid&&e<=this.lastgid}getViewTileId(e){var t=e-this.firstgid;return this.animations.has(t)?this.animations.get(t).cur.tileid:t}getTileProperties(e){return this.TileProperties[e]}update(e){var t=0,i=timer$1.getTime(),s=!1;return this._lastUpdate!==i&&(this._lastUpdate=i,this.animations.forEach((function(i){for(i.dt+=e,t=i.cur.duration;i.dt>=t;)i.dt-=t,i.idx=(i.idx+1)%i.frames.length,i.cur=i.frames[i.idx],t=i.cur.duration,s=!0}))),s}drawTile(e,t,i,s){if(s.flipped&&(e.save(),e.translate(t,i),e.transform(s.currentTransform),t=i=0),!0===this.isCollection)e.drawImage(this.imageCollection[s.tileId],0,0,s.width,s.height,t,i,s.width,s.height);else{var r=this.atlas[this.getViewTileId(s.tileId)].offset;e.drawImage(this.image,r.x,r.y,this.tilewidth,this.tileheight,t,i,this.tilewidth+e.uvOffset,this.tileheight+e.uvOffset)}s.flipped&&e.restore()}}var TMX_CLEAR_BIT_MASK=536870911;class TMXTilesetGroup{constructor(){this.tilesets=[],this.length=0}add(e){this.tilesets.push(e),this.length++}getTilesetByIndex(e){return this.tilesets[e]}getTilesetByGid(e){var t=-1;e&=TMX_CLEAR_BIT_MASK;for(var i=0,s=this.tilesets.length;i<s;i++){if(this.tilesets[i].contains(e))return this.tilesets[i];this.tilesets[i].firstgid===this.tilesets[i].lastgid&&e>=this.tilesets[i].firstgid&&(t=i)}if(-1!==t)return this.tilesets[t];throw new Error("no matching tileset found for gid "+e)}}class TMXObject{constructor(e,t,i){this.points=void 0,this.name=t.name,this.x=+t.x,this.y=+t.y,this.z=+i,this.width=+t.width||0,this.height=+t.height||0,this.gid=+t.gid||null,this.tintcolor=t.tintcolor,this.type=t.type,this.type=t.type,this.rotation=degToRad(+t.rotation||0),this.id=+t.id||void 0,this.orientation=e.orientation,this.shapes=void 0,this.isEllipse=!1,this.isPolygon=!1,this.isPolyLine=!1,"number"==typeof this.gid?this.setTile(e.tilesets):void 0!==t.ellipse?this.isEllipse=!0:void 0!==t.polygon?(this.points=t.polygon,this.isPolygon=!0):void 0!==t.polyline&&(this.points=t.polyline,this.isPolyLine=!0),void 0!==t.text?(this.text=t.text,this.text.font=t.text.fontfamily||"sans-serif",this.text.size=t.text.pixelsize||16,this.text.fillStyle=t.text.color||"#000000",this.text.textAlign=t.text.halign||"left",this.text.textBaseline=t.text.valign||"top",this.text.width=this.width,this.text.height=this.height,applyTMXProperties(this.text,t)):(applyTMXProperties(this,t),this.shapes||(this.shapes=this.parseTMXShapes())),e.isEditor||e.getRenderer().adjustPosition(this)}setTile(e){var t=e.getTilesetByGid(this.gid);!1===t.isCollection&&(this.width=this.framewidth=t.tilewidth,this.height=this.frameheight=t.tileheight),this.tile=new Tile(this.x,this.y,this.gid,t)}parseTMXShapes(){var e=0,t=[];if(!0===this.isEllipse)t.push(new Ellipse(this.width/2,this.height/2,this.width,this.height).rotate(this.rotation));else if(!0===this.isPolygon)t.push(new Polygon(0,0,this.points).rotate(this.rotation));else if(!0===this.isPolyLine){var i,s,r=this.points,n=r.length-1;for(e=0;e<n;e++)i=new Vector2d(r[e].x,r[e].y),s=new Vector2d(r[e+1].x,r[e+1].y),0!==this.rotation&&(i=i.rotate(this.rotation),s=s.rotate(this.rotation)),t.push(new Line(0,0,[i,s]))}else t.push(new Polygon(0,0,[new Vector2d,new Vector2d(this.width,0),new Vector2d(this.width,this.height),new Vector2d(0,this.height)]).rotate(this.rotation));if("isometric"===this.orientation)for(e=0;e<t.length;e++)t[e].toIso();return t}getObjectPropertyByName(e){return this[e]}}class TMXGroup{constructor(e,t,i){this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.tintcolor=t.tintcolor,this.z=i,this.objects=[];var s=void 0===t.visible||t.visible;this.opacity=!0===s?clamp(+t.opacity||1,0,1):0,applyTMXProperties(this,t),t.objects&&t.objects.forEach((t=>{t.tintcolor=this.tintcolor,this.objects.push(new TMXObject(e,t,i))})),t.layers&&t.layers.forEach((t=>{var s=new TMXLayer(e,t,e.tilewidth,e.tileheight,e.orientation,e.tilesets,i++);s.setRenderer(e.getRenderer()),this.width=Math.max(this.width,s.width),this.height=Math.max(this.height,s.height),this.objects.push(s)}))}destroy(){this.objects=null}getObjectCount(){return this.objects.length}getObjectByIndex(e){return this.objects[e]}}var COLLISION_GROUP="collision";function getNewDefaultRenderer(e){switch(e.orientation){case"orthogonal":return new TMXOrthogonalRenderer(e);case"isometric":return new TMXIsometricRenderer(e);case"hexagonal":return new TMXHexagonalRenderer(e);case"staggered":return new TMXStaggeredRenderer(e);default:throw new Error(e.orientation+" type TMX Tile Map not supported!")}}function readLayer(e,t,i){return new TMXLayer(e,t,e.tilewidth,e.tileheight,e.orientation,e.tilesets,i)}function readImageLayer(e,t,i){applyTMXProperties(t.properties,t);var s=pool.pull("ImageLayer",+t.offsetx||+t.x||0,+t.offsety||+t.y||0,Object.assign({name:t.name,image:t.image,ratio:pool.pull("Vector2d",+t.parallaxx||1,+t.parallaxy||1),tint:void 0!==t.tintcolor?pool.pull("Color").parseHex(t.tintcolor,!0):void 0,z:i},t.properties)),r=void 0===t.visible||t.visible;return s.setOpacity(r?+t.opacity:0),s}function readTileset(e){return new TMXTileset(e)}function readObjectGroup(e,t,i){return new TMXGroup(e,t,i)}class TMXTileMap{constructor(e,t){if(this.data=t,this.name=e,this.cols=+t.width,this.rows=+t.height,this.tilewidth=+t.tilewidth,this.tileheight=+t.tileheight,this.infinite=+t.infinite,this.orientation=t.orientation,this.renderorder=t.renderorder||"right-down",this.version=t.version,this.tiledversion=t.tiledversion,this.tilesets=null,void 0===this.layers&&(this.layers=[]),void 0===this.objectGroups&&(this.objectGroups=[]),this.isEditor="melon-editor"===t.editor,this.nextobjectid=+t.nextobjectid||void 0,this.hexsidelength=+t.hexsidelength,this.staggeraxis=t.staggeraxis,this.staggerindex=t.staggerindex,this.bounds=this.getRenderer().getBounds().clone(),this.width=this.bounds.width,this.height=this.bounds.height,this.backgroundcolor=t.backgroundcolor,applyTMXProperties(this,t),this.initialized=!1,1===this.infinite)throw new Error("Tiled Infinite Map not supported!")}getRenderer(){return void 0!==this.renderer&&this.renderer.canRender(this)||(this.renderer=getNewDefaultRenderer(this)),this.renderer}getBounds(){return this.bounds}readMapObjects(e){if(!0!==this.initialized){var t=0;this.tilesets||(this.tilesets=new TMXTilesetGroup),void 0!==e.tilesets&&e.tilesets.forEach((e=>{this.tilesets.add(readTileset(e))})),this.backgroundcolor&&this.layers.push(pool.pull("ColorLayer","background_color",this.backgroundcolor,t++)),this.background_image&&this.layers.push(pool.pull("ImageLayer",0,0,{name:"background_image",image:this.background_image,z:t++})),e.layers.forEach((e=>{switch(e.type){case"imagelayer":this.layers.push(readImageLayer(this,e,t++));break;case"tilelayer":this.layers.push(readLayer(this,e,t++));break;case"objectgroup":case"group":this.objectGroups.push(readObjectGroup(this,e,t++))}})),this.initialized=!0}}addTo(e,t,i){var s=e.autoSort,r=e.autoDepth,n=this.getBounds();function o(t,i){viewport.setBounds(0,0,Math.max(n.width,t),Math.max(n.height,i)),e.pos.set(Math.max(0,~~((t-n.width)/2)),Math.max(0,~~((i-n.height)/2)),e.pos.z)}e.autoSort=!1,e.autoDepth=!1,this.getLayers().forEach((function(t){e.addChild(t)})),this.getObjects(t).forEach((function(t){e.addChild(t)})),e.resize(this.bounds.width,this.bounds.height),e.sort(!0),!0===i&&(off(VIEWPORT_ONRESIZE,o),o(viewport.width,viewport.height),on(VIEWPORT_ONRESIZE,o,this)),e.autoSort=s,e.autoDepth=r}getObjects(e){var t,i=[],s=!1;this.readMapObjects(this.data);for(var r=0;r<this.objectGroups.length;r++){var n=this.objectGroups[r];s=n.name.toLowerCase().includes(COLLISION_GROUP),!1===e&&((t=new Container(0,0,this.width,this.height)).anchorPoint.set(0,0),t.name=n.name,t.pos.z=n.z,t.setOpacity(n.opacity),t.autoSort=!1,t.autoDepth=!1);for(var o=0;o<n.objects.length;o++){var a,h=n.objects[o];void 0===h.anchorPoint&&(h.anchorPoint={x:0,y:0}),void 0!==h.tintcolor&&(h.tint=pool.pull("Color"),h.tint.parseHex(h.tintcolor,!0)),h instanceof TMXLayer?a=h:"object"==typeof h.text?(void 0===h.text.anchorPoint&&(h.text.anchorPoint=h.anchorPoint),(a=!0===h.text.bitmap?pool.pull("BitmapText",h.x,h.y,h.text):pool.pull("Text",h.x,h.y,h.text)).pos.z=h.z):"object"==typeof h.tile?((a=h.tile.getRenderable(h)).body=new Body(a,h.shapes||new Rect(0,0,this.width,this.height)),a.body.setStatic(!0),a.pos.setMuted(h.x,h.y,h.z)):(void 0!==h.name&&""!==h.name?a=pool.pull(h.name,h.x,h.y,h):((a=pool.pull("Renderable",h.x,h.y,h.width,h.height)).anchorPoint.set(0,0),a.name=h.name,a.type=h.type,a.id=h.id,a.body=new Body(a,h.shapes||new Rect(0,0,a.width,a.height)),a.body.setStatic(!0),a.resize(a.body.getBounds().width,a.body.getBounds().height)),a.pos.z=h.z),s&&!h.name&&a.body&&(a.body.collisionType=collision.types.WORLD_SHAPE),!1!==e?(!0===a.isRenderable&&(a.setOpacity(a.getOpacity()*n.opacity),a.renderable instanceof Renderable&&a.renderable.setOpacity(a.renderable.getOpacity()*n.opacity)),i.push(a)):t.addChild(a)}!1===e&&t.children.length>0&&(t.autoSort=!0,t.autoDepth=!0,i.push(t))}return i}getLayers(){return this.readMapObjects(this.data),this.layers}destroy(){this.tilesets=void 0,this.layers.length=0,this.objectGroups.length=0,this.initialized=!1}}var levels={},levelIdx=[],currentLevelIdx=0;function safeLoadLevel(e,t,i){t.container.reset(),reset(),levels[level.getCurrentLevelId()]&&levels[level.getCurrentLevelId()].destroy(),currentLevelIdx=levelIdx.indexOf(e),loadTMXLevel(e,t.container,t.flatten,t.setViewportBounds),emit(LEVEL_LOADED,e),t.onLoaded(e),i&&state.restart()}function loadTMXLevel(e,t,i,s){var r=levels[e];utils.resetGUID(e,r.nextobjectid),t.anchorPoint.set(0,0),r.addTo(t,i,s)}var level={add(e,t,i){if("tmx"===e)return null==levels[t]&&(levels[t]=new TMXTileMap(t,loader.getTMX(t)),levelIdx.push(t),i&&i(),!0);throw new Error("no level loader defined for format "+e)},load(e,t){if(t=Object.assign({container:world,onLoaded:onLevelLoaded,flatten:mergeGroup,setViewportBounds:!0},t||{}),void 0===levels[e])throw new Error("level "+e+" not found");if(!(levels[e]instanceof TMXTileMap))throw new Error("no level loader defined");return state.isRunning()?(state.stop(),utils.function.defer(safeLoadLevel,this,e,t,!0)):safeLoadLevel(e,t),!0},getCurrentLevelId:()=>levelIdx[currentLevelIdx],getCurrentLevel(){return levels[this.getCurrentLevelId()]},reload(e){return this.load(this.getCurrentLevelId(),e)},next(e){return currentLevelIdx+1<levelIdx.length&&this.load(levelIdx[currentLevelIdx+1],e)},previous(e){return currentLevelIdx-1>=0&&this.load(levelIdx[currentLevelIdx-1],e)},levelCount:()=>levelIdx.length},imgList={},tmxList={},binList={},jsonList={},baseURL={},resourceCount=0,loadCount=0,timerId$1=0;function checkLoadStatus(e){if(loadCount===resourceCount){if(!e&&!loader.onload)throw new Error("no load callback defined");clearTimeout(timerId$1);var t=e||loader.onload;setTimeout((function(){t(),emit(LOADER_COMPLETE)}),300)}else timerId$1=setTimeout((function(){checkLoadStatus(e)}),100)}function preloadImage(e,t,i){imgList[e.name]=new Image,imgList[e.name].onload=t,imgList[e.name].onerror=i,"string"==typeof loader.crossOrigin&&(imgList[e.name].crossOrigin=loader.crossOrigin),imgList[e.name].src=e.src+loader.nocache}function preloadFontFace(e,t,i){var s=new FontFace(e.name,e.src);s.load().then((function(){document.fonts.add(s),document.body.style.fontFamily=e.name,t()}),(function(){i(e.name)}))}function preloadTMX(e,t,i){function s(t){tmxList[e.name]=t,"tmx"===e.type&&level.add(e.type,e.name)}if(e.data)return s(e.data),void t();var r=new XMLHttpRequest,n=getExtension(e.src);r.overrideMimeType&&("json"===n?r.overrideMimeType("application/json"):r.overrideMimeType("text/xml")),r.open("GET",e.src+loader.nocache,!0),r.withCredentials=loader.withCredentials,r.ontimeout=i,r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status||0===r.status&&r.responseText){var o=null;switch(n){case"xml":case"tmx":case"tsx":if(device$1.ua.match(/msie/i)||!r.responseXML){if(!window.DOMParser)throw new Error("XML file format loading not supported, use the JSON file format instead");o=(new DOMParser).parseFromString(r.responseText,"text/xml")}else o=r.responseXML;var a=parse(o);switch(n){case"tmx":o=a.map;break;case"tsx":o=a.tilesets[0]}break;case"json":o=JSON.parse(r.responseText);break;default:throw new Error("TMX file format "+n+"not supported !")}s(o),t()}else i(e.name)},r.send()}function preloadJSON(e,t,i){var s=new XMLHttpRequest;s.overrideMimeType&&s.overrideMimeType("application/json"),s.open("GET",e.src+loader.nocache,!0),s.withCredentials=loader.withCredentials,s.ontimeout=i,s.onreadystatechange=function(){4===s.readyState&&(200===s.status||0===s.status&&s.responseText?(jsonList[e.name]=JSON.parse(s.responseText),t()):i(e.name))},s.send()}function preloadBinary(e,t,i){var s=new XMLHttpRequest;s.open("GET",e.src+loader.nocache,!0),s.withCredentials=loader.withCredentials,s.responseType="arraybuffer",s.onerror=i,s.onload=function(){var i=s.response;if(i){for(var r=new Uint8Array(i),n=[],o=0;o<r.byteLength;o++)n[o]=String.fromCharCode(r[o]);binList[e.name]=n.join(""),t()}},s.send()}function preloadJavascript(e,t,i){var s=document.createElement("script");s.src=e.src,s.type="text/javascript","string"==typeof loader.crossOrigin&&(s.crossOrigin=loader.crossOrigin),s.defer=!0,s.onload=function(){t()},s.onerror=function(){i(e.name)},document.getElementsByTagName("body")[0].appendChild(s)}var loader={nocache:"",onload:void 0,onProgress:void 0,crossOrigin:void 0,withCredentials:!1,onResourceLoaded(e){var t=++loadCount/resourceCount;this.onProgress&&this.onProgress(t,e),emit(LOADER_PROGRESS,t,e)},onLoadingError(e){throw new Error("Failed loading resource "+e.src)},setNocache(e){this.nocache=e?"?"+~~(1e7*Math.random()):""},setBaseURL(e,t){"*"!==e?baseURL[e]=t:(baseURL.audio=t,baseURL.binary=t,baseURL.image=t,baseURL.json=t,baseURL.js=t,baseURL.tmx=t,baseURL.tsx=t)},preload(e,t,i=!0){for(var s=0;s<e.length;s++)resourceCount+=this.load(e[s],this.onResourceLoaded.bind(this,e[s]),this.onLoadingError.bind(this,e[s]));void 0!==t&&(this.onload=t),!0===i&&state.change(state.LOADING),checkLoadStatus(t)},load(e,t,i){switch(void 0!==baseURL[e.type]&&(e.src=baseURL[e.type]+e.src),e.type){case"binary":return preloadBinary.call(this,e,t,i),1;case"image":return preloadImage.call(this,e,t,i),1;case"json":return preloadJSON.call(this,e,t,i),1;case"js":return preloadJavascript.call(this,e,t,i),1;case"tmx":case"tsx":return preloadTMX.call(this,e,t,i),1;case"audio":return load(e,!!e.stream,t,i),1;case"fontface":return preloadFontFace.call(this,e,t,i),1;default:throw new Error("load : unknown or invalid resource type : "+e.type)}},unload(e){switch(e.type){case"binary":return e.name in binList&&(delete binList[e.name],!0);case"image":return e.name in imgList&&(delete imgList[e.name],!0);case"json":return e.name in jsonList&&(delete jsonList[e.name],!0);case"js":case"fontface":return!0;case"tmx":case"tsx":return e.name in tmxList&&(delete tmxList[e.name],!0);case"audio":return unload(e.name);default:throw new Error("unload : unknown or invalid resource type : "+e.type)}},unloadAll(){var e;for(e in binList)binList.hasOwnProperty(e)&&this.unload({name:e,type:"binary"});for(e in imgList)imgList.hasOwnProperty(e)&&this.unload({name:e,type:"image"});for(e in tmxList)tmxList.hasOwnProperty(e)&&this.unload({name:e,type:"tmx"});for(e in jsonList)jsonList.hasOwnProperty(e)&&this.unload({name:e,type:"json"});unloadAll()},getTMX:e=>(e=""+e)in tmxList?tmxList[e]:null,getBinary:e=>(e=""+e)in binList?binList[e]:null,getImage:e=>(e=getBasename(""+e))in imgList?imgList[e]:null,getJSON:e=>(e=""+e)in jsonList?jsonList[e]:null},audioTracks={},current_track_id=null,retry_counter=0,audioExts=[],soundLoadError=function(e,t){if(retry_counter++>3)throw new Error("melonJS: failed loading "+e);audioTracks[e].load()};let stopOnAudioError=!0;function init$1(e="mp3"){return audioExts=e.split(","),!howler.Howler.noAudio}function hasFormat(e){return hasAudio()&&howler.Howler.codecs(e)}function hasAudio(){return!howler.Howler.noAudio}function enable(){unmuteAll()}function disable(){muteAll()}function load(e,t,i,s){var r=[];if(0===audioExts.length)throw new Error("target audio extension(s) should be set through me.audio.init() before calling the preloader.");for(var n=0;n<audioExts.length;n++)r.push(e.src+e.name+"."+audioExts[n]+loader.nocache);return audioTracks[e.name]=new howler.Howl({src:r,volume:howler.Howler.volume(),html5:!0===t,xhrWithCredentials:loader.withCredentials,onloaderror(){soundLoadError.call(this,e.name,s)},onload(){retry_counter=0,i&&i()}}),1}function play(e,t=!1,i,s){var r=audioTracks[e];if(r&&void 0!==r){var n=r.play();return"boolean"==typeof t&&r.loop(t,n),r.volume("number"==typeof s?clamp(s,0,1):howler.Howler.volume(),n),"function"==typeof i&&(!0===t?r.on("end",i,n):r.once("end",i,n)),n}throw new Error("audio clip "+e+" does not exist")}function fade(e,t,i,s,r){var n=audioTracks[e];if(!n||void 0===n)throw new Error("audio clip "+e+" does not exist");n.fade(t,i,s,r)}function seek(e,...t){var i=audioTracks[e];if(i&&void 0!==i)return i.seek(...t);throw new Error("audio clip "+e+" does not exist")}function rate(e,...t){var i=audioTracks[e];if(i&&void 0!==i)return i.rate(...t);throw new Error("audio clip "+e+" does not exist")}function stop(e,t){if(void 0!==e){var i=audioTracks[e];if(!i||void 0===i)throw new Error("audio clip "+e+" does not exist");i.stop(t),i.off("end",void 0,t)}else howler.Howler.stop()}function pause(e,t){var i=audioTracks[e];if(!i||void 0===i)throw new Error("audio clip "+e+" does not exist");i.pause(t)}function resume(e,t){var i=audioTracks[e];if(!i||void 0===i)throw new Error("audio clip "+e+" does not exist");i.play(t)}function playTrack(e,t){return play(current_track_id=e,!0,null,t)}function stopTrack(){null!==current_track_id&&(audioTracks[current_track_id].stop(),current_track_id=null)}function pauseTrack(){null!==current_track_id&&audioTracks[current_track_id].pause()}function resumeTrack(){null!==current_track_id&&audioTracks[current_track_id].play()}function getCurrentTrack(){return current_track_id}function setVolume(e){howler.Howler.volume(e)}function getVolume(){return howler.Howler.volume()}function mute(e,t,i){i=void 0===i||!!i;var s=audioTracks[e];if(!s||void 0===s)throw new Error("audio clip "+e+" does not exist");s.mute(i,t)}function unmute(e,t){mute(e,t,!1)}function muteAll(){howler.Howler.mute(!0)}function unmuteAll(){howler.Howler.mute(!1)}function muted(){return howler.Howler._muted}function unload(e){return e in audioTracks&&(audioTracks[e].unload(),delete audioTracks[e],!0)}function unloadAll(){for(var e in audioTracks)audioTracks.hasOwnProperty(e)&&unload(e)}var audio=Object.freeze({__proto__:null,stopOnAudioError,init:init$1,hasFormat,hasAudio,enable,disable,load,play,fade,seek,rate,stop,pause,resume,playTrack,stopTrack,pauseTrack,resumeTrack,getCurrentTrack,setVolume,getVolume,mute,unmute,muteAll,unmuteAll,muted,unload,unloadAll}),data={};function isReserved(e){return"add"===e||"remove"===e}on(BOOT,(()=>{if(!0===device$1.localStorage){var e=localStorage.getItem("me.save");"string"==typeof e&&e.length>0&&(JSON.parse(e)||[]).forEach((function(e){data[e]=JSON.parse(localStorage.getItem("me.save."+e))}))}}));var save={add(e){var t=save;Object.keys(e).forEach((function(i){var s;isReserved(i)||(s=i,Object.defineProperty(t,s,{configurable:!0,enumerable:!0,get:()=>data[s],set(e){data[s]=e,!0===device$1.localStorage&&localStorage.setItem("me.save."+s,JSON.stringify(e))}}),i in data||(t[i]=e[i]))})),!0===device$1.localStorage&&localStorage.setItem("me.save",JSON.stringify(Object.keys(data)))},remove(e){isReserved(e)||void 0!==data[e]&&(delete data[e],!0===device$1.localStorage&&(localStorage.removeItem("me.save."+e),localStorage.setItem("me.save",JSON.stringify(Object.keys(data)))))}};let accelInitialized=!1,deviceOrientationInitialized=!1,swipeEnabled=!0;function _disableSwipeFn(e){return e.preventDefault(),"function"==typeof window.scroll&&window.scroll(0,0),!1}let readyBound=!1,isReady=!1,readyList=[];function _domReady(){if(!isReady){if(!document.body)return setTimeout(_domReady,13);for(document.removeEventListener&&document.removeEventListener("DOMContentLoaded",this._domReady,!1),window.removeEventListener("load",_domReady,!1);readyList.length;)readyList.shift().call(window,[]);isReady=!0}}let _domRect={left:0,top:0,x:0,y:0,width:0,height:0,right:0,bottom:0};function _detectDevice(){device.iOS=/iPhone|iPad|iPod/i.test(device.ua),device.android=/Android/i.test(device.ua),device.android2=/Android 2/i.test(device.ua),device.linux=/Linux/i.test(device.ua),device.chromeOS=/CrOS/.test(device.ua),device.wp=/Windows Phone/i.test(device.ua),device.BlackBerry=/BlackBerry/i.test(device.ua),device.Kindle=/Kindle|Silk.*Mobile Safari/i.test(device.ua),device.isMobile=/Mobi/i.test(device.ua)||device.iOS||device.android||device.wp||device.BlackBerry||device.Kindle||!1,device.ejecta=void 0!==window.ejecta,device.isWeixin=/MicroMessenger/i.test(device.ua)}function _checkCapabilities(){_detectDevice(),device.isMobile&&device.enableSwipe(!1),device.TouchEvent=!!("ontouchstart"in window),device.PointerEvent=!!window.PointerEvent,window.gesture=prefixed("gesture"),device.touch=device.TouchEvent||device.PointerEvent,device.maxTouchPoints=device.touch?device.PointerEvent?navigator.maxTouchPoints||1:10:1,device.wheel="onwheel"in document.createElement("div"),device.hasPointerLockSupport=prefixed("pointerLockElement",document),device.hasPointerLockSupport&&(document.exitPointerLock=prefixed("exitPointerLock",document)),device.hasDeviceOrientation=!!window.DeviceOrientationEvent,device.hasAccelerometer=!!window.DeviceMotionEvent,device.ScreenOrientation="undefined"!=typeof screen&&void 0!==screen.orientation,device.hasFullscreenSupport=prefixed("fullscreenEnabled",document)||document.mozFullScreenEnabled,document.exitFullscreen=prefixed("cancelFullScreen",document)||prefixed("exitFullscreen",document),navigator.vibrate=prefixed("vibrate",navigator),device.hasWebAudio=!(!window.AudioContext&&!window.webkitAudioContext);try{device.localStorage=!!window.localStorage}catch(e){device.localStorage=!1}try{device.OffscreenCanvas=void 0!==window.OffscreenCanvas&&null!==new OffscreenCanvas(0,0).getContext("2d")}catch(e){device.OffscreenCanvas=!1}var e,t;window.addEventListener("blur",(function(){device.stopOnBlur&&state.stop(!0),device.pauseOnBlur&&state.pause(!0)}),!1),window.addEventListener("focus",(function(){device.stopOnBlur&&state.restart(!0),device.resumeOnFocus&&state.resume(!0),device.autoFocus&&device.focus()}),!1),void 0!==document.hidden?(e="hidden",t="visibilitychange"):void 0!==document.mozHidden?(e="mozHidden",t="mozvisibilitychange"):void 0!==document.msHidden?(e="msHidden",t="msvisibilitychange"):void 0!==document.webkitHidden&&(e="webkitHidden",t="webkitvisibilitychange"),"string"==typeof t&&document.addEventListener(t,(function(){document[e]?(device.stopOnBlur&&state.stop(!0),device.pauseOnBlur&&state.pause(!0)):(device.stopOnBlur&&state.restart(!0),device.resumeOnFocus&&state.resume(!0))}),!1)}on(BOOT,(()=>{_checkCapabilities()}));let device={ua:navigator.userAgent,localStorage:!1,hasAccelerometer:!1,hasDeviceOrientation:!1,ScreenOrientation:!1,hasFullscreenSupport:!1,hasPointerLockSupport:!1,hasWebAudio:!1,nativeBase64:"function"==typeof window.atob,maxTouchPoints:1,touch:!1,wheel:!1,isMobile:!1,iOS:!1,android:!1,android2:!1,linux:!1,ejecta:!1,isWeixin:!1,chromeOS:!1,wp:!1,BlackBerry:!1,Kindle:!1,accelerationX:0,accelerationY:0,accelerationZ:0,gamma:0,beta:0,alpha:0,language:navigator.language||navigator.browserLanguage||navigator.userLanguage||"en",pauseOnBlur:!0,resumeOnFocus:!0,autoFocus:!0,stopOnBlur:!1,OffscreenCanvas:!1,onReady(e){isReady?e.call(window,[]):(readyList.push(e),readyBound||("complete"===document.readyState?window.setTimeout(_domReady,0):(document.addEventListener&&document.addEventListener("DOMContentLoaded",_domReady,!1),window.addEventListener("load",_domReady,!1)),readyBound=!0))},enableSwipe(e){!1!==e?!1===swipeEnabled&&(window.document.removeEventListener("touchmove",_disableSwipeFn,!1),swipeEnabled=!0):!0===swipeEnabled&&(window.document.addEventListener("touchmove",_disableSwipeFn,!1),swipeEnabled=!1)},requestFullscreen(e){this.hasFullscreenSupport&&((e=e||getParent()).requestFullscreen=prefixed("requestFullscreen",e)||e.mozRequestFullScreen,e.requestFullscreen())},exitFullscreen(){this.hasFullscreenSupport&&document.exitFullscreen()},getScreenOrientation(){var e="portrait",t="landscape",i=window.screen;if(!0===this.ScreenOrientation){var s=prefixed("orientation",i);if(void 0!==s&&"string"==typeof s.type)return s.type;if("string"==typeof s)return s}return"number"==typeof window.orientation?90===Math.abs(window.orientation)?t:e:window.outerWidth>window.outerHeight?t:e},lockOrientation(e){var t=window.screen;if(void 0!==t){var i=prefixed("lockOrientation",t);if(void 0!==i)return i(e)}return!1},unlockOrientation(e){var t=window.screen;if(void 0!==t){var i=prefixed("unlockOrientation",t);if(void 0!==i)return i(e)}return!1},isPortrait(){return this.getScreenOrientation().includes("portrait")},isLandscape(){return this.getScreenOrientation().includes("landscape")},getStorage(e="local"){if("local"===e)return save;throw new Error("storage type "+e+" not supported")},getParentElement(e){var t=this.getElement(e);return null!==t.parentNode&&(t=t.parentNode),t},getElement(e){var t=null;return"undefined"!==e&&("string"==typeof e?t=document.getElementById(e):"object"==typeof e&&e.nodeType===Node.ELEMENT_NODE&&(t=e)),t||(t=document.body),t},getElementBounds:e=>"object"==typeof e&&e!==document.body&&void 0!==e.getBoundingClientRect?e.getBoundingClientRect():(_domRect.width=_domRect.right=window.innerWidth,_domRect.height=_domRect.bottom=window.innerHeight,_domRect),getParentBounds(e){return this.getElementBounds(this.getParentElement(e))},isWebGLSupported(e){var t=!1;try{var i=document.createElement("canvas"),s={stencil:!0,failIfMajorPerformanceCaveat:e.failIfMajorPerformanceCaveat};t=!(!window.WebGLRenderingContext||!i.getContext("webgl",s)&&!i.getContext("experimental-webgl",s))}catch(e){t=!1}return t},getMaxShaderPrecision:e=>e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?"highp":e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp",focus(){"function"==typeof window.focus&&window.focus()},onDeviceMotion(e){this.accelerationX=e.accelerationIncludingGravity.x,this.accelerationY=e.accelerationIncludingGravity.y,this.accelerationZ=e.accelerationIncludingGravity.z},onDeviceRotate(e){this.gamma=e.gamma,this.beta=e.beta,this.alpha=e.alpha},turnOnPointerLock(){if(this.hasPointerLockSupport){var e=getParent();if(this.ua.match(/Firefox/i)){var t=function(){(prefixed("fullscreenElement",document)||document.mozFullScreenElement)===e&&(document.removeEventListener("fullscreenchange",t),document.removeEventListener("mozfullscreenchange",t),e.requestPointerLock=prefixed("requestPointerLock",e),e.requestPointerLock())};document.addEventListener("fullscreenchange",t,!1),document.addEventListener("mozfullscreenchange",t,!1),this.requestFullscreen()}else e.requestPointerLock()}},turnOffPointerLock(){this.hasPointerLockSupport&&document.exitPointerLock()},watchAccelerometer(){return this.hasAccelerometer&&!accelInitialized&&(DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e&&(window.addEventListener("devicemotion",this.onDeviceMotion,!1),accelInitialized=!0)})).catch(console.error):(window.addEventListener("devicemotion",this.onDeviceMotion,!1),accelInitialized=!0)),accelInitialized},unwatchAccelerometer(){accelInitialized&&(window.removeEventListener("devicemotion",this.onDeviceMotion,!1),accelInitialized=!1)},watchDeviceOrientation(){return this.hasDeviceOrientation&&!deviceOrientationInitialized&&("function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((e=>{"granted"===e&&(window.addEventListener("deviceorientation",this.onDeviceRotate,!1),deviceOrientationInitialized=!0)})).catch(console.error):(window.addEventListener("deviceorientation",this.onDeviceRotate,!1),deviceOrientationInitialized=!0)),deviceOrientationInitialized},unwatchDeviceOrientation(){deviceOrientationInitialized&&(window.removeEventListener("deviceorientation",this.onDeviceRotate,!1),deviceOrientationInitialized=!1)},vibrate(e){navigator.vibrate&&navigator.vibrate(e)}};Object.defineProperty(device,"devicePixelRatio",{get:function(){return window.devicePixelRatio||1}}),Object.defineProperty(device,"isFullscreen",{get:function(){return!(!this.hasFullscreenSupport||!prefixed("fullscreenElement",document)&&!document.mozFullScreenElement)}}),Object.defineProperty(device,"sound",{get:function(){return hasAudio()}});var device$1=device;function extractUniforms(e,t){var i,s={},r=/uniform\s+(\w+)\s+(\w+)/g,n={},o={},a={};return[t.vertex,t.fragment].forEach((function(e){for(;i=r.exec(e);)n[i[2]]=i[1]})),Object.keys(n).forEach((function(i){var s=n[i];a[i]=e.getUniformLocation(t.program,i),o[i]={get:function(e){return function(){return a[e]}}(i),set:function(t,i,s){return 0===i.indexOf("mat")?function(i){e[s](a[t],!1,i)}:function(i){var r=s;i.length&&"v"!==s.substr(-1)&&(r+="v"),e[r](a[t],i)}}(i,s,"uniform"+fnHash[s])}})),Object.defineProperties(s,o),s}function extractAttributes(e,t){for(var i,s={},r=/attribute\s+\w+\s+(\w+)/g,n=0;i=r.exec(t.vertex);)s[i[1]]=n++;return s}function compileShader(e,t,i){var s=e.createShader(t);if(e.shaderSource(s,i),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(s));return s}function compileProgram(e,t,i,s){var r=compileShader(e,e.VERTEX_SHADER,t),n=compileShader(e,e.FRAGMENT_SHADER,i),o=e.createProgram();for(var a in e.attachShader(o,r),e.attachShader(o,n),s)e.bindAttribLocation(o,s[a],a);if(e.linkProgram(o),!e.getProgramParameter(o,e.LINK_STATUS)){var h="Error initializing Shader "+this+"\ngl.VALIDATE_STATUS: "+e.getProgramParameter(o,e.VALIDATE_STATUS)+"\ngl.getError()"+e.getError()+"\ngl.getProgramInfoLog()"+e.getProgramInfoLog(o);throw e.deleteProgram(o),o=null,new Error(h)}return e.useProgram(o),e.deleteShader(r),e.deleteShader(n),o}var fnHash={bool:"1i",int:"1i",float:"1f",vec2:"2fv",vec3:"3fv",vec4:"4fv",bvec2:"2iv",bvec3:"3iv",bvec4:"4iv",ivec2:"2iv",ivec3:"3iv",ivec4:"4iv",mat2:"Matrix2fv",mat3:"Matrix3fv",mat4:"Matrix4fv",sampler2D:"1i"};function setPrecision(e,t){return"precision"!==e.substring(0,9)?"precision "+t+" float;"+e:e}function minify(e){return(e=(e=(e=e.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")).replace(/(\\n\s+)|(\s+\\n)/g,"")).replace(/(\\r|\\n)+/g,"")).replace(/\s*([;,[\](){}\\\/\-+*|^&!=<>?~%])\s*/g,"$1")}class GLShader{constructor(e,t,i,s){return this.gl=e,this.vertex=setPrecision(minify(t),s||device$1.getMaxShaderPrecision(this.gl)),this.fragment=setPrecision(minify(i),s||device$1.getMaxShaderPrecision(this.gl)),this.attributes=extractAttributes(this.gl,this),this.program=compileProgram(this.gl,this.vertex,this.fragment,this.attributes),this.uniforms=extractUniforms(this.gl,this),on(WEBGL_ONCONTEXT_LOST,this.destroy,this),this}bind(){this.gl.useProgram(this.program)}getAttribLocation(e){var t=this.attributes[e];return void 0!==t?t:-1}setUniform(e,t){var i=this.uniforms;if(void 0===i[e])throw new Error("undefined ("+e+") uniform for shader "+this);"object"==typeof t&&"function"==typeof t.toArray?i[e]=t.toArray():i[e]=t}destroy(){this.uniforms=null,this.attributes=null,this.gl.deleteProgram(this.program),this.vertex=null,this.fragment=null}}class VertexArrayBuffer{constructor(e,t){return this.vertexSize=e,this.quadSize=t,this.maxVertex=256,this.vertexCount=0,this.buffer=new ArrayBuffer(this.maxVertex*this.vertexSize*this.quadSize),this.bufferF32=new Float32Array(this.buffer),this.bufferU32=new Uint32Array(this.buffer),this}clear(){this.vertexCount=0}isFull(e=0){return this.vertexCount+e>=this.maxVertex}resize(){this.maxVertex<<=1;var e=this.bufferF32;return this.buffer=new ArrayBuffer(this.maxVertex*this.vertexSize*this.quadSize),this.bufferF32=new Float32Array(this.buffer),this.bufferU32=new Uint32Array(this.buffer),this.bufferF32.set(e),this}push(e,t,i,s,r){var n=this.vertexCount*this.vertexSize;return this.vertexCount>=this.maxVertex&&this.resize(),this.bufferF32[n+0]=e,this.bufferF32[n+1]=t,void 0!==i&&(this.bufferF32[n+2]=i,this.bufferF32[n+3]=s),void 0!==r&&(this.bufferU32[n+4]=r),this.vertexCount++,this}toFloat32(e,t){return void 0!==t?this.bufferF32.subarray(e,t):this.bufferF32}toUint32(e,t){return void 0!==t?this.bufferU32.subarray(e,t):this.bufferU32}length(){return this.vertexCount}isEmpty(){return 0===this.vertexCount}}var primitiveVertex="// Current vertex point\nattribute vec2 aVertex;\n\n// Projection matrix\nuniform mat4 uProjectionMatrix;\n\n// Vertex color\nuniform vec4 uColor;\n\n// Fragment color\nvarying vec4 vColor;\n\nvoid main(void) {\n    // Transform the vertex position by the projection matrix\n    gl_Position = uProjectionMatrix * vec4(aVertex, 0.0, 1.0);\n    // Pass the remaining attributes to the fragment shader\n    vColor = vec4(uColor.rgb * uColor.a, uColor.a);\n}\n",primitiveFragment="varying vec4 vColor;\n\nvoid main(void) {\n    gl_FragColor = vColor;\n}\n",quadVertex="attribute vec2 aVertex;\nattribute vec2 aRegion;\nattribute vec4 aColor;\n\nuniform mat4 uProjectionMatrix;\n\nvarying vec2 vRegion;\nvarying vec4 vColor;\n\nvoid main(void) {\n    // Transform the vertex position by the projection matrix\n     gl_Position = uProjectionMatrix * vec4(aVertex, 0.0, 1.0);\n    // Pass the remaining attributes to the fragment shader\n    vColor = vec4(aColor.bgr * aColor.a, aColor.a);\n    vRegion = aRegion;\n}\n",quadFragment="uniform sampler2D uSampler;\nvarying vec4 vColor;\nvarying vec2 vRegion;\n\nvoid main(void) {\n    gl_FragColor = texture2D(uSampler, vRegion) * vColor;\n}\n",V_ARRAY=[new Vector2d,new Vector2d,new Vector2d,new Vector2d],VERTEX_SIZE=2,REGION_SIZE=2,COLOR_SIZE=4,ELEMENT_SIZE=VERTEX_SIZE+REGION_SIZE+COLOR_SIZE,ELEMENT_OFFSET=ELEMENT_SIZE*Float32Array.BYTES_PER_ELEMENT,ELEMENTS_PER_QUAD=4,INDICES_PER_QUAD=6,MAX_LENGTH=16e3;function createIB(){for(var e=[0,1,2,2,1,3],t=new Array(MAX_LENGTH*INDICES_PER_QUAD),i=0;i<t.length;i++)t[i]=e[i%INDICES_PER_QUAD]+~~(i/INDICES_PER_QUAD)*ELEMENTS_PER_QUAD;return new Uint16Array(t)}class WebGLCompositor{constructor(e){this.init(e)}init(e){var t=e.gl;this.currentTextureUnit=-1,this.boundTextures=[],this.renderer=e,this.gl=e.gl,this.color=e.currentColor,this.viewMatrix=e.currentTransform,this.activeShader=null,this.mode=t.TRIANGLES,this.attributes=[],this.primitiveShader=new GLShader(this.gl,primitiveVertex,primitiveFragment),this.quadShader=new GLShader(this.gl,quadVertex,quadFragment),this.addAttribute("aVertex",2,t.FLOAT,!1,0*Float32Array.BYTES_PER_ELEMENT),this.addAttribute("aRegion",2,t.FLOAT,!1,2*Float32Array.BYTES_PER_ELEMENT),this.addAttribute("aColor",4,t.UNSIGNED_BYTE,!0,4*Float32Array.BYTES_PER_ELEMENT),t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ARRAY_BUFFER,MAX_LENGTH*ELEMENT_OFFSET*ELEMENTS_PER_QUAD,t.STREAM_DRAW),this.vertexBuffer=new VertexArrayBuffer(ELEMENT_SIZE,ELEMENTS_PER_QUAD),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ELEMENT_ARRAY_BUFFER,createIB(),t.STATIC_DRAW),on(CANVAS_ONRESIZE,((e,t)=>{this.flush(),this.setViewport(0,0,e,t)})),this.reset()}reset(){this.gl=this.renderer.gl,this.flush(),this.setViewport(0,0,this.renderer.getScreenCanvas().width,this.renderer.getScreenCanvas().height),this.clearColor(0,0,0,0);for(var e=0;e<this.renderer.maxTextures;e++){var t=this.boundTextures[e];null!==t&&this.gl.deleteTexture(t),this.boundTextures[e]=null}this.currentTextureUnit=-1,this.useShader(this.quadShader)}addAttribute(e,t,i,s,r){this.attributes.push({name:e,size:t,type:i,normalized:s,offset:r})}setViewport(e,t,i,s){this.gl.viewport(e,t,i,s)}createTexture2D(e,t,i,s="no-repeat",r,n,o,a=!0,h=!0){var l=this.gl,d=isPowerOfTwo(r||t.width)&&isPowerOfTwo(n||t.height),u=l.createTexture(),c=0===s.search(/^repeat(-x)?$/)&&(d||this.renderer.WebGLVersion>1)?l.REPEAT:l.CLAMP_TO_EDGE,p=0===s.search(/^repeat(-y)?$/)&&(d||this.renderer.WebGLVersion>1)?l.REPEAT:l.CLAMP_TO_EDGE;return this.bindTexture2D(u,e),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,c),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,p),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,i),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,i),l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a),r||n||o?l.texImage2D(l.TEXTURE_2D,0,l.RGBA,r,n,o,l.RGBA,l.UNSIGNED_BYTE,t):l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,t),d&&!1!==h&&l.generateMipmap(l.TEXTURE_2D),u}bindTexture2D(e,t){var i=this.gl;e!==this.boundTextures[t]?(this.flush(),this.currentTextureUnit!==t&&(this.currentTextureUnit=t,i.activeTexture(i.TEXTURE0+t)),i.bindTexture(i.TEXTURE_2D,e),this.boundTextures[t]=e):this.currentTextureUnit!==t&&(this.flush(),this.currentTextureUnit=t,i.activeTexture(i.TEXTURE0+t))}unbindTexture2D(e){var t=this.renderer.cache.getUnit(e);this.boundTextures[t]=null}uploadTexture(e,t,i,s,r){var n=this.renderer.cache.getUnit(e),o=this.boundTextures[n];return null===o||r?this.createTexture2D(n,e.getTexture(),this.renderer.settings.antiAlias?this.gl.LINEAR:this.gl.NEAREST,e.repeat,t,i,s,e.premultipliedAlpha):this.bindTexture2D(o,n),this.currentTextureUnit}useShader(e){if(this.activeShader!==e){this.flush(),this.activeShader=e,this.activeShader.bind(),this.activeShader.setUniform("uProjectionMatrix",this.renderer.projectionMatrix);for(var t=0;t<this.attributes.length;++t){var i=this.gl,s=this.attributes[t],r=this.activeShader.getAttribLocation(s.name);-1!==r?(i.enableVertexAttribArray(r),i.vertexAttribPointer(r,s.size,s.type,s.normalized,ELEMENT_OFFSET,s.offset)):i.disableVertexAttribArray(t)}}}addQuad(e,t,i,s,r,n,o,a,h,l){if(!(this.color.alpha<1/255)){this.useShader(this.quadShader),this.vertexBuffer.isFull(4)&&this.flush();var d=this.uploadTexture(e);this.quadShader.setUniform("uSampler",d);var u=this.viewMatrix,c=V_ARRAY[0].set(t,i),p=V_ARRAY[1].set(t+s,i),g=V_ARRAY[2].set(t,i+r),f=V_ARRAY[3].set(t+s,i+r);u.isIdentity()||(u.apply(c),u.apply(p),u.apply(g),u.apply(f)),this.vertexBuffer.push(c.x,c.y,n,o,l),this.vertexBuffer.push(p.x,p.y,a,o,l),this.vertexBuffer.push(g.x,g.y,n,h,l),this.vertexBuffer.push(f.x,f.y,a,h,l)}}flush(e=this.mode){var t=this.vertexBuffer,i=t.vertexCount;if(i>0){var s=this.gl,r=t.vertexSize;this.renderer.WebGLVersion>1?s.bufferData(s.ARRAY_BUFFER,t.toFloat32(),s.STREAM_DRAW,0,i*r):s.bufferData(s.ARRAY_BUFFER,t.toFloat32(0,i*r),s.STREAM_DRAW),this.activeShader===this.primitiveShader?s.drawArrays(e,0,i):s.drawElements(e,i/t.quadSize*INDICES_PER_QUAD,s.UNSIGNED_SHORT,0),t.clear()}}drawVertices(e,t,i=t.length){this.useShader(this.primitiveShader),this.primitiveShader.setUniform("uColor",this.color);for(var s=this.viewMatrix,r=this.vertexBuffer,n=s.isIdentity(),o=0;o<i;o++)n||s.apply(t[o]),r.push(t[o].x,t[o].y);this.flush(e)}clearColor(e,t,i,s){this.gl.clearColor(e,t,i,s)}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}class WebGLRenderer extends Renderer{constructor(e){super(e),this.WebGLVersion=1,this.GPUVendor=null,this.GPURenderer=null,this.context=this.gl=this.getContextGL(this.getScreenCanvas(),e.transparent),this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this._colorStack=[],this._matrixStack=[],this._scissorStack=[],this._glPoints=[new Vector2d,new Vector2d,new Vector2d,new Vector2d],this.currentTransform=new Matrix2d,this.currentCompositor=null;var t=this.settings.compositor||WebGLCompositor;this.setCompositor(new t(this)),this.gl.disable(this.gl.DEPTH_TEST),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.enable(this.gl.BLEND),this.setBlendMode(this.settings.blendMode);var i=this.gl.getExtension("WEBGL_debug_renderer_info");return null!==i&&(this.GPUVendor=this.gl.getParameter(i.UNMASKED_VENDOR_WEBGL),this.GPURenderer=this.gl.getParameter(i.UNMASKED_RENDERER_WEBGL)),this.cache=new TextureCache(this.maxTextures),this.getScreenCanvas().addEventListener("webglcontextlost",(e=>{e.preventDefault(),this.isContextValid=!1,emit(WEBGL_ONCONTEXT_LOST,this)}),!1),this.getScreenCanvas().addEventListener("webglcontextrestored",(()=>{this.reset(),this.isContextValid=!0,emit(WEBGL_ONCONTEXT_RESTORED,this)}),!1),this}reset(){super.reset(),!1===this.isContextValid?this.currentCompositor.init(this):this.currentCompositor.reset(),this.gl.disable(this.gl.SCISSOR_TEST),void 0!==this.fontContext2D&&this.createFontTexture(this.cache)}setCompositor(e){null!==this.currentCompositor&&this.currentCompositor!==e&&this.currentCompositor.flush(),this.currentCompositor=e}resetTransform(){this.currentTransform.identity()}createFontTexture(e){if(void 0===this.fontTexture){var t=this.backBufferCanvas,i=t.width,s=t.height;1===this.WebGLVersion&&(isPowerOfTwo(i)||(i=nextPowerOfTwo(t.width)),isPowerOfTwo(s)||(s=nextPowerOfTwo(t.height)));var r=createCanvas(i,s,!0);this.fontContext2D=this.getContext2d(r),this.fontTexture=new Texture(createAtlas(t.width,t.height,"fontTexture"),r,e),this.currentCompositor.uploadTexture(this.fontTexture,0,0,0)}else e.set(this.fontContext2D.canvas,this.fontTexture)}createPattern(e,t){if(!(1!==renderer.WebGLVersion||isPowerOfTwo(e.width)&&isPowerOfTwo(e.height))){var i=void 0!==e.src?e.src:e;throw new Error("[WebGL Renderer] "+i+" is not a POT texture ("+e.width+"x"+e.height+")")}var s=new Texture(createAtlas(e.width,e.height,"pattern",t),e);return this.currentCompositor.uploadTexture(s),s}flush(){this.currentCompositor.flush()}clearColor(e,t){var i;this.save(),i=e instanceof Color?e.toArray():this.getColor().parseCSS(e).toArray(),this.currentCompositor.clearColor(i[0],i[1],i[2],!0===t?1:i[3]),this.currentCompositor.clear(),this.currentCompositor.clearColor(0,0,0,0),this.restore()}clearRect(e,t,i,s){var r=this.currentColor.clone();this.currentColor.copy("#000000"),this.fillRect(e,t,i,s),this.currentColor.copy(r),pool.push(r)}drawFont(e){var t=this.getFontContext();this.currentCompositor.uploadTexture(this.fontTexture,0,0,0,!0);var i=this.fontTexture.getUVs(e.left+","+e.top+","+e.width+","+e.height);this.currentCompositor.addQuad(this.fontTexture,e.left,e.top,e.width,e.height,i[0],i[1],i[2],i[3],this.currentTint.toUint32()),t.clearRect(e.left,e.top,e.width,e.height)}drawImage(e,t,i,s,r,n,o,a,h){void 0===s?(s=a=e.width,r=h=e.height,n=t,o=i,t=0,i=0):void 0===n&&(n=t,o=i,a=s,h=r,s=e.width,r=e.height,t=0,i=0),!1===this.settings.subPixel&&(n|=0,o|=0);var l=this.cache.get(e),d=l.getUVs(t+","+i+","+s+","+r);this.currentCompositor.addQuad(l,n,o,a,h,d[0],d[1],d[2],d[3],this.currentTint.toUint32())}drawPattern(e,t,i,s,r){var n=e.getUVs("0,0,"+s+","+r);this.currentCompositor.addQuad(e,t,i,s,r,n[0],n[1],n[2],n[3],this.currentTint.toUint32())}getScreenContext(){return this.gl}getContextGL(e,t){if(null==e)throw new Error("You must pass a canvas element in order to create a GL context");"boolean"!=typeof t&&(t=!0);var i,s={alpha:t,antialias:this.settings.antiAlias,depth:!1,stencil:!0,preserveDrawingBuffer:!1,premultipliedAlpha:t,powerPreference:this.settings.powerPreference,failIfMajorPerformanceCaveat:this.settings.failIfMajorPerformanceCaveat};if(!1===this.settings.preferWebGL1&&(i=e.getContext("webgl2",s))&&(this.WebGLVersion=2),i||(this.WebGLVersion=1,i=e.getContext("webgl",s)||e.getContext("experimental-webgl",s)),!i)throw new Error("A WebGL context could not be created.");return i}getContext(){return this.gl}setBlendMode(e,t){(t=t||this.gl).enable(t.BLEND),"multiply"===e?(t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.currentBlendMode=e):(t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),this.currentBlendMode="normal")}getFontContext(){return void 0===this.fontContext2D&&(console.warn("[WebGL Renderer] WARNING : Using Standard me.Text with WebGL will severly impact performances !"),this.createFontTexture(this.cache)),this.fontContext2D}restore(){if(0!==this._matrixStack.length){var e=this._colorStack.pop(),t=this._matrixStack.pop();this.currentColor.copy(e),this.currentTransform.copy(t),pool.push(e),pool.push(t)}0!==this._scissorStack.length?this.currentScissor.set(this._scissorStack.pop()):(this.gl.disable(this.gl.SCISSOR_TEST),this.currentScissor[0]=0,this.currentScissor[1]=0,this.currentScissor[2]=this.backBufferCanvas.width,this.currentScissor[3]=this.backBufferCanvas.height)}save(){this._colorStack.push(this.currentColor.clone()),this._matrixStack.push(this.currentTransform.clone()),this.gl.isEnabled(this.gl.SCISSOR_TEST)&&this._scissorStack.push(this.currentScissor.slice())}rotate(e){this.currentTransform.rotate(e)}scale(e,t){this.currentTransform.scale(e,t)}setAntiAlias(e,t){super.setAntiAlias(e,t)}setGlobalAlpha(e){this.currentColor.alpha=e}setColor(e){var t=this.currentColor.alpha;this.currentColor.copy(e),this.currentColor.alpha*=t}setLineWidth(e){this.getScreenContext().lineWidth(e)}strokeArc(e,t,i,s,r,n=!1,o){if(!0===o)this.fillArc(e,t,i,s,r,n);else{var a,h=this._glPoints,l=Math.floor(24*Math.sqrt(2*i)),d=(r-s)/(2*l),u=2*d,c=Math.cos(d),p=Math.sin(d);for(a=h.length;a<l+1;a++)h.push(new Vector2d);for(a=0;a<l;a++){var g=d+s+u*a,f=Math.cos(g),m=-Math.sin(g);h[a].x=e+(c*f+p*m)*i,h[a].y=t+(c*-m+p*f)*i}this.currentCompositor.drawVertices(this.gl.LINE_STRIP,h,l)}}fillArc(e,t,i,s,r){var n,o=this._glPoints,a=0,h=Math.floor(24*Math.sqrt(2*i)),l=(r-s)/(2*h),d=2*l,u=Math.cos(l),c=Math.sin(l);for(n=o.length;n<2*h;n++)o.push(new Vector2d);for(n=0;n<h-1;n++){var p=l+s+d*n,g=Math.cos(p),f=-Math.sin(p);o[a++].set(e,t),o[a++].set(e-(u*g+c*f)*i,t-(u*-f+c*g)*i)}this.currentCompositor.drawVertices(this.gl.TRIANGLE_STRIP,o,a)}strokeEllipse(e,t,i,s,r=!1){if(!0===r)this.fillEllipse(e,t,i,s);else{var n,o=Math.floor(24*Math.sqrt(i))||Math.floor(12*Math.sqrt(i+s)),a=TAU/o,h=this._glPoints;for(n=h.length;n<o;n++)h.push(new Vector2d);for(n=0;n<o;n++)h[n].x=e+Math.sin(a*-n)*i,h[n].y=t+Math.cos(a*-n)*s;this.currentCompositor.drawVertices(this.gl.LINE_LOOP,h,o)}}fillEllipse(e,t,i,s){var r,n=Math.floor(24*Math.sqrt(i))||Math.floor(12*Math.sqrt(i+s)),o=TAU/n,a=this._glPoints,h=0;for(r=a.length;r<2*(n+1);r++)a.push(new Vector2d);for(r=0;r<n+1;r++)a[h++].set(e,t),a[h++].set(e+Math.sin(o*r)*i,t+Math.cos(o*r)*s);this.currentCompositor.drawVertices(this.gl.TRIANGLE_STRIP,a,h)}strokeLine(e,t,i,s){var r=this._glPoints;r[0].x=e,r[0].y=t,r[1].x=i,r[1].y=s,this.currentCompositor.drawVertices(this.gl.LINE_STRIP,r,2)}fillLine(e,t,i,s){this.strokeLine(e,t,i,s)}strokePolygon(e,t=!1){if(!0===t)this.fillPolygon(e);else{var i,s=e.points.length,r=this._glPoints;for(i=r.length;i<s;i++)r.push(new Vector2d);for(i=0;i<s;i++)r[i].x=e.pos.x+e.points[i].x,r[i].y=e.pos.y+e.points[i].y;this.currentCompositor.drawVertices(this.gl.LINE_LOOP,r,s)}}fillPolygon(e){var t,i=e.points,s=this._glPoints,r=e.getIndices(),n=e.pos.x,o=e.pos.y;for(t=s.length;t<r.length;t++)s.push(new Vector2d);for(t=0;t<r.length;t++)s[t].set(n+i[r[t]].x,o+i[r[t]].y);this.currentCompositor.drawVertices(this.gl.TRIANGLES,s,r.length)}strokeRect(e,t,i,s,r=!1){if(!0===r)this.fillRect(e,t,i,s);else{var n=this._glPoints;n[0].x=e,n[0].y=t,n[1].x=e+i,n[1].y=t,n[2].x=e+i,n[2].y=t+s,n[3].x=e,n[3].y=t+s,this.currentCompositor.drawVertices(this.gl.LINE_LOOP,n,4)}}fillRect(e,t,i,s){var r=this._glPoints;r[0].x=e+i,r[0].y=t,r[1].x=e,r[1].y=t,r[2].x=e+i,r[2].y=t+s,r[3].x=e,r[3].y=t+s,this.currentCompositor.drawVertices(this.gl.TRIANGLE_STRIP,r,4)}setTransform(e){this.resetTransform(),this.transform(e)}transform(e){var t=this.currentTransform;if(t.multiply(e),!1===this.settings.subPixel){var i=t.toArray();i[6]|=0,i[7]|=0}}translate(e,t){var i=this.currentTransform;if(i.translate(e,t),!1===this.settings.subPixel){var s=i.toArray();s[6]|=0,s[7]|=0}}clipRect(e,t,i,s){var r=this.backBufferCanvas,n=this.gl;if(0!==e||0!==t||i!==r.width||s!==r.height){var o=this.currentScissor;if(n.isEnabled(n.SCISSOR_TEST)&&o[0]===e&&o[1]===t&&o[2]===i&&o[3]===s)return;this.flush(),n.enable(this.gl.SCISSOR_TEST),n.scissor(e+this.currentTransform.tx,r.height-s-t-this.currentTransform.ty,i,s),o[0]=e,o[1]=t,o[2]=i,o[3]=s}else n.disable(n.SCISSOR_TEST)}setMask(e){var t=this.gl;this.flush(),t.enable(t.STENCIL_TEST),t.clear(t.STENCIL_BUFFER_BIT),t.colorMask(!1,!1,!1,!1),t.stencilFunc(t.NOTEQUAL,1,1),t.stencilOp(t.REPLACE,t.REPLACE,t.REPLACE),this.fill(e),this.flush(),t.colorMask(!0,!0,!0,!0),t.stencilFunc(t.EQUAL,1,1),t.stencilOp(t.KEEP,t.KEEP,t.KEEP)}clearMask(){this.flush(),this.gl.disable(this.gl.STENCIL_TEST)}}var designRatio=1,designWidth=0,designHeight=0,settings={parent:document.body,renderer:2,doubleBuffering:!1,autoScale:!1,scale:1,scaleMethod:"fit",transparent:!1,blendMode:"normal",antiAlias:!1,failIfMajorPerformanceCaveat:!0,subPixel:!1,preferWebGL1:!1,powerPreference:"default",verbose:!1,consoleHeader:!0};function autoDetectRenderer(e){try{if(device$1.isWebGLSupported(e))return new WebGLRenderer(e)}catch(e){console.log("Error creating WebGL renderer :"+e.message)}return new CanvasRenderer(e)}function onresize(){var e=renderer.settings,t=1,i=1;if(e.autoScale){var s=1/0,r=1/0;if(window.getComputedStyle){var n=window.getComputedStyle(renderer.getScreenCanvas(),null);s=parseInt(n.maxWidth,10)||1/0,r=parseInt(n.maxHeight,10)||1/0}var o=device$1.getParentBounds(getParent()),a=Math.min(s,o.width),h=Math.min(r,o.height),l=a/h;if("fill-min"===e.scaleMethod&&l>designRatio||"fill-max"===e.scaleMethod&&l<designRatio||"flex-width"===e.scaleMethod){var d=Math.min(s,designHeight*l);t=i=a/d,renderer.resize(Math.floor(d),designHeight)}else if("fill-min"===e.scaleMethod&&l<designRatio||"fill-max"===e.scaleMethod&&l>designRatio||"flex-height"===e.scaleMethod){var u=Math.min(r,designWidth*(h/a));t=i=h/u,renderer.resize(designWidth,Math.floor(u))}else"flex"===e.scaleMethod?renderer.resize(Math.floor(a),Math.floor(h)):"stretch"===e.scaleMethod?(t=a/designWidth,i=h/designHeight):t=i=l<designRatio?a/designWidth:h/designHeight;scale(t,i)}}const CANVAS=0,WEBGL=1,AUTO=2;let parent=null,scaleRatio=new Vector2d(1,1),renderer=null;function init(e,t,i){if(!initialized)throw new Error("me.video.init() called before engine initialization.");(settings=Object.assign(settings,i||{})).width=e,settings.height=t,settings.doubleBuffering=!!settings.doubleBuffering,settings.transparent=!!settings.transparent,settings.antiAlias=!!settings.antiAlias,settings.failIfMajorPerformanceCaveat=!!settings.failIfMajorPerformanceCaveat,settings.subPixel=!!settings.subPixel,settings.verbose=!!settings.verbose,-1!==settings.scaleMethod.search(/^(fill-(min|max)|fit|flex(-(width|height))?|stretch)$/)?settings.autoScale="auto"===settings.scale||!0:(settings.scaleMethod="fit",settings.autoScale="auto"===settings.scale||!1),!1!==settings.consoleHeader&&console.log("melonJS 2 (v"+version+") | http://melonjs.org");var s=utils.getUriFragment();!0!==s.webgl&&!0!==s.webgl1&&!0!==s.webgl2||(settings.renderer=WEBGL,!0===s.webgl1&&(settings.preferWebGL1=!0)),settings.scale=settings.autoScale?1:+settings.scale||1,scaleRatio.set(settings.scale,settings.scale),(settings.autoScale||1!==settings.scale)&&(settings.doubleBuffering=!0),designRatio=e/t,designWidth=e,designHeight=t,settings.zoomX=e*scaleRatio.x,settings.zoomY=t*scaleRatio.y,window.addEventListener("resize",utils.function.throttle((function(e){emit(WINDOW_ONRESIZE,e)}),100),!1),window.addEventListener("orientationchange",(function(e){emit(WINDOW_ONORIENTATION_CHANGE,e)}),!1),window.addEventListener("onmozorientationchange",(function(e){emit(WINDOW_ONORIENTATION_CHANGE,e)}),!1),!0===device$1.ScreenOrientation&&(window.screen.orientation.onchange=function(e){emit(WINDOW_ONORIENTATION_CHANGE,e)}),window.addEventListener("scroll",utils.function.throttle((function(e){emit(WINDOW_ONSCROLL,e)}),100),!1),on(WINDOW_ONRESIZE,onresize,this),on(WINDOW_ONORIENTATION_CHANGE,onresize,this);try{switch(settings.renderer){case AUTO:case WEBGL:renderer=autoDetectRenderer(settings);break;default:renderer=new CanvasRenderer(settings)}}catch(e){return console(e.message),!1}if(parent=device$1.getElement(settings.parent),parent.appendChild(renderer.getScreenCanvas()),onresize(),"MutationObserver"in window&&new MutationObserver(onresize.bind(this)).observe(parent,{attributes:!1,childList:!0,subtree:!0}),!1!==settings.consoleHeader){var r=renderer instanceof CanvasRenderer?"CANVAS":"WebGL"+renderer.WebGLVersion,n=device$1.hasWebAudio?"Web Audio":"HTML5 Audio",o="string"==typeof renderer.GPURenderer?" ("+renderer.GPURenderer+")":"";console.log(r+" renderer"+o+" | "+n+" | pixel ratio "+device$1.devicePixelRatio+" | "+(device$1.isMobile?"mobile":"desktop")+" | "+device$1.getScreenOrientation()+" | "+device$1.language),console.log("resolution: requested "+e+"x"+t+", got "+renderer.getWidth()+"x"+renderer.getHeight())}return emit(VIDEO_INIT),!0}function createCanvas(e,t,i){var s;if(0===e||0===t)throw new Error("width or height was zero, Canvas could not be initialized !");return!0===device$1.OffscreenCanvas&&!0===i?void 0===(s=new OffscreenCanvas(0,0)).style&&(s.style={}):s=document.createElement("canvas"),s.width=e,s.height=t,s}function getParent(){return parent}function scale(e,t){var i=renderer.getScreenCanvas(),s=renderer.getScreenContext(),r=renderer.settings,n=device$1.devicePixelRatio,o=r.zoomX=i.width*e*n,a=r.zoomY=i.height*t*n;scaleRatio.set(e*n,t*n),i.style.width=o/n+"px",i.style.height=a/n+"px",renderer.setAntiAlias(s,r.antiAlias),renderer.setBlendMode(r.blendMode,s),repaint()}var video=Object.freeze({__proto__:null,CANVAS,WEBGL,AUTO,get parent(){return parent},scaleRatio,get renderer(){return renderer},init,createCanvas,getParent,scale}),GUID_base="",GUID_index=0,utils={agent:agentUtils,array:arrayUtils,file:fileUtils,string:stringUtils,function:fnUtils,getPixels:function(e){if(e instanceof HTMLImageElement){var t=CanvasRenderer.getContext2d(createCanvas(e.width,e.height));return t.drawImage(e,0,0),t.getImageData(0,0,e.width,e.height)}return e.getContext("2d").getImageData(0,0,e.width,e.height)},checkVersion:function(e,t=version){for(var i=e.split("."),s=t.split("."),r=Math.min(i.length,s.length),n=0,o=0;o<r&&!(n=+i[o]-+s[o]);o++);return n||i.length-s.length},getUriFragment:function(e){var t={};if(void 0===e){var i=document.location;if(!i||!i.hash)return t;e=i.hash}else{var s=e.indexOf("#");if(-1===s)return t;e=e.substr(s,e.length)}return e.substr(1).split("&").filter((function(e){return""!==e})).forEach((function(e){var i=e.split("="),s=i.shift(),r=i.join("=");t[s]=r||!0})),t},resetGUID:function(e,t=0){GUID_base=toHex$1(e.toString().toUpperCase()),GUID_index=t},createGUID:function(e=1){return GUID_index+=e,GUID_base+"-"+(e||GUID_index)}},framecount=0,framedelta=0,last=0,now=0,delta=0,step=0,minstep=0,timers=[],timerId=0;function update(e){last=now,(delta=(now=e)-last)<0&&(delta=0),timer.tick=delta>minstep&&timer.interpolation?delta/step:1,updateTimers()}function clearTimer(e){for(var t=0,i=timers.length;t<i;t++)if(timers[t].timerId===e){timers.splice(t,1);break}}function updateTimers(){for(var e=0,t=timers.length;e<t;e++){var i=timers[e];i.pauseable&&state.isPaused()||(i.elapsed+=delta),i.elapsed>=i.delay&&(i.fn.apply(null,i.args),!0===i.repeat?i.elapsed-=i.delay:timer.clearTimeout(i.timerId))}}on(BOOT,(()=>{timer.reset(),now=last=0,on(GAME_BEFORE_UPDATE,update)}));var timer={tick:1,fps:0,maxfps:60,interpolation:!1,reset(){last=now=window.performance.now(),delta=0,framedelta=0,framecount=0,step=Math.ceil(1e3/this.maxfps),minstep=1e3/this.maxfps*1.25},setTimeout(e,t,i){return timers.push({fn:e,delay:t,elapsed:0,repeat:!1,timerId:++timerId,pauseable:!0===i||!0,args:arguments.length>3?Array.prototype.slice.call(arguments,3):void 0}),timerId},setInterval(e,t,i){return timers.push({fn:e,delay:t,elapsed:0,repeat:!0,timerId:++timerId,pauseable:!0===i||!0,args:arguments.length>3?Array.prototype.slice.call(arguments,3):void 0}),timerId},clearTimeout(e){utils.function.defer(clearTimer,this,e)},clearInterval(e){utils.function.defer(clearTimer,this,e)},getTime:()=>now,getDelta:()=>delta,countFPS(){framecount++,framedelta+=delta,framecount%10==0&&(this.fps=clamp(Math.round(1e3*framecount/framedelta),0,this.maxfps),framedelta=0,framecount=0)}},timer$1=timer,lastTime=0,vendors=["ms","moz","webkit","o"],x,requestAnimationFrame=window.requestAnimationFrame,cancelAnimationFrame=window.cancelAnimationFrame;for(x=0;x<vendors.length&&!requestAnimationFrame;++x)requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];for(x=0;x<vendors.length&&!cancelAnimationFrame;++x)cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"];requestAnimationFrame&&cancelAnimationFrame||(requestAnimationFrame=function(e){var t=window.performance.now(),i=Math.max(0,1e3/timer$1.maxfps-(t-lastTime)),s=window.setTimeout((function(){e(t+i)}),i);return lastTime=t+i,s},cancelAnimationFrame=function(e){window.clearTimeout(e)},window.requestAnimationFrame=requestAnimationFrame,window.cancelAnimationFrame=cancelAnimationFrame);var plugins={};class BasePlugin{constructor(){this.version="10.2.1"}}var plugin={Base:BasePlugin,patch:function(e,t,i){if(void 0!==e.prototype&&(e=e.prototype),"function"!=typeof e[t])throw new Error(t+" is not an existing function");var s=e[t];Object.defineProperty(e,t,{configurable:!0,value:function(e,t){return function(){this._patched=s;var e=t.apply(this,arguments);return this._patched=null,e}}(0,i)})},register:function(e,t){if(plugins[t])throw new Error("plugin "+t+" already registered");var i=[];arguments.length>2&&(i=Array.prototype.slice.call(arguments,1)),i[0]=e;var s=new(e.bind.apply(e,i));if(void 0===s||!(s instanceof plugin.Base))throw new Error("Plugin should extend the me.plugin.Base Class !");if(utils.checkVersion(s.version)>0)throw new Error("Plugin version mismatch, expected: "+s.version+", got: "+version);plugins[t]=s}};let Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}},Back:{In:function(e){var t=1.70158;return e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}},Bounce:{In:function(e){return 1-Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*Easing.Bounce.In(2*e):.5*Easing.Bounce.Out(2*e-1)+.5}}},Interpolation={Linear:function(e,t){var i=e.length-1,s=i*t,r=Math.floor(s),n=Interpolation.Utils.Linear;return t<0?n(e[0],e[1],s):t>1?n(e[i],e[i-1],i-s):n(e[r],e[r+1>i?i:r+1],s-r)},Bezier:function(e,t){var i,s=0,r=e.length-1,n=Math.pow,o=Interpolation.Utils.Bernstein;for(i=0;i<=r;i++)s+=n(1-t,r-i)*n(t,i)*e[i]*o(r,i);return s},CatmullRom:function(e,t){var i=e.length-1,s=i*t,r=Math.floor(s),n=Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(r=Math.floor(s=i*(1+t))),n(e[(r-1+i)%i],e[r],e[(r+1)%i],e[(r+2)%i],s-r)):t<0?e[0]-(n(e[0],e[0],e[1],e[1],-s)-e[0]):t>1?e[i]-(n(e[i],e[i],e[i-1],e[i-1],s-i)-e[i]):n(e[r?r-1:0],e[r],e[i<r+1?i:r+1],e[i<r+2?i:r+2],s-r)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:function(){var e=[1];return function(t){var i,s=1;if(e[t])return e[t];for(i=t;i>1;i--)s*=i;return e[t]=s,s}}(),CatmullRom:function(e,t,i,s,r){var n=.5*(i-e),o=.5*(s-t),a=r*r;return(2*t-2*i+n+o)*(r*a)+(-3*t+3*i-2*n-o)*a+n*r+t}}};class Tween{constructor(e){this.setProperties(e)}onResetEvent(e){this.setProperties(e)}setProperties(e){for(var t in this._object=e,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._repeat=0,this._yoyo=!1,this._reversed=!1,this._delayTime=0,this._startTime=null,this._easingFunction=Easing.Linear.None,this._interpolationFunction=Interpolation.Linear,this._chainedTweens=[],this._onStartCallback=null,this._onStartCallbackFired=!1,this._onUpdateCallback=null,this._onCompleteCallback=null,this._tweenTimeTracker=lastUpdate,this.isPersistent=!1,this.updateWhenPaused=!1,this.isRenderable=!1,e)"object"!=typeof e&&(this._valuesStart[t]=parseFloat(e[t]))}_resumeCallback(e){this._startTime&&(this._startTime+=e)}onActivateEvent(){on(STATE_RESUME,this._resumeCallback,this)}onDeactivateEvent(){off(STATE_RESUME,this._resumeCallback)}to(e,t){return this._valuesEnd=e,void 0!==t&&("number"==typeof t?this._duration=t:"object"==typeof t&&(t.duration&&(this._duration=t.duration),t.yoyo&&this.yoyo(t.yoyo),t.easing&&this.easing(t.easing),t.repeat&&this.repeat(t.repeat),t.delay&&this.delay(t.delay),t.interpolation&&this.interpolation(t.interpolation),t.autoStart&&this.start())),this}start(e=timer$1.getTime()){for(var t in this._onStartCallbackFired=!1,world.addChild(this),this._startTime=e+this._delayTime,this._valuesEnd){if(this._valuesEnd[t]instanceof Array){if(0===this._valuesEnd[t].length)continue;this._valuesEnd[t]=[this._object[t]].concat(this._valuesEnd[t])}this._valuesStart[t]=this._object[t],this._valuesStart[t]instanceof Array==0&&(this._valuesStart[t]*=1),this._valuesStartRepeat[t]=this._valuesStart[t]||0}return this}stop(){return world.removeChildNow(this),this}delay(e){return this._delayTime=e,this}repeat(e){return this._repeat=e,this}yoyo(e){return this._yoyo=e,this}easing(e){if("function"!=typeof e)throw new Error("invalid easing function for me.Tween.easing()");return this._easingFunction=e,this}interpolation(e){return this._interpolationFunction=e,this}chain(){return this._chainedTweens=arguments,this}onStart(e){return this._onStartCallback=e,this}onUpdate(e){return this._onUpdateCallback=e,this}onComplete(e){return this._onCompleteCallback=e,this}update(e){this._tweenTimeTracker=lastUpdate>this._tweenTimeTracker?lastUpdate:this._tweenTimeTracker+e;var t,i=this._tweenTimeTracker;if(i<this._startTime)return!0;!1===this._onStartCallbackFired&&(null!==this._onStartCallback&&this._onStartCallback.call(this._object),this._onStartCallbackFired=!0);var s=(i-this._startTime)/this._duration;s=s>1?1:s;var r=this._easingFunction(s);for(t in this._valuesEnd){var n=this._valuesStart[t]||0,o=this._valuesEnd[t];o instanceof Array?this._object[t]=this._interpolationFunction(o,r):("string"==typeof o&&(o=n+parseFloat(o)),"number"==typeof o&&(this._object[t]=n+(o-n)*r))}if(null!==this._onUpdateCallback&&this._onUpdateCallback.call(this._object,r),1===s){if(this._repeat>0){for(t in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat){if("string"==typeof this._valuesEnd[t]&&(this._valuesStartRepeat[t]=this._valuesStartRepeat[t]+parseFloat(this._valuesEnd[t])),this._yoyo){var a=this._valuesStartRepeat[t];this._valuesStartRepeat[t]=this._valuesEnd[t],this._valuesEnd[t]=a}this._valuesStart[t]=this._valuesStartRepeat[t]}return this._yoyo&&(this._reversed=!this._reversed),this._startTime=i+this._delayTime,!0}world.removeChildNow(this),null!==this._onCompleteCallback&&this._onCompleteCallback.call(this._object);for(var h=0,l=this._chainedTweens.length;h<l;h++)this._chainedTweens[h].start(i);return!1}return!0}static get Easing(){return Easing}static get Interpolation(){return Interpolation}}var runits=["ex","em","pt","px"],toPX=[12,24,.75,1],setContextStyle=function(e,t,i=!1){e.font=t.font,e.fillStyle=t.fillStyle.toRGBA(),!0===i&&(e.strokeStyle=t.strokeStyle.toRGBA(),e.lineWidth=t.lineWidth),e.textAlign=t.textAlign,e.textBaseline=t.textBaseline};class Text extends Renderable{constructor(e,t,i){super(e,t,i.width||0,i.height||0),this.onResetEvent(e,t,i)}onResetEvent(e,t,i){void 0!==i.fillStyle?i.fillStyle instanceof Color?this.fillStyle=i.fillStyle:this.fillStyle=pool.pull("Color").parseCSS(i.fillStyle):this.fillStyle=pool.pull("Color",0,0,0),void 0!==i.strokeStyle?i.strokeStyle instanceof Color?this.strokeStyle=i.strokeStyle:this.strokeStyle=pool.pull("Color").parseCSS(i.strokeStyle):this.strokeStyle=pool.pull("Color",0,0,0),this.lineWidth=i.lineWidth||1,this.textAlign=i.textAlign||"left",this.textBaseline=i.textBaseline||"top",this.lineHeight=i.lineHeight||1,this.offScreenCanvas=!1,this._text=[],this.fontSize=10,void 0!==i.anchorPoint?this.anchorPoint.setV(i.anchorPoint):this.anchorPoint.set(0,0),void 0!==i.floating&&(this.floating=!!i.floating),this.setFont(i.font,i.size),!0===i.bold&&this.bold(),!0===i.italic&&this.italic(),!0===i.offScreenCanvas&&(this.offScreenCanvas=!0,this.canvas=createCanvas(2,2,!0),this.context=this.canvas.getContext("2d")),this.setText(i.text),this.update(0)}onDeactivateEvent(){!0===this.offScreenCanvas&&(renderer instanceof WebGLRenderer&&(renderer.currentCompositor.unbindTexture2D(renderer.cache.get(this.canvas)),renderer.cache.remove(this.canvas)),this.canvas.width=this.canvas.height=0,this.context=void 0,this.canvas=void 0)}bold(){return this.font="bold "+this.font,this.isDirty=!0,this}italic(){return this.font="italic "+this.font,this.isDirty=!0,this}setFont(e,t){var i=e.split(",").map((function(e){return e=e.trim(),/(^".*"$)|(^'.*'$)/.test(e)?e:'"'+e+'"'}));if("number"==typeof t)this.fontSize=t,t+="px";else{var s=t.match(/([-+]?[\d.]*)(.*)/);this.fontSize=parseFloat(s[1]),s[2]?this.fontSize*=toPX[runits.indexOf(s[2])]:t+="px"}return this.height=this.fontSize,this.font=t+" "+i.join(","),this.isDirty=!0,this}setText(e=""){return this._text.toString()!==e.toString()&&(Array.isArray(e)?this._text=e:this._text=(""+e).split("\n"),this.isDirty=!0),this}measureText(e,t,i){var s,r=i||this.getBounds(),n=this.fontSize*this.lineHeight,o=void 0!==t?(""+t).split("\n"):this._text;(s=!0===this.offScreenCanvas?this.context:e instanceof Renderer?e.getFontContext():renderer.getFontContext()).save(),setContextStyle(s,this),this.height=this.width=0;for(var a=0;a<o.length;a++)this.width=Math.max(s.measureText(trimRight(""+o[a])).width,this.width),this.height+=n;return r.width=Math.ceil(this.width),r.height=Math.ceil(this.height),r.x=Math.floor("right"===this.textAlign?this.pos.x-this.width:"center"===this.textAlign?this.pos.x-this.width/2:this.pos.x),r.y=Math.floor(0===this.textBaseline.search(/^(top|hanging)$/)?this.pos.y:"middle"===this.textBaseline?this.pos.y-r.height/2:this.pos.y-r.height),s.restore(),r}update(){if(!0===this.isDirty){var e=this.measureText(renderer);if(!0===this.offScreenCanvas){var t=Math.round(e.width),i=Math.round(e.height);renderer instanceof WebGLRenderer&&(renderer.currentCompositor.unbindTexture2D(renderer.cache.get(this.canvas)),1===renderer.WebGLVersion&&(t=nextPowerOfTwo(e.width),i=nextPowerOfTwo(e.height))),this.canvas.width<t||this.canvas.height<i?(this.canvas.width=t,this.canvas.height=i):this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this._drawFont(this.context,this._text,this.pos.x-e.x,this.pos.y-e.y,!1)}}return this.isDirty}draw(e,t,i,s,r){void 0===this.ancestor?(this.setText(t),this.pos.x===i&&this.pos.y===s||(this.pos.x=i,this.pos.y=s,this.isDirty=!0),this.update(0),e.save(),e.setGlobalAlpha(e.globalAlpha()*this.getOpacity())):(i=this.pos.x,s=this.pos.y),!1===e.settings.subPixel&&(i=~~i,s=~~s),!0===this.offScreenCanvas?e.drawImage(this.canvas,this.getBounds().x,this.getBounds().y):e.drawFont(this._drawFont(e.getFontContext(),this._text,i,s,r)),void 0===this.ancestor&&e.restore(),this.isDirty=!1}drawStroke(e,t,i,s){this.draw(e,t,i,s,!0)}_drawFont(e,t,i,s,r=!1){setContextStyle(e,this,r);for(var n=this.fontSize*this.lineHeight,o=0;o<t.length;o++){var a=trimRight(""+t[o]);e[r?"strokeText":"fillText"](a,i,s),s+=n}return this.getBounds()}destroy(){pool.push(this.fillStyle),pool.push(this.strokeStyle),this.fillStyle=this.strokeStyle=void 0,this._text.length=0,super.destroy()}}var measureTextWidth=function(e,t){for(var i=t.split(""),s=0,r=null,n=0;n<i.length;n++){var o=i[n].charCodeAt(0),a=e.fontData.glyphs[o],h=r&&r.kerning?r.getKerning(o):0;s+=(a.xadvance+h)*e.fontScale.x,r=a}return s},measureTextHeight=function(e){return e.fontData.capHeight*e.lineHeight*e.fontScale.y};class BitmapText extends Renderable{constructor(e,t,i){super(e,t,i.width||0,i.height||0),this.textAlign=i.textAlign||"left",this.textBaseline=i.textBaseline||"top",this.lineHeight=i.lineHeight||1,this._text=[],this.fontScale=pool.pull("Vector2d",1,1),this.fontImage="object"==typeof i.font?i.font:loader.getImage(i.font),"string"!=typeof i.fontData?this.fontData=pool.pull("BitmapTextData",loader.getBinary(i.font)):this.fontData=pool.pull("BitmapTextData",i.fontData.includes("info face")?i.fontData:loader.getBinary(i.fontData)),void 0!==i.floating&&(this.floating=!!i.floating),"number"==typeof i.size&&1!==i.size&&this.resize(i.size),void 0!==i.fillStyle&&(i.fillStyle instanceof Color?this.fillStyle.setColor(i.fillStyle):this.fillStyle.parseCSS(i.fillStyle)),void 0!==i.anchorPoint?this.anchorPoint.set(i.anchorPoint.x,i.anchorPoint.y):this.anchorPoint.set(0,0),this.setText(i.text)}set(e,t){return this.textAlign=e,t&&this.resize(t),this.isDirty=!0,this}setText(e){return void 0===e&&(e=""),this._text.toString()!==e.toString()&&(Array.isArray(e)?this._text=e:this._text=(""+e).split("\n"),this.isDirty=!0),this}get fillStyle(){return this.tint}set fillStyle(e){this.tint=e}resize(e){return this.fontScale.set(e,e),this.isDirty=!0,this}measureText(e,t){e=e||this._text;var i=measureTextHeight(this),s=t||this.getBounds(),r="string"==typeof e?(""+e).split("\n"):e;s.height=s.width=0;for(var n=0;n<r.length;n++)s.width=Math.max(measureTextWidth(this,r[n]),s.width),s.height+=i;return s}update(){return!0===this.isDirty&&this.measureText(),this.isDirty}draw(e,t,i,s){var r=e.globalAlpha();void 0===this.ancestor?(this.setText(t),this.update(0),e.setGlobalAlpha(r*this.getOpacity())):(i=this.pos.x,s=this.pos.y);for(var n=i,o=measureTextHeight(this),a=0,h=0;h<this._text.length;h++){i=n;var l=trimRight(this._text[h]),d=measureTextWidth(this,l);switch(this.textAlign){case"right":i-=d;break;case"center":i-=.5*d}switch(this.textBaseline){case"middle":s-=.5*o;break;case"ideographic":case"alphabetic":case"bottom":s-=o}!0===this.isDirty&&void 0===this.ancestor&&(0===h&&(this.pos.y=s),a<d&&(a=d,this.pos.x=i));for(var u=null,c=0,p=l.length;c<p;c++){var g=l.charCodeAt(c),f=this.fontData.glyphs[g],m=f.width,v=f.height,_=u&&u.kerning?u.getKerning(g):0;0!==m&&0!==v&&e.drawImage(this.fontImage,f.x,f.y,m,v,i+f.xoffset,s+f.yoffset*this.fontScale.y,m*this.fontScale.x,v*this.fontScale.y),i+=(f.xadvance+_)*this.fontScale.x,u=f}s+=o}void 0===this.ancestor&&e.setGlobalAlpha(r),this.isDirty=!1}destroy(){pool.push(this.fontScale),this.fontScale=void 0,pool.push(this.fontData),this.fontData=void 0,this._text.length=0,super.destroy()}}var LOG2_PAGE_SIZE=9,PAGE_SIZE=1<<LOG2_PAGE_SIZE;class Glyph{constructor(){this.id=0,this.x=0,this.y=0,this.width=0,this.height=0,this.u=0,this.v=0,this.u2=0,this.v2=0,this.xoffset=0,this.yoffset=0,this.xadvance=0,this.fixedWidth=!1}getKerning(e){if(this.kerning){var t=this.kerning[e>>>LOG2_PAGE_SIZE];if(t)return t[e&PAGE_SIZE-1]||0}return 0}setKerning(e,t){this.kerning||(this.kerning={});var i=this.kerning[e>>>LOG2_PAGE_SIZE];void 0===i&&(this.kerning[e>>>LOG2_PAGE_SIZE]={},i=this.kerning[e>>>LOG2_PAGE_SIZE]),i[e&PAGE_SIZE-1]=t}}var capChars=["M","N","B","D","C","E","F","K","A","G","H","I","J","L","O","P","Q","R","S","T","U","V","W","X","Y","Z"];function getValueFromPair(e,t){var i=e.match(t);if(!i)throw new Error("Could not find pattern "+t+" in string: "+e);return i[0].split("=")[1]}function getFirstGlyph(e){for(var t=Object.keys(e),i=0;i<t.length;i++)if(t[i]>32)return e[t[i]];return null}function createSpaceGlyph(e){var t=" ".charCodeAt(0),i=e[t];i||((i=new Glyph).id=t,i.xadvance=getFirstGlyph(e).xadvance,e[t]=i)}class BitmapTextData{constructor(...e){this.onResetEvent(...e)}onResetEvent(e){this.padTop=0,this.padRight=0,this.padBottom=0,this.padLeft=0,this.lineHeight=0,this.capHeight=1,this.descent=0,this.glyphs={},this.parse(e)}parse(e){if(!e)throw new Error("File containing font data was empty, cannot load the bitmap font.");var t=e.split(/\r\n|\n/),i=e.match(/padding\=\d+,\d+,\d+,\d+/g);if(!i)throw new Error("Padding not found in first line");var s=i[0].split("=")[1].split(",");this.padTop=parseFloat(s[0]),this.padLeft=parseFloat(s[1]),this.padBottom=parseFloat(s[2]),this.padRight=parseFloat(s[3]),this.lineHeight=parseFloat(getValueFromPair(t[1],/lineHeight\=\d+/g));var r,n=parseFloat(getValueFromPair(t[1],/base\=\d+/g)),o=this.padTop+this.padBottom,a=null;for(r=4;r<t.length;r++){var h=t[r],l=h.split(/=|\s+/);if(h&&!/^kernings/.test(h))if(/^kerning\s/.test(h)){var d=parseFloat(l[2]),u=parseFloat(l[4]),c=parseFloat(l[6]);null!=(a=this.glyphs[d])&&a.setKerning(u,c)}else{a=new Glyph;var p=parseFloat(l[2]);a.id=p,a.x=parseFloat(l[4]),a.y=parseFloat(l[6]),a.width=parseFloat(l[8]),a.height=parseFloat(l[10]),a.xoffset=parseFloat(l[12]),a.yoffset=parseFloat(l[14]),a.xadvance=parseFloat(l[16]),a.width>0&&a.height>0&&(this.descent=Math.min(n+a.yoffset,this.descent)),this.glyphs[p]=a}}this.descent+=this.padBottom,createSpaceGlyph(this.glyphs);var g=null;for(r=0;r<capChars.length;r++){var f=capChars[r];if(g=this.glyphs[f.charCodeAt(0)])break}if(g)this.capHeight=g.height;else for(var m in this.glyphs)if(this.glyphs.hasOwnProperty(m)){if(0===(a=this.glyphs[m]).height||0===a.width)continue;this.capHeight=Math.max(this.capHeight,a.height)}this.capHeight-=o}}class ImageLayer extends Sprite{constructor(e,t,i){super(e,t,i),this.floating=!0,this.offset.set(e,t),this.ratio=pool.pull("Vector2d",1,1),void 0!==i.ratio&&(isNumeric(i.ratio)?this.ratio.set(i.ratio,+i.ratio):this.ratio.setV(i.ratio)),void 0===i.anchorPoint?this.anchorPoint.set(0,0):"number"==typeof i.anchorPoint?this.anchorPoint.set(i.anchorPoint,i.anchorPoint):this.anchorPoint.setV(i.anchorPoint),this.repeat=i.repeat||"repeat",on(WEBGL_ONCONTEXT_RESTORED,this.createPattern,this)}get repeat(){return this._repeat}set repeat(e){switch(this._repeat=e,this._repeat){case"no-repeat":this.repeatX=!1,this.repeatY=!1;break;case"repeat-x":this.repeatX=!0,this.repeatY=!1;break;case"repeat-y":this.repeatX=!1,this.repeatY=!0;break;default:this.repeatX=!0,this.repeatY=!0}this.resize(viewport.width,viewport.height),this.createPattern()}onActivateEvent(){on(VIEWPORT_ONCHANGE,this.updateLayer,this),on(VIEWPORT_ONRESIZE,this.resize,this),once(LEVEL_LOADED,(()=>{this.updateLayer(viewport.pos)})),!0!==this.ancestor.root&&this.updateLayer(viewport.pos)}resize(e,t){super.resize(this.repeatX?1/0:e,this.repeatY?1/0:t)}createPattern(){this._pattern=renderer.createPattern(this.image,this._repeat)}updateLayer(e){var t=this.ratio.x,i=this.ratio.y;if(0!==t||0!==i){var s=this.width,r=this.height,n=viewport.bounds.width,o=viewport.bounds.height,a=this.anchorPoint.x,h=this.anchorPoint.y,l=a*(t-1)*(n-viewport.width)+this.offset.x-t*e.x,d=h*(i-1)*(o-viewport.height)+this.offset.y-i*e.y;this.repeatX?this.pos.x=l%s:this.pos.x=l,this.repeatY?this.pos.y=d%r:this.pos.y=d,this.isDirty=!0}}preDraw(e){e.save(),e.setGlobalAlpha(e.globalAlpha()*this.getOpacity()),e.setTint(this.tint)}draw(e){var t=this.width,i=this.height,s=viewport.bounds.width,r=viewport.bounds.height,n=this.anchorPoint.x,o=this.anchorPoint.y,a=this.pos.x,h=this.pos.y;0===this.ratio.x&&0===this.ratio.y&&(a+=n*(s-t),h+=o*(r-i)),e.translate(a,h),e.drawPattern(this._pattern,0,0,2*viewport.width,2*viewport.height)}onDeactivateEvent(){off(VIEWPORT_ONCHANGE,this.updateLayer),off(VIEWPORT_ONRESIZE,this.resize)}destroy(){pool.push(this.ratio),this.ratio=void 0,off(WEBGL_ONCONTEXT_RESTORED,this.createPattern),super.destroy()}}class NineSliceSprite extends Sprite{constructor(e,t,i){if(super(e,t,i),"number"!=typeof i.width||"number"!=typeof i.height)throw new Error("height and width properties are mandatory");this.width=i.width,this.height=i.height}draw(e){var t=this.current,i=this.pos.x,s=this.pos.y,r=t.width,n=t.height,o=t.offset,a=this.offset;0!==t.angle&&(e.translate(-i,-s),e.rotate(t.angle),i-=n,r=t.height,n=t.width);var h=a.x+o.x,l=a.y+o.y,d=t.width/4,u=t.height/4;e.drawImage(this.image,h,l,d,u,i,s,d,u),e.drawImage(this.image,h+r-d,l,d,u,i+this.width-d,s,d,u),e.drawImage(this.image,h,l+n-u,d,u,i,s+this.height-u,d,u),e.drawImage(this.image,h+r-d,l+n-u,d,u,i+this.width-d,s+this.height-u,d,u);var c=r-(d<<1),p=n-(u<<1),g=this.width-(d<<1),f=this.height-(u<<1);e.drawImage(this.image,h+d,l,c,u,i+d,s,g,u),e.drawImage(this.image,h+d,l+n-u,c,u,i+d,s+this.height-u,g,u),e.drawImage(this.image,h,l+u,d,p,i,s+u,d,f),e.drawImage(this.image,h+r-d,l+u,d,p,i+this.width-d,s+u,d,f),e.drawImage(this.image,h+d,l+u,c,p,i+d,s+u,g,f)}}class GUI_Object extends Sprite{constructor(e,t,i){super(e,t,i),this.isClickable=!0,this.holdThreshold=250,this.isHoldable=!1,this.hover=!1,this.holdTimeout=null,this.released=!0,this.floating=!0,this.isKinematic=!1}clicked(e){if(0===e.button&&this.isClickable)return this.dirty=!0,this.released=!1,this.isHoldable&&(null!==this.holdTimeout&&timer$1.clearTimeout(this.holdTimeout),this.holdTimeout=timer$1.setTimeout(this.hold.bind(this),this.holdThreshold,!1),this.released=!1),this.onClick(e)}onClick(){return!1}enter(e){return this.hover=!0,this.dirty=!0,this.onOver(e)}onOver(){}leave(e){return this.hover=!1,this.dirty=!0,this.release(e),this.onOut(e)}onOut(){}release(e){if(!1===this.released)return this.released=!0,this.dirty=!0,timer$1.clearTimeout(this.holdTimeout),this.onRelease(e)}onRelease(){return!1}hold(){timer$1.clearTimeout(this.holdTimeout),this.dirty=!0,this.released||this.onHold()}onHold(){}onActivateEvent(){registerPointerEvent("pointerdown",this,this.clicked.bind(this)),registerPointerEvent("pointerup",this,this.release.bind(this)),registerPointerEvent("pointercancel",this,this.release.bind(this)),registerPointerEvent("pointerenter",this,this.enter.bind(this)),registerPointerEvent("pointerleave",this,this.leave.bind(this))}onDeactivateEvent(){releasePointerEvent("pointerdown",this),releasePointerEvent("pointerup",this),releasePointerEvent("pointercancel",this),releasePointerEvent("pointerenter",this),releasePointerEvent("pointerleave",this),timer$1.clearTimeout(this.holdTimeout)}}class Collectable extends Sprite{constructor(e,t,i){super(e,t,i),this.name=i.name,this.type=i.type,this.id=i.id,this.body=new Body(this,i.shapes||new Rect(0,0,this.width,this.height)),this.body.collisionType=collision.types.COLLECTABLE_OBJECT,this.body.setCollisionMask(collision.types.PLAYER_OBJECT),this.body.setStatic(!0),i.anchorPoint?this.anchorPoint.set(i.anchorPoint.x,i.anchorPoint.y):this.anchorPoint.set(0,0)}}class Trigger extends Renderable{constructor(e,t,i){super(e,t,i.width||0,i.height||0),this.anchorPoint.set(0,0),this.fade=i.fade,this.duration=i.duration,this.fading=!1,this.name="Trigger",this.type=i.type,this.id=i.id,this.gotolevel=i.to,this.triggerSettings={event:"level"},["type","container","onLoaded","flatten","setViewportBounds","to"].forEach(function(e){void 0!==i[e]&&(this.triggerSettings[e]=i[e])}.bind(this)),this.body=new Body(this,i.shapes||new Rect(0,0,this.width,this.height)),this.body.collisionType=collision.types.ACTION_OBJECT,this.body.setCollisionMask(collision.types.PLAYER_OBJECT),this.body.setStatic(!0),this.resize(this.body.getBounds().width,this.body.getBounds().height)}getTriggerSettings(){return"string"==typeof this.triggerSettings.container&&(this.triggerSettings.container=world.getChildByName(this.triggerSettings.container)[0]),this.triggerSettings}onFadeComplete(){level.load(this.gotolevel,this.getTriggerSettings()),viewport.fadeOut(this.fade,this.duration)}triggerEvent(){var e=this.getTriggerSettings();if("level"!==e.event)throw new Error("Trigger invalid type");this.gotolevel=e.to,this.fade&&this.duration?this.fading||(this.fading=!0,viewport.fadeIn(this.fade,this.duration,this.onFadeComplete.bind(this))):level.load(this.gotolevel,e)}onCollision(){return"Trigger"===this.name&&this.triggerEvent.apply(this),!1}}class ParticleContainer extends Container{constructor(e){super(viewport.pos.x,viewport.pos.y,viewport.width,viewport.height),this.autoSort=!1,this._updateCount=0,this._dt=0,this._emitter=e,this.autoTransform=!1,this.anchorPoint.set(0,0),this.isKinematic=!0}update(e){if(++this._updateCount>this._emitter.framesToSkip&&(this._updateCount=0),this._updateCount>0)return this._dt+=e,!1;e+=this._dt,this._dt=0;for(var t=this.children.length-1;t>=0;--t){var i=this.children[t];i.inViewport=viewport.isVisible(i,this.floating),i.update(e)||this.removeChildNow(i)}return!0}draw(e,t){if(this.children.length>0){var i,s=e.getContext();this._emitter.textureAdditive&&(i=s.globalCompositeOperation,s.globalCompositeOperation="lighter"),super.draw(e,t),this._emitter.textureAdditive&&(s.globalCompositeOperation=i)}}}var pixel=(canvas=createCanvas(1,1),context=canvas.getContext("2d"),context.fillStyle="#fff",context.fillRect(0,0,1,1),canvas),canvas,context,ParticleEmitterSettings={width:0,height:0,image:pixel,totalParticles:50,angle:Math.PI/2,angleVariation:0,minLife:1e3,maxLife:3e3,speed:2,speedVariation:1,minRotation:0,maxRotation:0,minStartScale:1,maxStartScale:1,minEndScale:0,maxEndScale:0,gravity:0,wind:0,followTrajectory:!1,textureAdditive:!1,onlyInViewport:!0,floating:!1,maxParticles:10,frequency:100,duration:1/0,framesToSkip:0};class ParticleEmitter extends Renderable{constructor(e,t,i){super(e,t,1/0,1/0),this._stream=!1,this._frequencyTimer=0,this._durationTimer=0,this._enabled=!1,this.alwaysUpdate=!0,this.autoSort=!1,this.container=new ParticleContainer(this),Object.defineProperty(this.pos,"z",{get:function(){return this.container.pos.z}.bind(this),set:function(e){this.container.pos.z=e}.bind(this),enumerable:!0,configurable:!0}),Object.defineProperty(this,"floating",{get:function(){return this.container.floating},set:function(e){this.container.floating=e},enumerable:!0,configurable:!0}),this.reset(i)}onActivateEvent(){this.ancestor.addChild(this.container),this.container.pos.z=this.pos.z,this.ancestor.autoSort||this.ancestor.sort()}onDeactivateEvent(){this.ancestor.hasChild(this.container)&&this.ancestor.removeChildNow(this.container)}destroy(){this.reset()}getRandomPointX(){return this.pos.x+randomFloat(0,this.width)}getRandomPointY(){return this.pos.y+randomFloat(0,this.height)}reset(e){var t=ParticleEmitterSettings,i="number"==typeof(e=e||{}).width?e.width:t.width,s="number"==typeof e.height?e.height:t.height;this.resize(i,s),Object.assign(this,t,e),this.container.reset()}addParticles(e){for(var t=0;t<~~e;t++){var i=pool.pull("Particle",this);this.container.addChild(i)}}isRunning(){return this._enabled&&this._stream}streamParticles(e){this._enabled=!0,this._stream=!0,this.frequency=Math.max(this.frequency,1),this._durationTimer="number"==typeof e?e:this.duration}stopStream(){this._enabled=!1}burstParticles(e){this._enabled=!0,this._stream=!1,this.addParticles("number"==typeof e?e:this.totalParticles),this._enabled=!1}update(e){if(this._enabled&&this._stream){if(this._durationTimer!==1/0&&(this._durationTimer-=e,this._durationTimer<=0))return this.stopStream(),!1;this._frequencyTimer+=e;var t=this.container.children.length;t<this.totalParticles&&this._frequencyTimer>=this.frequency&&(t+this.maxParticles<=this.totalParticles?this.addParticles(this.maxParticles):this.addParticles(this.totalParticles-t),this._frequencyTimer=0)}return!0}}class Particle extends Renderable{constructor(e){super(e.getRandomPointX(),e.getRandomPointY(),e.image.width,e.image.height),this.vel=new Vector2d,this.onResetEvent(e,!0)}onResetEvent(e,t=!1){!1===t&&super.onResetEvent(e.getRandomPointX(),e.getRandomPointY(),e.image.width,e.image.height),this.alwaysUpdate=!0,this.image=e.image;var i=e.angle+(e.angleVariation>0?(randomFloat(0,2)-1)*e.angleVariation:0),s=e.speed+(e.speedVariation>0?(randomFloat(0,2)-1)*e.speedVariation:0);this.vel.set(s*Math.cos(i),-s*Math.sin(i)),this.life=randomFloat(e.minLife,e.maxLife),this.startLife=this.life,this.startScale=clamp(randomFloat(e.minStartScale,e.maxStartScale),e.minStartScale,e.maxStartScale),this.endScale=clamp(randomFloat(e.minEndScale,e.maxEndScale),e.minEndScale,e.maxEndScale),this.gravity=e.gravity,this.wind=e.wind,this.followTrajectory=e.followTrajectory,this.onlyInViewport=e.onlyInViewport,this.pos.z=e.z,this._deltaInv=timer$1.maxfps/1e3,e.followTrajectory||(this.angle=randomFloat(e.minRotation,e.maxRotation))}update(e){var t=e*this._deltaInv;this.life=this.life>e?this.life-e:0;var i=this.life/this.startLife,s=this.startScale;this.startScale>this.endScale?s=(s*=i)<this.endScale?this.endScale:s:this.startScale<this.endScale&&(s=(s/=i)>this.endScale?this.endScale:s),this.alpha=i,this.vel.x+=this.wind*t,this.vel.y+=this.gravity*t;var r=this.followTrajectory?Math.atan2(this.vel.y,this.vel.x):this.angle;return this.pos.x+=this.vel.x*t,this.pos.y+=this.vel.y*t,this.currentTransform.setTransform(s,0,0,0,s,0,this.pos.x,this.pos.y,1).rotate(r),(this.inViewport||!this.onlyInViewport)&&this.life>0}preDraw(e){e.save(),e.setGlobalAlpha(e.globalAlpha()*this.alpha),e.transform(this.currentTransform)}draw(e){var t=this.width,i=this.height;e.drawImage(this.image,0,0,t,i,-t/2,-i/2,t,i)}}class Entity extends Renderable{constructor(e,t,i){if("number"!=typeof i.width||"number"!=typeof i.height)throw new Error("height and width properties are mandatory when passing settings parameters to an object entity");super(e,t,i.width,i.height),this.children=[],i.image&&(i.framewidth=i.framewidth||i.width,i.frameheight=i.frameheight||i.height,this.renderable=new Sprite(0,0,i)),i.anchorPoint?this.anchorPoint.set(i.anchorPoint.x,i.anchorPoint.y):this.anchorPoint.set(0,0),"string"==typeof i.name&&(this.name=i.name),this.type=i.type||"",this.id=i.id||"",this.alive=!0,void 0===i.shapes&&(i.shapes=new Polygon(0,0,[new Vector2d(0,0),new Vector2d(this.width,0),new Vector2d(this.width,this.height),new Vector2d(0,this.height)])),this.body=new Body(this,i.shapes,this.onBodyUpdate.bind(this)),0===this.width&&0===this.height&&this.resize(this.body.getBounds().width,this.body.getBounds().height),this.body.setCollisionMask(i.collisionMask),this.body.setCollisionType(i.collisionType),this.autoTransform=!1}get renderable(){return this.children[0]}set renderable(e){if(!(e instanceof Renderable))throw new Error(e+"should extend me.Renderable");this.children[0]=e,this.children[0].ancestor=this}update(e){return this.renderable&&(this.isDirty|=this.renderable.update(e)),super.update(e)}onBodyUpdate(e){this.getBounds().addBounds(e.getBounds(),!0),this.updateBoundsPos(this.pos.x,this.pos.y)}preDraw(e){e.save(),e.translate(this.pos.x+this.body.getBounds().x,this.pos.y+this.body.getBounds().y),this.renderable instanceof Renderable&&e.translate(this.anchorPoint.x*this.body.getBounds().width,this.anchorPoint.y*this.body.getBounds().height)}draw(e,t){var i=this.renderable;i instanceof Renderable&&(i.preDraw(e),i.draw(e,t),i.postDraw(e))}destroy(){this.renderable&&(this.renderable.destroy.apply(this.renderable,arguments),this.children.splice(0,1)),super.destroy(arguments)}onDeactivateEvent(){this.renderable&&this.renderable.onDeactivateEvent&&this.renderable.onDeactivateEvent()}}class DraggableEntity extends Entity{constructor(e,t,i){super(e,t,i),this.dragging=!1,this.dragId=null,this.grabOffset=new Vector2d(0,0),this.onPointerEvent=registerPointerEvent,this.removePointerEvent=releasePointerEvent,this.initEvents()}initEvents(){this.mouseDown=function(e){this.translatePointerEvent(e,DRAGSTART)},this.mouseUp=function(e){this.translatePointerEvent(e,DRAGEND)},this.onPointerEvent("pointerdown",this,this.mouseDown.bind(this)),this.onPointerEvent("pointerup",this,this.mouseUp.bind(this)),this.onPointerEvent("pointercancel",this,this.mouseUp.bind(this)),on(POINTERMOVE,this.dragMove,this),on(DRAGSTART,this.dragStart,this),on(DRAGEND,this.dragEnd,this)}translatePointerEvent(e,t){emit(t,e)}dragStart(e){if(!1===this.dragging)return this.dragging=!0,this.grabOffset.set(e.gameX,e.gameY),this.grabOffset.sub(this.pos),!1}dragMove(e){!0===this.dragging&&(this.pos.set(e.gameX,e.gameY,this.pos.z),this.pos.sub(this.grabOffset))}dragEnd(){if(!0===this.dragging)return this.dragging=!1,!1}destroy(){off(POINTERMOVE,this.dragMove),off(DRAGSTART,this.dragStart),off(DRAGEND,this.dragEnd),this.removePointerEvent("pointerdown",this),this.removePointerEvent("pointerup",this)}}class DroptargetEntity extends Entity{constructor(e,t,i){super(e,t,i),this.CHECKMETHOD_OVERLAP="overlaps",this.CHECKMETHOD_CONTAINS="contains",this.checkMethod=null,on(DRAGEND,this.checkOnMe,this),this.checkMethod=this[this.CHECKMETHOD_OVERLAP]}setCheckMethod(e){void 0!==this[e]&&(this.checkMethod=this[e])}checkOnMe(e,t){t&&this.checkMethod(t.getBounds())&&this.drop(t)}drop(){}destroy(){off(DRAGEND,this.checkOnMe)}}function warning(e,t,i){var s="melonJS: %s is deprecated since version %s, please use %s",r=(new Error).stack;console.groupCollapsed?console.groupCollapsed("%c"+s,"font-weight:normal;color:yellow;",e,i,t):console.warn(s,e,i,t),void 0!==r&&console.warn(r),console.groupCollapsed&&console.groupEnd()}function apply(){}var deprecated=Object.freeze({__proto__:null,warning,apply});const version="10.2.1";var initialized=!1,skipAutoInit=!1;function boot(){!0!==initialized&&(pool.register("me.Entity",Entity),pool.register("me.Collectable",Collectable),pool.register("me.Trigger",Trigger),pool.register("me.Tween",Tween,!0),pool.register("me.Color",Color,!0),pool.register("me.Particle",Particle,!0),pool.register("me.Sprite",Sprite),pool.register("me.NineSliceSprite",NineSliceSprite),pool.register("me.Renderable",Renderable),pool.register("me.Text",Text,!0),pool.register("me.BitmapText",BitmapText),pool.register("me.BitmapTextData",BitmapTextData,!0),pool.register("me.ImageLayer",ImageLayer),pool.register("me.ColorLayer",ColorLayer,!0),pool.register("me.Vector2d",Vector2d,!0),pool.register("me.Vector3d",Vector3d,!0),pool.register("me.ObservableVector2d",ObservableVector2d,!0),pool.register("me.ObservableVector3d",ObservableVector3d,!0),pool.register("me.Matrix2d",Matrix2d,!0),pool.register("me.Matrix3d",Matrix3d,!0),pool.register("me.Rect",Rect,!0),pool.register("me.Polygon",Polygon,!0),pool.register("me.Line",Line,!0),pool.register("me.Ellipse",Ellipse,!0),pool.register("me.Bounds",Bounds$1,!0),pool.register("Entity",Entity),pool.register("Collectable",Collectable),pool.register("Trigger",Trigger),pool.register("Tween",Tween,!0),pool.register("Color",Color,!0),pool.register("Particle",Particle,!0),pool.register("Sprite",Sprite),pool.register("NineSliceSprite",NineSliceSprite),pool.register("Renderable",Renderable),pool.register("Text",Text,!0),pool.register("BitmapText",BitmapText),pool.register("BitmapTextData",BitmapTextData,!0),pool.register("ImageLayer",ImageLayer),pool.register("ColorLayer",ColorLayer,!0),pool.register("Vector2d",Vector2d,!0),pool.register("Vector3d",Vector3d,!0),pool.register("ObservableVector2d",ObservableVector2d,!0),pool.register("ObservableVector3d",ObservableVector3d,!0),pool.register("Matrix2d",Matrix2d,!0),pool.register("Matrix3d",Matrix3d,!0),pool.register("Rect",Rect,!0),pool.register("Polygon",Polygon,!0),pool.register("Line",Line,!0),pool.register("Ellipse",Ellipse,!0),pool.register("Bounds",Bounds$1,!0),emit(BOOT),loader.setNocache(utils.getUriFragment().nocache||!1),initKeyboardEvent(),initialized=!0)}device$1.onReady((function(){boot()}))}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var i=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](i,i.exports,__webpack_require__),i.exports}__webpack_require__.d=(e,t)=>{for(var i in t)__webpack_require__.o(t,i)&&!__webpack_require__.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};(()=>{var e=__webpack_require__(402);let t=[{name:"tiles_winter",type:"image",src:"resources/tiles_winter.png"},{name:"level1",type:"tmx",src:"resources/level1.tmx"},{name:"level2",type:"tmx",src:"resources/level2.tmx"},{name:"level3",type:"tmx",src:"resources/level3.tmx"},{name:"background",type:"image",src:"resources/background.png"},{name:"the_end",type:"image",src:"resources/the_end.png"},{name:"title",type:"image",src:"resources/title.png"},{name:"intro_messages",type:"image",src:"resources/dialogs/intro/introMessages.png"},{name:"intro_messages",type:"json",src:"resources/dialogs/intro/introMessages.json"},{name:"in_game_msgs",type:"image",src:"resources/dialogs/inGameMessages/inGameMsgs.png"},{name:"in_game_msgs",type:"json",src:"resources/dialogs/inGameMessages/inGameMsgs.json"},{name:"general_textures",type:"image",src:"resources/generalTextures.png"},{name:"general_textures",type:"json",src:"resources/generalTextures.json"},{name:"captive_died_msgs",type:"image",src:"resources/dialogs/captiveIsDead/captiveDiedMsgs.png"},{name:"captive_died_msgs",type:"json",src:"resources/dialogs/captiveIsDead/captiveDiedMsgs.json"},{name:"soundtrack",type:"audio",src:"resources/"},{name:"shoot",type:"audio",src:"resources/"},{name:"heal",type:"audio",src:"resources/"},{name:"captive_is_free",type:"audio",src:"resources/"},{name:"player_died",type:"audio",src:"resources/"},{name:"jump",type:"audio",src:"resources/"}],i=()=>({events:{},emit(e,...t){(this.events[e]||[]).forEach((e=>e(...t)))},on(e,t){return(this.events[e]=this.events[e]||[]).push(t),()=>this.events[e]=(this.events[e]||[]).filter((e=>e!==t))}}),s=null;class r{static getInstance(){return s||(s=new r(i())),s}constructor(e){this._emitter=e,this._dataCache={}}push(e,t){this._dataCache[e]=t,this._emitter.emit(e,t)}on(e,t){this._emitter.on(e,t),void 0!==this._dataCache[e]&&t(this._dataCache[e])}}class n extends e.MJ{constructor(e,t){super(e,t,102,20),this._hp=0,r.getInstance().on("playerHp",(e=>{this._hp=e}))}draw(e){e.setColor("gray"),e.fillRect(59,14,102,24),e.setColor("red"),e.fillRect(60,16,this._hp,20)}}let o=i(),a=null;class h{static getInstance(){return a||(a=new h),a}init(){this.inGameMsgs=new e.Rk.renderer.Texture(e._m.getJSON("in_game_msgs"),e._m.getImage("in_game_msgs")),this.generalTextures=new e.Rk.renderer.Texture(e._m.getJSON("general_textures"),e._m.getImage("general_textures")),this.introMessages=new e.Rk.renderer.Texture(e._m.getJSON("intro_messages"),e._m.getImage("intro_messages")),this.captiveDiedMsgs=new e.Rk.renderer.Texture(e._m.getJSON("captive_died_msgs"),e._m.getImage("captive_died_msgs"))}}class l extends e.MJ{constructor(t,i){super(t,i,102,20);let s=e.H6.viewport.width/2-237.5;this.renderable=new e.jy(s,80,{framewidth:475,frameheight:45,image:h.getInstance().generalTextures,region:"cage_controller_tip"}),this.isTipShow=!1,o.on("playerNearCageController",this.showTip.bind(this))}draw(e){this.isTipShow&&this.renderable.draw(e)}showTip(){this.isTipShow=!0,setTimeout((()=>{this.isTipShow=!1}),3e3)}}class d extends e.W2{constructor(){super(),this.isPersistent=!0,this.floating=!0,this.name="HUD",this.addChild(new n(0,0)),this.addChild(new l(0,0))}}function u(e){let t=JSON.stringify({data:e}),i=new XMLHttpRequest;i.open("POST","/log",!0),i.setRequestHeader("Content-type","application/json"),i.send(t)}class c extends e.Hf{onResetEvent(){e.n0.playTrack("soundtrack",.25),e.fu.load("level1"),this.hud=new d,e.H6.world.addChild(this.hud),u("play start")}onDestroyEvent(){e.n0.stopTrack(),e.H6.world.removeChild(this.hud)}}class p extends e.MJ{constructor(t){super(0,0,0,0),this.texture=h.getInstance().inGameMsgs,this.bottomTriangleHeight=10;let i=this.texture.getRegion(t);this.msgBorderBox={x:-i.width/2,y:-i.height-this.bottomTriangleHeight,width:i.width,height:i.height},this.renderable=new e.jy(this.msgBorderBox.x,this.msgBorderBox.y-5,{image:this.texture,region:t})}draw(t){t.setColor(new e.Il(153,204,255,.7)),t.setLineWidth(2),t.fillPolygon(new e.mg(0,-this.bottomTriangleHeight,[new e.EY(10,this.bottomTriangleHeight),new e.EY(20,0),new e.EY(0,0)])),t.fillRect(this.msgBorderBox.x-5,this.msgBorderBox.y-15,this.msgBorderBox.width+10,this.msgBorderBox.height+15),this.renderable.draw(t)}}class g extends e.JH{constructor(e,t,i){super(e,t,i),this.faceToRight=!0,this.gid=i.gid,this.width=i.width,this.height=i.height,this.bulletType=i.bulletType,this.alwaysUpdate=!0,this.alive=!0,this.hp=100,this.faceToRight=!0,this.renderable=h.getInstance().generalTextures.createAnimationFromName(i.animationFrames,{framewidth:64,frameheight:64}),this.renderable.pos.x=this.width/2,this.renderable.pos.y=this.height/2,this.maxX=i.maxX,this.minX=i.minX,this._destinationX=null,this._isGoingToDest=!1,this._onDestReachedClb=null}shoot(){if(!this.alive)return;e.n0.play("shoot");let t=this.faceToRight?this.pos.x+this.width:this.pos.x,i=this.pos.y+this.height/2;e.H6.world.addChild(e.d_.pull("bullet",t,i,{isFlyToRight:this.faceToRight,type:this.bulletType}))}onCollision(t,i){return i.body.collisionType!==e.v7.types.SIGHT_BULLET&&i.body.collisionType!==e.v7.types.PLAYER_OBJECT&&(i.body.collisionType!==e.v7.types.PROJECTILE_OBJECT||(this.makeDamage(i.getDamage()),!1))}onDie(){}makeDamage(e){this.alive&&(this.hp=this.hp-e,this.hp<=0&&(this.hp=0,this.alive=!1,this.onDie()),this.onDamage())}onDamage(){}onHeal(){}heal(t){e.n0.play("heal"),this.hp=this.hp+t,this.hp>100&&(this.hp=100),this.onHeal()}draw(e){this.renderable.preDraw(e),this.renderable.draw(e),this.renderable.postDraw(e),this.saying&&(this.saying.preDraw(e),this.saying.draw(e),this.saying.postDraw(e))}say(e,t=3e3){return new Promise(((i,s)=>{this.saying=new p(e),setTimeout((()=>{this.saying=null,i()}),t)}))}goTo(e){return this._destinationX=e,this._isGoingToDest=!0,new Promise(((e,t)=>{this._onDestReachedClb=e}))}_goingToDestination(){if(Math.abs(this.pos.x-this._destinationX)<10)return this._onDestReachedClb(),this._isGoingToDest=!1,this._destinationX=null,this._onDestReachedClb=null,void(this.body.force.x=0);this.pos.x>this._destinationX?this.body.force.x=-this.body.maxVel.x:this.pos.x<this._destinationX&&(this.body.force.x=this.body.maxVel.x),this._turnFace()}_patrol(){this.pos.x>=this.maxX?this.body.force.x=-this.body.maxVel.x:this.pos.x<=this.minX&&(this.body.force.x=this.body.maxVel.x),0===this.body.vel.x&&(this.body.force.x=this.faceToRight?this.body.maxVel.x:-this.body.maxVel.x),this._turnFace()}_turnFace(){this.faceToRight=this.body.force.x>0,this.renderable.flipX(!this.faceToRight)}}class f extends g{constructor(t,i,s){s.animationFrames=["player_skin0","player_skin1","player_skin2","player_skin3","player_skin4","player_skin5"],s.bulletType=1,super(t,i,s),this.coffeePlacePosX=3400,e.H6.viewport.follow(this.pos,e.H6.viewport.AXIS.BOTH,.05),this.body.setMaxVelocity(4,18),this.body.setFriction(.4,0),this.body.collisionType=e.v7.types.PLAYER_OBJECT,this.renderable.addAnimation("walk",[0,1,2,3,4,5]),this.renderable.addAnimation("stand",[0]),this._pushPlayerHp(),this._pushPlayer()}update(t){return this.isControllingFreezed||(e.qH.isKeyPressed("left")?this.body.force.x=-this.body.maxVel.x:e.qH.isKeyPressed("right")?this.body.force.x=this.body.maxVel.x:this.body.force.x=0,e.qH.isKeyPressed("jump")?0===this.body.vel.y&&(e.n0.play("jump",!1,null,.6),this.body.force.y=-this.body.maxVel.y):this.body.force.y=0,e.qH.isKeyPressed("shoot")&&this.shoot()),this._isGoingToDest&&this._goingToDestination(),0===this.body.vel.x?this.renderable.isCurrentAnimation("stand")||this.renderable.setCurrentAnimation("stand"):this.renderable.isCurrentAnimation("walk")||this.renderable.setCurrentAnimation("walk"),0!==this.body.vel.x&&(this.faceToRight=this.body.vel.x>0,this.renderable.flipX(!this.faceToRight)),super.update(t)||0!==this.body.vel.x||0!==this.body.vel.y}onDie(){e.n0.play("player_died"),e.H6.viewport.unfollow(),e.H6.world.removeChild(this),setTimeout((()=>{e.fu.reload(),u(`player died on ${e.fu.getCurrentLevelId()}`)}),3e3)}onDamage(){this._pushPlayerHp()}onHeal(){this._pushPlayerHp()}freezeControlling(){this.isControllingFreezed=!0}playCoffeeScene(){this.freezeControlling(),this.goTo(this.coffeePlacePosX).then((()=>{this.goTo(this.pos.x+20)}))}_pushPlayerHp(){r.getInstance().push("playerHp",this.hp)}_pushPlayer(){r.getInstance().push("playerEntity",this)}}class m extends g{constructor(t,i,s){s.animationFrames=["enemy_skin0","enemy_skin1","enemy_skin2","enemy_skin3","enemy_skin4","enemy_skin5","enemy_skin6","enemy_skin7"],s.bulletType=2,super(t,i,s),this.body.setMaxVelocity(3,15),this.body.setFriction(.4,0),this.body.collisionType=e.v7.types.ENEMY_OBJECT,this.renderable.addAnimation("walk",[0,1,2,3,4,5,6,7]),this.renderable.addAnimation("stand",[0]),this.lookIntervalID=setInterval((()=>{this.lookForward()}),500),this.isShooting=!1}update(e){return this.alive&&!this.isShooting?this._patrol():this.body.force.x=0,0==this.body.vel.x?this.renderable.isCurrentAnimation("stand")||this.renderable.setCurrentAnimation("stand"):this.renderable.isCurrentAnimation("walk")||this.renderable.setCurrentAnimation("walk"),super.update(e)||0!==this.body.vel.x||0!==this.body.vel.y}lookForward(){let t=this.faceToRight?this.pos.x+this.width+5:this.pos.x-5,i=this.pos.y+this.height/2+10,s=this.faceToRight;e.H6.world.addChild(e.d_.pull("sightBullet",t,i,s,this.onLookDone.bind(this)))}destroy(){super.destroy(),clearInterval(this.lookIntervalID),this._clearShootingQue()}onLookDone(t,i){t&&t.body.collisionType===e.v7.types.PLAYER_OBJECT?(this.faceToRight=i,this.startShootingQue(2),this._startShooting()):this._stopShooting()}onDie(){this.renderable.flicker(500,(()=>{e.H6.world.removeChild(this)}))}startShootingQue(t){if(this.shootingIntervalID)return;let i=0;this.shootingIntervalID=e.HT.setInterval((()=>{this.shoot(),i++,i>=t&&this._clearShootingQue()}),100)}_clearShootingQue(){e.HT.clearInterval(this.shootingIntervalID),this.shootingIntervalID=null}_startShooting(){this.isShooting=!0}_stopShooting(){this.isShooting=!1}}class v extends e.JH{constructor(t,i,s){super(s.isFlyToRight?t+5:t-11-5,i,{width:11,height:5}),this.type=s.type,this.z=5;const r=s.isFlyToRight?16:-16;this.renderable=new e.jy(0,0,{image:h.getInstance().generalTextures,region:"bullet"}),this.body.vel.set(r,0),this.body.collisionType=e.v7.types.PROJECTILE_OBJECT,this.body.ignoreGravity=!0,this.alwaysUpdate=!0}update(t){return super.update(t),this.inViewport||e.H6.world.removeChild(this),!0}onCollision(t,i){return i.body.collisionType!==e.v7.types.PROJECTILE_OBJECT&&e.H6.world.removeChild(this),!1}getDamage(){switch(this.type){case 1:return 35;case 2:return 20}}}class _ extends e.JH{constructor(t,i,s,r,n){s||(t-=1),super(t,i,{width:1,height:1}),this.z=5,this.flyToRight=s,this.renderable=new e.jy(0,0,{image:h.getInstance().generalTextures,region:"sight_bullet"}),this.body.vel.set(s?25:-25,0),this.body.collisionType=e.v7.types.SIGHT_BULLET,this.body.ignoreGravity=!0,this.body.mass=0,this.alwaysUpdate=!0,this.onDone=r}update(t){return super.update(t),this.inViewport||(e.H6.world.removeChild(this),this.onDone(null)),!0}onCollision(t,i){return e.H6.world.removeChild(this),i.body.collisionType!==e.v7.types.SIGHT_BULLET&&this.onDone(i,this.flyToRight),!1}}class y extends e.JH{constructor(t,i,s){super(t,i,s),this.renderable=h.getInstance().generalTextures.createAnimationFromName(["heart0","heart1","heart2","heart3"],{framewidth:32,frameheight:32}),this.renderable.pos.x=this.width/2,this.renderable.pos.y=this.height/2,this.body.ignoreGravity=!0,this.body.setStatic(!0),this.body.setCollisionMask(e.v7.types.PLAYER_OBJECT),this.renderable.addAnimation("spin",[0,1,2,3],140),this.renderable.setCurrentAnimation("spin"),this.healStrength=40}onCollision(t,i){return i.heal(this.healStrength),e.H6.world.removeChild(this),!1}}class x extends e.JH{constructor(t,i,s){super(t,i,s),this.renderable=h.getInstance().generalTextures.createAnimationFromName(["coffee_bean0","coffee_bean1","coffee_bean2","coffee_bean3"],{framewidth:32,frameheight:32}),this.renderable.pos.x=this.width/2,this.renderable.pos.y=this.height/2,this.body.ignoreGravity=!0,this.body.setStatic(!0),this.body.setCollisionMask(e.v7.types.PLAYER_OBJECT),this.renderable.addAnimation("spin",[0,1,2,3],140),this.renderable.setCurrentAnimation("spin")}onCollision(t,i){return e.H6.world.removeChild(this),!1}}function w(){return e.H6.world.getChildByProp("gid","player")[0]}function T(){return e.H6.world.getChildByProp("gid","captive")[0]}function b(){return e.H6.world.getChildByProp("gid","cauldron")[0]}function E(t){let i=0;return new Promise(((s,r)=>{let n=setInterval((()=>{let o=e.H6.world.getChildByProp("gid",t)[0];o?(clearInterval(n),s(o)):i>=7&&r(),i++}),500)}))}class A{play(){let e=w(),t=T();return e.say("captive_saved_msg1").then((()=>t.say("captive_saved_msg2"))).then((()=>e.say("captive_saved_msg3"))).then((()=>t.say("captive_saved_msg4"))).then((()=>t.say("captive_saved_msg5"))).then((()=>e.say("captive_saved_msg6"))).then((()=>t.say("captive_saved_msg7")))}}class S extends g{constructor(t,i,s){s.animationFrames=["captive_skin0","captive_skin1","captive_skin2","captive_skin3","captive_skin4","captive_skin5","captive_skin6","captive_skin7"],super(t,i,s),this.body.setMaxVelocity(4,5),this.body.setFriction(.4,0),this.renderable.addAnimation("walk",[0,1,2,3,4,5,6,7]),this.renderable.addAnimation("stand",[0]),this.renderable.setCurrentAnimation("stand"),this.body.collisionType=e.v7.types.CAPTIVE,this.body.setCollisionMask(e.v7.types.WORLD_SHAPE|e.v7.types.DEATH_ENTITY),this.isPatroling=!!s.maxX&&!!s.minX,this.safeX=s.safeX,s.isPushingCauldron&&Promise.all([E("cauldron"),E("player")]).then((e=>{this._linkCauldron(e[0]).then((()=>{this._startFollowPlayer(e[1])}))})),this.coffeCauldronPosX=3e3,s.runAheadMsg&&this.say("captive_saved_msg8")}update(e){return super.update(e),this.isPatroling&&this.alive?this._patrol():this._isGoingToDest?this._goingToDestination():this.body.force.x=0,this._linkedCauldron&&this._pushCauldron(),0===this.body.vel.x?this.renderable.isCurrentAnimation("stand")||this.renderable.setCurrentAnimation("stand"):this.renderable.isCurrentAnimation("walk")||this.renderable.setCurrentAnimation("walk"),!0}onDie(){this.renderable.flicker(100,(()=>{e.H6.world.removeChild(this),setTimeout((()=>{e.SB.change(e.SB.CAPTIVE_DIED),u("captive died")}),3e3)}))}playSaveScene(){e.n0.play("captive_is_free",!1,null,.7),this.isPatroling=!1;let t=b(),i=e.H6.world.getChildByProp("gid","horizontalCageCap")[0];this.goTo(this.safeX).then((()=>(t.makeGhost(),i.makeGhost(),u("captive is free"),(new A).play()))).then((()=>this.goTo(2850))).then((()=>this.goTo(2690))).then((()=>this._linkCauldron(t))).then((()=>this.goTo(3500)))}_linkCauldron(e){return this.goTo(e.pos.x-20).then((()=>{this._linkedCauldron=e}))}_unlinkCauldron(){this._linkedCauldron=null}_pushCauldron(){this._linkedCauldron.pos.x=this.pos.x+20}_startFollowPlayer(e){this.followPlayerInterval=setInterval((()=>{if(!e.alive)return void clearInterval(this.followPlayerInterval);let t=e.pos.x-150;t>this.coffeCauldronPosX-200?this._onCaptiveIsNearCoffeCauldronPlace():this.pos.x<t&&this.goTo(t)}),3e3)}_stopFollowingPlayer(){clearInterval(this.followPlayerInterval)}_onCaptiveIsNearCoffeCauldronPlace(){let e=w(),t=b();this.goTo(this.coffeCauldronPosX).then((()=>{this._stopFollowingPlayer(),this._unlinkCauldron(),e.playCoffeeScene(),this.say("coffee_msg1").then((()=>this.goTo(e.pos.x-50))).then((()=>this.say("coffee_msg2"))).then((()=>this.goTo(t.pos.x))).then((()=>this.say("coffee_msg3"))).then((()=>this.goTo(e.pos.x+110))).then((()=>this.goTo(e.pos.x+60))).then((()=>this.say("coffee_msg4"))).then((()=>this._sayJokes()))}))}_sayJokes(){return this.say("joke1").then((()=>this.say("joke2"))).then((()=>this.say("joke3"))).then((()=>this.say("joke4"))).then((()=>this.say("joke5"))).then((()=>this._sayJokes()))}}class C extends e.JH{constructor(t,i,s){super(t,i,s),this.uid=s.uid,this.gid=s.gid,this.renderable=new e.jy(this.width/2,this.height/2,{framewidth:160,frameheight:10,image:h.getInstance().generalTextures,region:"cage_cap"}),this.body.setMaxVelocity(3,15),this.body.ignoreGravity=!0,this.openPosX=t+160,this.closePosX=t,this.needToBeOpen=!1,this.body.collisionType=e.v7.types.WORLD_SHAPE,o.on("cageCapControllerActivated",(e=>{"horizontalCageCap"===e&&this.open()}))}update(e){return this.needToBeOpen&&this.pos.x<this.openPosX?this.body.vel.x=this.body.maxVel.x:this.body.vel.x=0,!0}onCollision(e,t){return super.onCollision(e,t)}open(){this.needToBeOpen=!0}makeGhost(){this.body.collisionType=0}}class R extends e.JH{constructor(t,i,s){super(t,i,s),this.uid=s.uid,this.renderable=new e.jy(this.width/2,this.height/2,{framewidth:10,frameheight:160,image:h.getInstance().generalTextures,region:"cage_cap_vertical"}),this.body.setMaxVelocity(15,15),this.body.ignoreGravity=!0,this.openPosY=i-160,this.closePosY=i,this.needToBeOpen=!1,o.on("cageCapControllerActivated",(e=>{"verticalCageCap"===e&&this.open()}))}update(e){return this.needToBeOpen&&this.pos.y>this.openPosY?this.body.vel.y=-this.body.maxVel.y:this.body.vel.y=0,!0}onCollision(e,t){return!1}open(){this.needToBeOpen=!0,T().playSaveScene()}}class P extends e.JH{constructor(t,i,s){super(t,i,s),this.gid=s.gid,this.isDeadly=s.isDeadly,this.cauldron=new e.jy(this.width/2,this.height/2,{framewidth:160,frameheight:166,image:h.getInstance().generalTextures,region:"cauldron"}),this.fire=h.getInstance().generalTextures.createAnimationFromName(["fire0","fire1","fire2","fire3"],{framewidth:64,frameheight:64}),this.fire.pos.x=this.width/2,this.fire.pos.y=this.height-30,this.renderable=this.fire,this.body.ignoreGravity=!0,this.body.setStatic(!0),this.body.collisionType=e.v7.types.DEATH_ENTITY,this.body.setCollisionMask(e.v7.types.CAPTIVE),this.fire.addAnimation("fire",[0,1,2,3]),this.fire.setCurrentAnimation("fire"),this.isDeadly||this.makeGhost()}draw(e,t){this.cauldron.preDraw(e),this.cauldron.draw(e),this.cauldron.postDraw(e),this.fire.preDraw(e),this.fire.draw(e),this.fire.postDraw(e)}onCollision(e,t){return t.makeDamage(100),!1}makeGhost(){this.isDeadly=!1,this.body.collisionType=0}}class O extends e.JH{constructor(t,i,s){super(t,i,s),this.lever=new e.jy(this.width/2,135,{framewidth:this.width,frameheight:this.height,image:h.getInstance().generalTextures,region:"lever"}),this.body.ignoreGravity=!0,this.body.setStatic(!0),this.body.setCollisionMask(e.v7.types.NO_OBJECT),this.isPlayerNear=!1,this.controllerFor=s.controllerFor,this.isActivated=!1,"horizontalCageCap"===this.controllerFor&&(this.label=" "),"verticalCageCap"===this.controllerFor&&(this.label=" "),r.getInstance().on("playerEntity",(e=>{this._player=e}))}update(t){if(this._player&&this._player.alive){let e=this._player.getBounds(),t=this.getBounds();this._togglePlayerNear(e.overlaps(t))}this.isPlayerNear&&e.qH.isKeyPressed("activate")&&(o.emit("cageCapControllerActivated",this.controllerFor),this.isActivated=!0)}draw(e,t){this.lever.flipX(this.isActivated),this.lever.preDraw(e),this.lever.draw(e),this.lever.postDraw(e)}_togglePlayerNear(e){this.isPlayerNear!==e&&(this.isPlayerNear=e,o.emit("playerNearCageController"))}}class I extends e.MJ{constructor(t,i,s,r,n){super(t,i,0,0);let o=80;this.sprites=[];for(let t=0;t<r.length;t++)this.sprites.push(new e.jy(e.H6.viewport.width/2,o,{image:s,region:r[t].name})),o+=s.getRegion(r[t].name).height;this.spritesForRender=[this.sprites[0]];let a=1,h=setInterval((()=>{let e=this.sprites[a];e?(this.spritesForRender.push(e),a++):(clearInterval(h),n&&n())}),3e3)}update(){return!0}draw(e){for(let t=0;t<this.spritesForRender.length;t++)this.spritesForRender[t].preDraw(e),this.spritesForRender[t].draw(e),this.spritesForRender[t].postDraw(e)}}class M extends e.W2{constructor(){super(),this.floating=!0,this.name="captiveIsDeadHUD";let t=h.getInstance().captiveDiedMsgs;this.addChild(new I(0,0,t,[{name:"msg1"},{name:"msg2"}],(()=>{setTimeout((()=>{e.SB.change(e.SB.GAME_END)}),1e3)})))}}class k extends e.Hf{onResetEvent(){this.hud=new M,e.H6.world.addChild(this.hud)}onDestroyEvent(){e.H6.world.removeChild(this.hud)}}class L extends e.W2{constructor(){super(),this.floating=!0,this.name="IntroHUD";let t=h.getInstance().introMessages;this.addChild(new I(0,0,t,[{name:"msg1"},{name:"msg2"},{name:"msg3"},{name:"msg4"}],(()=>{setTimeout((()=>{e.SB.change(e.SB.PLAY)}),1e3)})))}}class D extends e.Hf{onResetEvent(){this.hud=new L,e.H6.world.addChild(this.hud)}onDestroyEvent(){e.H6.world.removeChild(this.hud)}}class B extends e.JH{constructor(t,i,s){super(t,i,s),this.body.ignoreGravity=!0,this.body.setStatic(!0),this.body.collisionType=e.v7.types.DEATH_ENTITY,this.body.setCollisionMask(e.v7.types.PLAYER_OBJECT|e.v7.types.CAPTIVE)}onCollision(e,t){return t.makeDamage(100),!1}}class V extends e.Hf{onResetEvent(){this.sprite=new e.jy(e.H6.viewport.width/2,e.H6.viewport.height/2,{image:"the_end"}),e.H6.world.addChild(this.sprite)}onDestroyEvent(){e.H6.world.removeChild(this.sprite)}}class N extends e.Hf{onResetEvent(){this.sprite=new e.jy(e.H6.viewport.width/2,e.H6.viewport.height/2,{image:"title"}),e.H6.world.addChild(this.sprite),this.handler=function(t,i,s){"enter"===t&&e.SB.change(e.SB.INTRO)},e.B.on(e.B.KEYDOWN,this.handler)}onDestroyEvent(){e.H6.world.removeChild(this.sprite),e.B.off(e.B.KEYDOWN,this.handler)}}e.Uh.onReady((function(){e.Rk.init(1280,720,{parent:"screen"})?(e.n0.init("mp3"),e._m.preload(t),e._m.onload=function(){e.v7.types.SIGHT_BULLET=e.v7.types.USER<<1,e.v7.types.HEALING_ENTITY=e.v7.types.USER<<2,e.v7.types.CAPTIVE=e.v7.types.USER<<3,e.v7.types.DEATH_ENTITY=e.v7.types.USER<<4,e.SB.CAPTIVE_DIED=e.SB.USER+1,e.SB.INTRO=e.SB.USER+2,e.SB.set(e.SB.PLAY,new c),e.SB.set(e.SB.CAPTIVE_DIED,new k),e.SB.set(e.SB.INTRO,new D),e.SB.set(e.SB.GAME_END,new V),e.SB.set(e.SB.MENU,new N),e.d_.register("player",f),e.d_.register("enemy",m),e.d_.register("bullet",v),e.d_.register("sightBullet",_),e.d_.register("healingHeart",y),e.d_.register("coffeeBean",x),e.d_.register("captive",S),e.d_.register("horizontalCageCap",C),e.d_.register("verticalCageCap",R),e.d_.register("cageController",O),e.d_.register("deathEntity",B),e.d_.register("cauldron",P),e.qH.bindKey(e.qH.KEY.LEFT,"left"),e.qH.bindKey(e.qH.KEY.RIGHT,"right"),e.qH.bindKey(e.qH.KEY.UP,"jump",!0),e.qH.bindKey(e.qH.KEY.SPACE,"shoot",!0),e.qH.bindKey(e.qH.KEY.E,"activate",!0),e.qH.bindKey(e.qH.KEY.ENTER,"enter",!0),h.getInstance().init(),e.SB.change(e.SB.MENU),u("game loaded")}):alert("Your browser does not support HTML5 canvas.")}))})()})();